{% extends "base.html" %}
{% block title %}Domovra ‚Äî Journal{% endblock %}

{% block head %}{% endblock %}

{% block content %}
<div class="wrap">

    <div class="events-head">
        <h1>Journal</h1>

        <div style="display:flex; gap:8px; align-items:center;">
            <!-- Filtre quantit√© de lignes -->
            <form method="get" action="{{ BASE }}journal" style="display:flex; gap:8px; align-items:center;">
                <label>
                    Afficher
                    <select name="limit">
                        {% for n in [50,100,200,500,1000] %}
                        <option value="{{ n }}" {{ 'selected' if n==limit }}>{{ n }}</option>
                        {% endfor %}
                    </select>
                    lignes
                </label>
                <button type="submit" class="secondary">Actualiser</button>
            </form>

            <!-- Vider le journal -->
            <form method="post" action="{{ BASE }}journal/clear"
                onsubmit="return confirm('Vider TOUT le journal ? Cette action est irr√©versible.');">
                <button type="submit" class="secondary">üóëÔ∏è Vider le journal</button>
            </form>
        </div>
    </div>

    <div id="flash" class="flash">Journal vid√© ‚úÖ</div>

    <p class="muted">Historique des actions (enregistr√© dans la base SQLite). Les heures sont affich√©es en local.</p>

    {% if not events or events|length == 0 %}
    <p class="muted">Aucun √©v√©nement pour le moment.</p>
    {% else %}
    <table class="events-table">
        <thead>
            <tr>
                <th class="nowrap">#</th>
                <th class="nowrap">Date</th>
                <th>Type</th>
                <th>D√©tails</th>
            </tr>
        </thead>
        <tbody>
            {% for ev in events %}
            {% set k = ev.kind|replace('.', '_') %}
            <tr>
                <td class="nowrap">{{ ev.id }}</td>
                <td class="nowrap">
                    <time class="ev-ts" datetime="{{ ev.created_at }}">{{ ev.created_at }}</time>
                </td>
                <td><span class="pill kind-{{ k }}">{{ ev.kind }}</span></td>
                <td class="code">
                    {% set d = ev.details if ev.details is not none else {} %}
                    {% if d is mapping %}
                    <pre class="code">{{ d | tojson(indent=2) }}</pre>
                    {% elif d is string %}
                    <pre class="code">{{ d }}</pre>
                    {% else %}
                    <span class="muted">‚Äî</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
    // Convertit l'ISO UTC en heure locale lisible + flash apr√®s vidage
    document.addEventListener('DOMContentLoaded', () => {
        // Timestamps -> locale
        document.querySelectorAll('time.ev-ts').forEach(t => {
            try {
                const d = new Date(t.getAttribute('datetime'));
                if (!isNaN(d)) t.textContent = d.toLocaleString();
            } catch (e) { }
        });

        // Affiche un flash si ?cleared=1
        const p = new URLSearchParams(location.search);
        if (p.get('cleared') === '1') {
            const f = document.getElementById('flash');
            if (f) { f.style.display = 'block'; f.textContent = 'Journal vid√© ‚úÖ'; }
        }
    });
</script>
{% endblock %}
{% extends "base.html" %}
{% block title %}Domovra — Stocks{% endblock %}

{% block head %}{% endblock %}

{% block header_right %}
<span class="chip">🧺 Stocks : <b>{{ items|length }}</b></span>
{% endblock %}

{% block content %}
<div class="wrap" data-page="lots">
  <!-- Outils -->
  <div class="card">
    <div class="title">
      <h2>Outils</h2><span class="muted">Recherche & filtres</span>
    </div>
    <div class="filters-row">
      <input id="q" class="wide" type="search" placeholder="Rechercher (produit, emplacement, EAN)…">
      <select id="f_loc">
        <option value="">📍 Tous emplacements</option>
        {% for l in locations %}<option value="{{ l.name|lower }}">{{ l.name }}</option>{% endfor %}
      </select>
      <select id="f_status">
        <option value="">⚑ Tous états</option>
        <option value="green">OK</option>
        <option value="yellow">Bientôt</option>
        <option value="red">Urgent</option>
      </select>
      <span class="chip">🧺 Stocks : <b id="lots-count">{{ items|length }}</b></span>
    </div>
  </div>

  <!-- Liste (cartes uniquement) -->
  <div class="card">
    <div class="title">
      <h2>Liste</h2><span class="muted">Cartes (responsive)</span>
    </div>

    <div class="lot-cards" id="cards">
      {% if items %}
      {% for it in items %}
      <div class="lot-card" data-name="{{ it.product|lower }}" data-loc="{{ it.location|lower }}"
        data-barcode="{{ (it.barcode or '')|lower }}" data-status="{{ it.status }}">
        <div class="lc-head">
          <div class="lc-title">
            {{ it.article_name or it.product }}
            {% if it.brand %}<span class="muted"> — {{ it.brand }}</span>{% endif %}
          </div>
          <span class="status {{ it.status }}">
            {{ "OK" if it.status=="green" else ("Bientôt" if it.status=="yellow" else ("Urgent" if it.status=="red" else
            "—")) }}
          </span>
        </div>

        <div class="lc-sub">
          {% set qv = fmt_qty(it.qty, it.unit) %}
          {{ qv.v }} {{ qv.u|pluralize_fr(it.qty) }}
          • 📍 {{ it.location }}
          {% set code = it.ean or it.barcode %}
          {% if code %} • 🏷️ {{ code }}{% endif %}
        </div>

        <details class="dates">
          <summary>📅 Dates</summary>
          <div class="timeline">
            <span class="pill">❄ <span>{{ it.frozen_on or '—' }}</span></span>
            <span class="pill">⏳ <span>{{ it.best_before or '—' }}</span></span>
            {% if it.created_on %}<span class="pill">➕ <span>{{ it.created_on }}</span></span>{% endif %}
          </div>
        </details>

        <div class="lc-actions">
          <button class="secondary js-edit-open" data-id="{{ it.id }}" data-qty="{{ it.qty }}" data-unit="{{ it.unit }}"
            data-location_id="{{ it.location_id }}" data-frozen="{{ it.frozen_on or '' }}"
            data-best_before="{{ it.best_before or '' }}">✏️ Modifier</button>

          <button class="secondary js-delete-open" data-id="{{ it.id }}" data-product="{{ it.product }}">🗑️
            Supprimer</button>
        </div>
      </div>
      {% endfor %}
      {% else %}
      <div class="muted">Aucune entrée de stock.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Dialogs -->
<dialog id="dlg-edit">
  <form method="post" action="{{ BASE }}lot/update" style="display:grid;gap:10px;min-width:min(520px,92vw)">
    <h3 style="margin:0">Modifier le stock</h3>
    <input type="hidden" name="lot_id" id="dlg-lot-id">
    <div class="row" style="gap:10px">
      <div style="flex:1">
        <div class="label">Quantité</div>
        <input type="number" name="qty" id="dlg-qty" step="0.01" min="0" required>
      </div>
      <div style="flex:1">
        <div class="label">Emplacement</div>
        <select name="location_id" id="dlg-location">
          {% for l in locations %}<option value="{{ l.id }}">{{ l.name }}</option>{% endfor %}
        </select>
      </div>
    </div>
    <div class="row" style="gap:10px">
      <div style="flex:1">
        <div class="label">Congelé le</div><input type="date" name="frozen_on" id="dlg-frozen">
      </div>
      <div style="flex:1">
        <div class="label">À consommer avant</div><input type="date" name="best_before" id="dlg-best-before">
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-edit').close()">Annuler</button>
      <button class="secondary">Enregistrer</button>
    </div>
  </form>
</dialog>

<dialog id="dlg-delete">
  <form method="post" action="{{ BASE }}lot/delete" style="display:grid;gap:10px;min-width:min(420px,92vw)">
    <h3 style="margin:0">Supprimer du stock</h3>
    <input type="hidden" name="lot_id" id="del-lot-id">
    <div class="muted" id="del-msg">Supprimer cette entrée de stock ?</div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-delete').close()">Annuler</button>
      <button class="secondary" style="background:var(--danger);border:0;color:#1d0c0c">Supprimer</button>
    </div>
  </form>
</dialog>
{% endblock %}

{% block scripts %}
<script>
  const $ = s => document.querySelector(s);

  /* --- Recherche / filtres (cartes uniquement) --- */
  const q = $('#q'), fLoc = $('#f_loc'), fStatus = $('#f_status');
  const cards = $('#cards');
  const cardsItems = Array.from(cards ? cards.children : []);

  function passesFilters(ds, txt, loc, st) {
    const s = (ds.name + ' ' + (ds.loc || '') + ' ' + (ds.barcode || '')).includes(txt);
    const l = loc ? (ds.loc === loc) : true;
    const t = st ? ((ds.status || '') === st) : true;
    return s && l && t;
  }

  function applyFilter() {
    const txt = (q?.value || '').toLowerCase().trim();
    const loc = (fLoc?.value || '').toLowerCase().trim();
    const st = (fStatus?.value || '').trim();

    let shown = 0;
    cardsItems.forEach(c => {
      const m = passesFilters(c.dataset, txt, loc, st);
      c.style.display = m ? '' : 'none';
      if (m) shown++;
    });

    const lc = document.getElementById('lots-count');
    if (lc) lc.textContent = (txt || loc || st) ? shown : cardsItems.length;
  }
  [q, fLoc, fStatus].forEach(el => el && el.addEventListener('input', applyFilter));

  /* --- Toasts via querystring --- */
  (function () {
    const p = new URLSearchParams(location.search);
    if (p.get('added') === '1') window.showToast('Stock ajouté.', 'ok');
    if (p.get('updated') === '1') window.showToast('Stock mis à jour.', 'ok');
    if (p.get('deleted') === '1') window.showToast('Stock supprimé.', 'warn');
  })();

  /* --- Modales Edit / Delete --- */
  (function () {
    const editDialog = document.getElementById('dlg-edit');
    const delDialog = document.getElementById('dlg-delete');
    const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };

    // Ouvrir "Modifier"
    document.querySelectorAll('.js-edit-open').forEach(btn => {
      btn.addEventListener('click', () => {
        setVal('dlg-lot-id', btn.dataset.id);
        setVal('dlg-qty', btn.dataset.qty);
        setVal('dlg-location', btn.dataset.location_id);
        setVal('dlg-frozen', btn.dataset.frozen || '');
        setVal('dlg-best-before', btn.dataset.best_before || '');
        editDialog?.showModal();
      });
    });

    // Ouvrir "Supprimer"
    document.querySelectorAll('.js-delete-open').forEach(btn => {
      btn.addEventListener('click', () => {
        setVal('del-lot-id', btn.dataset.id);
        const msg = document.getElementById('del-msg');
        if (msg) msg.textContent = btn.dataset.product
          ? `Supprimer "${btn.dataset.product}" du stock ?`
          : 'Supprimer cette entrée de stock ?';
        delDialog?.showModal();
      });
    });

    // Sécurité UX : empêcher ENTER de soumettre la modale delete
    const delForm = delDialog?.querySelector('form');
    delForm?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
    });
  })();
</script>
{% endblock %}
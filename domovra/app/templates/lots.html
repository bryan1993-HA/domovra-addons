{% extends "base.html" %}
{% block title %}Domovra — Stocks{% endblock %}

{% block head %}{% endblock %}

{% block header_right %}
<span class="chip">🧺 Stocks : <b>{{ items|length }}</b></span>
{% endblock %}

{% block content %}
<div class="wrap" data-page="lots">
  <!-- Outils -->
  <a href="{{ BASE }}_debug/lots{% if request.query_params %}?{{ request.query_params.urlencode() }}{% endif %}"
    class="debug-link" aria-label="Ouvrir le JSON debug des lots" title="Debug lots JSON">·</a>
  <div class="card">
    <div class="title">
      <h2>Outils</h2><span class="muted">Recherche & filtres</span>
    </div>

    <div class="filters-row">
      <div class="qwrap wide">
        <input id="q" type="search" placeholder="Rechercher (produit, emplacement, EAN)…">
        <button type="button" class="icon-btn" aria-label="Aide recherche"
          onclick="document.getElementById('q-help')?.showModal()">?</button>
      </div>

      <select id="f_loc">
        <option value="">📍 Tous emplacements</option>
        {% for l in locations %}<option value="{{ l.name|lower }}">{{ l.name }}</option>{% endfor %}
      </select>

      <select id="f_status">
        <option value="">⚑ Tous états</option>
        <option value="green">OK</option>
        <option value="yellow">Bientôt</option>
        <option value="red">Urgent</option>
      </select>

      <span class="chip">🧺 Stocks : <b id="lots-count">{{ items|length }}</b></span>
    </div>
  </div>

  <!-- Grille de cartes (comme /products) -->
  <div class="cards-grid" id="lot-cards">
    {% if items %}
    {% for it in items %}
    <pre style="font-size:12px;max-height:200px;overflow:auto;background:#111;color:#0f0;padding:6px;">
  {{ it | tojson(indent=2) }}
</pre>

    {% set q = fmt_qty(it.qty, it.unit) %}
    {% set code = it.ean or it.barcode %}
    <article class="prod-card" data-name="{{ (it.name or it.article_name or it.product)|lower }}"
      data-loc="{{ it.location|lower }}" data-barcode="{{ (code or '')|lower }}" data-status="{{ it.status }}">

      <!-- En-tête -->
      <div class="pc-head">
        <div class="pc-title">
          <h3 class="pc-name">
            {{ it.name or it.article_name or it.product }}
            {% if it.brand %}<span class="muted"> — {{ it.brand }}</span>{% endif %}
          </h3>

          <span class="status {{ it.status }}">
            {{ "OK" if it.status=="green" else ("Bientôt" if it.status=="yellow" else ("Urgent" if it.status=="red" else
            "—")) }}
          </span>
        </div>
        <div class="pc-sub">
          {{ q.v }} {{ q.u|pluralize_fr(it.qty) }} • 📍 {{ it.location }}
          {% if code %} • 🏷️ {{ code }}{% endif %}
        </div>
      </div>

      <!-- Corps (stats 2 colonnes comme /products) -->
      <div class="pc-body">
        <div class="stat">
          <span class="k">Quantité totale</span>
          <span class="v">{{ q.v }} {{ q.u|pluralize_fr(it.qty) }}</span>
        </div>
        <div class="stat">
          <span class="k">Emplacement</span>
          <span class="v">{{ it.location }}</span>
        </div>

        <div class="stat full">
          <span class="k">Dates</span>
          <details class="dates">
            <summary>📅 Voir les dates</summary>
            <div class="timeline">
              <span class="pill">❄ <span>{{ it.frozen_on or '—' }}</span></span>
              <span class="pill">⏳ <span>{{ it.best_before or '—' }}</span></span>
              {% if it.created_on %}<span class="pill">➕ <span>{{ it.created_on }}</span></span>{% endif %}
            </div>
          </details>
        </div>
      </div>

      <!-- Actions (mêmes boutons que /products) -->
      <div class="pc-actions">
        <button class="secondary js-edit-open" data-id="{{ it.id }}" data-qty="{{ it.qty }}" data-unit="{{ it.unit }}"
          data-location_id="{{ it.location_id }}" data-frozen="{{ it.frozen_on or '' }}"
          data-best_before="{{ it.best_before or '' }}">
          ✏️ Modifier
        </button>

        <button class="secondary js-delete-open" data-id="{{ it.id }}"
          data-product="{{ it.name or it.article_name or it.product }}">
          🗑️ Supprimer
        </button>

      </div>
    </article>
    {% endfor %}
    {% else %}
    <div class="muted">Aucune entrée de stock.</div>
    {% endif %}
  </div>
</div>

<!-- Aide rapide recherche -->
<dialog id="q-help">
  <div class="qhelp">
    <header>
      <strong>Astuce recherche</strong>
      <button class="icon-btn" onclick="this.closest('dialog')?.close()">✕</button>
    </header>
    <ul class="help-list">
      <li>Tape le nom du produit, un emplacement ou un EAN.</li>
      <li>Combine avec les filtres “Emplacements” et “États”.</li>
    </ul>
  </div>
</dialog>

<!-- Dialogs -->
<dialog id="dlg-edit" class="modal">
  <form method="post" action="{{ BASE }}lot/update" class="edit-form">
    <h3 class="dlg-title">Modifier le stock</h3>
    <input type="hidden" name="lot_id" id="dlg-lot-id">

    <div class="row">
      <div class="field">
        <div class="label">Quantité</div>
        <input type="number" name="qty" id="dlg-qty" step="0.01" min="0" required>
      </div>
      <div class="field">
        <div class="label">Emplacement</div>
        <select name="location_id" id="dlg-location">
          {% for l in locations %}<option value="{{ l.id }}">{{ l.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="field">
        <div class="label">Congelé le</div>
        <input type="date" name="frozen_on" id="dlg-frozen">
      </div>
      <div class="field">
        <div class="label">À consommer avant</div>
        <input type="date" name="best_before" id="dlg-best-before">
      </div>
    </div>

    <div class="dlg-actions">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlg-edit').close()">Annuler</button>
      <button class="btn-save secondary">Enregistrer</button>
    </div>
  </form>
</dialog>

<dialog id="dlg-delete" class="modal">
  <form method="post" action="{{ BASE }}lot/delete" class="edit-form">
    <h3 class="dlg-title">Supprimer du stock</h3>
    <input type="hidden" name="lot_id" id="del-lot-id">
    <div class="muted" id="del-msg">Supprimer cette entrée de stock ?</div>
    <div class="dlg-actions">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlg-delete').close()">Annuler</button>
      <button class="btn-save secondary" style="background:var(--danger);border:0;color:#1d0c0c">Supprimer</button>
    </div>
  </form>
</dialog>
{% endblock %}

{% block scripts %}
<script>
  const $ = s => document.querySelector(s);

  /* --- Recherche / filtres --- */
  const q = $('#q'),
    fLoc = $('#f_loc'),
    fStatus = $('#f_status'),
    cards = Array.from(document.querySelectorAll('#lot-cards .prod-card')),
    countEl = document.getElementById('lots-count');

  function matches(ds, txt, loc, st) {
    const s = (ds.name + ' ' + (ds.loc || '') + ' ' + (ds.barcode || '')).includes(txt);
    const l = loc ? (ds.loc === loc) : true;
    const t = st ? ((ds.status || '') === st) : true;
    return s && l && t;
  }

  function applyFilter() {
    const txt = (q?.value || '').toLowerCase().trim();
    const loc = (fLoc?.value || '').toLowerCase().trim();
    const st = (fStatus?.value || '').trim();
    let shown = 0;
    cards.forEach(card => {
      const m = matches(card.dataset, txt, loc, st);
      card.style.display = m ? '' : 'none';
      if (m) shown++;
    });
    if (countEl) countEl.textContent = (txt || loc || st) ? shown : cards.length;
  }
  [q, fLoc, fStatus].forEach(el => el && el.addEventListener('input', applyFilter));

  /* --- Toasts via querystring --- */
  (function () {
    const p = new URLSearchParams(location.search);
    if (p.get('added') === '1') window.showToast?.('Stock ajouté.', 'ok');
    if (p.get('updated') === '1') window.showToast?.('Stock mis à jour.', 'ok');
    if (p.get('deleted') === '1') window.showToast?.('Stock supprimé.', 'warn');
  })();

  /* --- Modales Edit / Delete --- */
  (function () {
    const editDialog = document.getElementById('dlg-edit');
    const delDialog = document.getElementById('dlg-delete');
    const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };

    document.querySelectorAll('.js-edit-open').forEach(btn => {
      btn.addEventListener('click', () => {
        setVal('dlg-lot-id', btn.dataset.id);
        setVal('dlg-qty', btn.dataset.qty);
        setVal('dlg-location', btn.dataset.location_id);
        setVal('dlg-frozen', btn.dataset.frozen || '');
        setVal('dlg-best-before', btn.dataset.best_before || '');
        editDialog?.showModal();
      });
    });

    document.querySelectorAll('.js-delete-open').forEach(btn => {
      btn.addEventListener('click', () => {
        setVal('del-lot-id', btn.dataset.id);
        const msg = document.getElementById('del-msg');
        msg && (msg.textContent = btn.dataset.product ? `Supprimer "${btn.dataset.product}" du stock ?` : 'Supprimer cette entrée de stock ?');
        delDialog?.showModal();
      });
    });

    // sécurité : ENTER ne soumet pas la modale delete par mégarde
    delDialog?.querySelector('form')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
    });
  })();
</script>
{% endblock %}
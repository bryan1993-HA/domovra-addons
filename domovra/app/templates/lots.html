{% set q = fmt_qty(it.qty, it.unit) %}
{% set code = it.ean or it.barcode %}

{# ==== calculs achat ==== #}
{% set m = (it.multiplier or 1) | int %}
{% set qty_unit = it.qty_per_unit or 0 %}
{% set u_buy = (it.unit_at_purchase or '') %}
{% set price_total = it.price_total %}
{% set per_unit = (price_total / m) if (price_total is not none and m > 0) else none %}

{# prix/kg·L si poids/volume #}
{% set u_map = (u_buy | lower) %}
{% set total_base = none %}
{% set price_per_base = none %}
{% if price_total is not none and qty_unit and m %}
{% if u_map in ['g','kg'] %}
{% set total_kg = (qty_unit/1000.0) if u_map=='g' else qty_unit %}
{% set total_kg = total_kg * m %}
{% if total_kg > 0 %}
{% set total_base = total_kg %}
{% set price_per_base = price_total / total_kg %}
{% endif %}
{% elif u_map in ['ml','l'] %}
{% set total_l = (qty_unit/1000.0) if u_map=='ml' else qty_unit %}
{% set total_l = total_l * m %}
{% if total_l > 0 %}
{% set total_base = total_l %}
{% set price_per_base = price_total / total_l %}
{% endif %}
{% endif %}
{% endif %}

<article class="prod-card" data-name="{{ (it.name or it.article_name or it.product)|lower }}"
  data-loc="{{ it.location|lower }}" data-barcode="{{ (code or '')|lower }}" data-status="{{ it.status }}">

  <!-- En-tête -->
  <div class="pc-head">
    <div class="pc-title">
      <h3 class="pc-name">
        {{ it.name or it.article_name or it.product }}
        {% if it.brand %}<span class="muted"> — {{ it.brand }}</span>{% endif %}
      </h3>

      <span class="status {{ it.status }}">
        {{ "OK" if it.status=="green" else ("Bientôt" if it.status=="yellow" else ("Urgent" if it.status=="red" else
        "—")) }}
      </span>
    </div>

    <div class="pc-sub">
      {{ q.v }} {{ q.u|pluralize_fr(it.qty) }} • 📍 {{ it.location }}
      {% if code %} • 🏷️ {{ code }}{% endif %}
      {% if it.store %} • 🛍️ {{ it.store }}{% endif %}
    </div>
  </div>

  <!-- Corps -->
  <div class="pc-body">
    <!-- Stats principales -->
    <div class="stat">
      <span class="k">Quantité totale</span>
      <span class="v">{{ q.v }} {{ q.u|pluralize_fr(it.qty) }}</span>
    </div>

    <div class="stat">
      <span class="k">Emplacement</span>
      <span class="v">{{ it.location }}</span>
    </div>

    <!-- Bloc Dates (identique, juste re‑libellé) -->
    <div class="stat full">
      <span class="k">Dates</span>
      <details class="dates">
        <summary>📅 Voir les dates</summary>
        <div class="timeline">
          <span class="pill">❄ <span>{{ it.frozen_on or '—' }}</span></span>
          <span class="pill">⏳ <span>{{ it.best_before or '—' }}</span></span>
          {% if it.created_on %}<span class="pill">➕ <span>{{ it.created_on }}</span></span>{% endif %}
        </div>
      </details>
    </div>

    <!-- Bloc Achat (nouveau, même grille .stat/.full) -->
    <div class="stat">
      <span class="k">Prix payé</span>
      <span class="v">
        {% if price_total is not none %}{{ '%.2f'|format(price_total) }} €{% else %}—{% endif %}
      </span>
    </div>

    <div class="stat">
      <span class="k">Prix / unité</span>
      <span class="v">
        {% if per_unit is not none %}{{ '%.2f'|format(per_unit) }} €{% else %}—{% endif %}
      </span>
    </div>

    <div class="stat">
      <span class="k">Conditionnement</span>
      <span class="v">
        {% if qty_unit and u_buy %}
        {{ qty_unit|float }} {{ u_buy }} × {{ m }}
        {% elif m > 1 %}
        Pack × {{ m }}
        {% else %}
        —
        {% endif %}
      </span>
    </div>

    <div class="stat">
      <span class="k">Prix / kg·L</span>
      <span class="v">
        {% if price_per_base is not none %}
        {{ '%.2f'|format(price_per_base) }} €/{{ 'kg' if u_map in ['g','kg'] else 'L' }}
        {% else %}
        —
        {% endif %}
      </span>
    </div>

    <div class="stat full">
      <span class="k">Détails article</span>
      <div class="v">
        <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
          {% if it.article_name %}<span class="pill">🏷️ {{ it.article_name }}</span>{% endif %}
          {% if it.brand %}<span class="pill">🏭 {{ it.brand }}</span>{% endif %}
          {% if it.ean %}<span class="pill">📌 EAN {{ it.ean }}</span>{% endif %}
          {% if u_buy %}<span class="pill">⚖️ {{ qty_unit or '—' }} {{ u_buy }} × {{ m }}</span>{% endif %}
          {% if it.store %}<span class="pill">🛍️ {{ it.store }}</span>{% endif %}
        </div>
        {% if it.note %}
        <div class="muted" style="margin-top:.35rem;">📝 {{ it.note }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="pc-actions">
    <button class="secondary js-edit-open" data-id="{{ it.id }}" data-qty="{{ it.qty }}" data-unit="{{ it.unit }}"
      data-location_id="{{ it.location_id }}" data-frozen="{{ it.frozen_on or '' }}"
      data-best_before="{{ it.best_before or '' }}">
      ✏️ Modifier
    </button>

    <button class="secondary js-delete-open" data-id="{{ it.id }}"
      data-product="{{ it.name or it.article_name or it.product }}">
      🗑️ Supprimer
    </button>
  </div>
</article>
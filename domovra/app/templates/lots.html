{% extends "base.html" %}
{% block title %}Domovra â€” Stocks{% endblock %}

{% block head %}{% endblock %}

{% block header_right %}
<span class="chip">ğŸ§º Stocks : <b>{{ items|length }}</b></span>
{% endblock %}

{% block content %}
<div class="wrap" data-page="lots">
  <!-- Outils -->
  <a href="{{ BASE }}_debug/lots{% if request.query_params %}?{{ request.query_params.urlencode() }}{% endif %}"
    class="debug-link" aria-label="Ouvrir le JSON debug des lots" title="Debug lots JSON">Â·</a>

  <div class="card">
    <div class="title">
      <h2>Outils</h2><span class="muted">Recherche & filtres</span>
    </div>

    <div class="filters-row">
      <div class="qwrap wide">
        <input id="q" type="search" placeholder="Rechercher (produit, emplacement, EAN)â€¦">
        <button type="button" class="icon-btn" aria-label="Aide recherche"
          onclick="document.getElementById('q-help')?.showModal()">?</button>
      </div>

      <select id="f_loc">
        <option value="">ğŸ“ Tous emplacements</option>
        {% for l in locations %}<option value="{{ l.name|lower }}">{{ l.name }}</option>{% endfor %}
      </select>

      <select id="f_status">
        <option value="">âš‘ Tous Ã©tats</option>
        <option value="green">OK</option>
        <option value="yellow">BientÃ´t</option>
        <option value="red">Urgent</option>
      </select>

      <span class="chip">ğŸ§º Stocks : <b id="lots-count">{{ items|length }}</b></span>
    </div>
  </div>

  <!-- Grille de cartes -->
  <div class="cards-grid" id="lot-cards">
    {% if items %}
    {% for it in items %}
    {# ---- DEBUG JSON (facultatif) ----
    <pre style="font-size:12px;max-height:200px;overflow:auto;background:#111;color:#0f0;padding:6px;">
{{ it | tojson(indent=2) }}
        </pre>
    #}

    {# ==== Calculs par lot (Ã  l'intÃ©rieur de la boucle) ==== #}
    {% set q = fmt_qty(it.qty, it.unit) %}
    {% set code = it.ean or it.barcode %}
    {% set m = (it.multiplier or 1) | int %}
    {% set qty_unit = it.qty_per_unit or 0 %}
    {% set u_buy = (it.unit_at_purchase or '') %}
    {% set price_total = it.price_total %}
    {% set per_unit = (price_total / m) if (price_total is not none and m > 0) else none %}

    {# prix/kgÂ·L si poids/volume #}
    {% set u_map = (u_buy | lower) %}
    {% set price_per_base = none %}
    {% if price_total is not none and qty_unit and m %}
    {% if u_map in ['g','kg'] %}
    {% set total_kg = ((qty_unit/1000.0) if u_map=='g' else qty_unit) * m %}
    {% if total_kg > 0 %}{% set price_per_base = price_total / total_kg %}{% endif %}
    {% elif u_map in ['ml','l'] %}
    {% set total_l = ((qty_unit/1000.0) if u_map=='ml' else qty_unit) * m %}
    {% if total_l > 0 %}{% set price_per_base = price_total / total_l %}{% endif %}
    {% endif %}
    {% endif %}

    <article class="prod-card" data-name="{{ (it.name or it.article_name or it.product)|lower }}"
      data-loc="{{ it.location|lower }}" data-barcode="{{ (code or '')|lower }}" data-status="{{ it.status }}">

      <!-- En-tÃªte -->
      <div class="pc-head">
        <div class="pc-title">
          <h3 class="pc-name">
            {{ it.name or it.article_name or it.product }}
            {% if it.brand %}<span class="muted"> â€” {{ it.brand }}</span>{% endif %}
          </h3>

          <span class="status {{ it.status }}">
            {{ "OK" if it.status=="green" else ("BientÃ´t" if it.status=="yellow" else ("Urgent" if it.status=="red" else
            "â€”")) }}
          </span>
        </div>

        <div class="pc-sub">
          {{ q.v }} {{ q.u|pluralize_fr(it.qty) }} â€¢ ğŸ“ {{ it.location }}
          {% if code %} â€¢ ğŸ·ï¸ {{ code }}{% endif %}
          {% if it.store %} â€¢ ğŸ›ï¸ {{ it.store }}{% endif %}
        </div>
      </div>

      <!-- Corps -->
      <div class="pc-body">
        <div class="stat">
          <span class="k">QuantitÃ© totale</span>
          <span class="v">{{ q.v }} {{ q.u|pluralize_fr(it.qty) }}</span>
        </div>

        <div class="stat">
          <span class="k">Emplacement</span>
          <span class="v">{{ it.location }}</span>
        </div>

        <div class="stat full">
          <span class="k">Dates</span>
          <details class="dates">
            <summary>ğŸ“… Voir les dates</summary>
            <div class="timeline">
              <span class="pill">â„ <span>{{ it.frozen_on or 'â€”' }}</span></span>
              <span class="pill">â³ <span>{{ it.best_before or 'â€”' }}</span></span>
              {% if it.created_on %}<span class="pill">â• <span>{{ it.created_on }}</span></span>{% endif %}
            </div>
          </details>
        </div>

        <!-- === Bloc Achat (nouveau) === -->
        <div class="stat">
          <span class="k">Prix payÃ©</span>
          <span class="v">
            {% if price_total is not none %}{{ '%.2f'|format(price_total) }} â‚¬{% else %}â€”{% endif %}
          </span>
        </div>

        <div class="stat">
          <span class="k">Prix / unitÃ©</span>
          <span class="v">
            {% if per_unit is not none %}{{ '%.2f'|format(per_unit) }} â‚¬{% else %}â€”{% endif %}
          </span>
        </div>

        <div class="stat">
          <span class="k">Conditionnement</span>
          <span class="v">
            {% if qty_unit and u_buy %}
            {{ qty_unit|float }} {{ u_buy }} Ã— {{ m }}
            {% elif m > 1 %}
            Pack Ã— {{ m }}
            {% else %}
            â€”
            {% endif %}
          </span>
        </div>

        <div class="stat">
          <span class="k">Prix / kgÂ·L</span>
          <span class="v">
            {% if price_per_base is not none %}
            {{ '%.2f'|format(price_per_base) }} â‚¬/{{ 'kg' if u_map in ['g','kg'] else 'L' }}
            {% else %}
            â€”
            {% endif %}
          </span>
        </div>

        <div class="stat full">
          <span class="k">DÃ©tails article</span>
          <div class="v">
            <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
              {% if it.article_name %}<span class="pill">ğŸ·ï¸ {{ it.article_name }}</span>{% endif %}
              {% if it.brand %}<span class="pill">ğŸ­ {{ it.brand }}</span>{% endif %}
              {% if it.ean %}<span class="pill">ğŸ“Œ EAN {{ it.ean }}</span>{% endif %}
              {% if u_buy %}<span class="pill">âš–ï¸ {{ qty_unit or 'â€”' }} {{ u_buy }} Ã— {{ m }}</span>{% endif %}
              {% if it.store %}<span class="pill">ğŸ›ï¸ {{ it.store }}</span>{% endif %}
            </div>
            {% if it.note %}
            <div class="muted" style="margin-top:.35rem;">ğŸ“ {{ it.note }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="pc-actions">
        <button class="secondary js-edit-open" data-id="{{ it.id }}" data-qty="{{ it.qty }}" data-unit="{{ it.unit }}"
          data-location_id="{{ it.location_id }}" data-frozen="{{ it.frozen_on or '' }}"
          data-best_before="{{ it.best_before or '' }}">
          âœï¸ Modifier
        </button>

        <button class="secondary js-delete-open" data-id="{{ it.id }}"
          data-product="{{ it.name or it.article_name or it.product }}">
          ğŸ—‘ï¸ Supprimer
        </button>
      </div>
    </article>
    {% endfor %}
    {% else %}
    <div class="muted">Aucune entrÃ©e de stock.</div>
    {% endif %}
  </div>
</div>

<!-- Aide rapide recherche -->
<dialog id="q-help">
  <div class="qhelp">
    <header>
      <strong>Astuce recherche</strong>
      <button class="icon-btn" onclick="this.closest('dialog')?.close()">âœ•</button>
    </header>
    <ul class="help-list">
      <li>Tape le nom du produit, un emplacement ou un EAN.</li>
      <li>Combine avec les filtres â€œEmplacementsâ€ et â€œÃ‰tatsâ€.</li>
    </ul>
  </div>
</dialog>

<!-- Dialogs -->
<dialog id="dlg-edit" class="modal">
  <form method="post" action="{{ BASE }}lot/update" class="edit-form">
    <h3 class="dlg-title">Modifier le stock</h3>
    <input type="hidden" name="lot_id" id="dlg-lot-id">

    <div class="row">
      <div class="field">
        <div class="label">QuantitÃ©</div>
        <input type="number" name="qty" id="dlg-qty" step="0.01" min="0" required>
      </div>
      <div class="field">
        <div class="label">Emplacement</div>
        <select name="location_id" id="dlg-location">
          {% for l in locations %}<option value="{{ l.id }}">{{ l.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="field">
        <div class="label">CongelÃ© le</div>
        <input type="date" name="frozen_on" id="dlg-frozen">
      </div>
      <div class="field">
        <div class="label">Ã€ consommer avant</div>
        <input type="date" name="best_before" id="dlg-best-before">
      </div>
    </div>

    <div class="dlg-actions">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlg-edit').close()">Annuler</button>
      <button class="btn-save secondary">Enregistrer</button>
    </div>
  </form>
</dialog>

<dialog id="dlg-delete" class="modal">
  <form method="post" action="{{ BASE }}lot/delete" class="edit-form">
    <h3 class="dlg-title">Supprimer du stock</h3>
    <input type="hidden" name="lot_id" id="del-lot-id">
    <div class="muted" id="del-msg">Supprimer cette entrÃ©e de stock ?</div>
    <div class="dlg-actions">
      <button type="button" class="btn-cancel" onclick="document.getElementById('dlg-delete').close()">Annuler</button>
      <button class="btn-save secondary" style="background:var(--danger);border:0;color:#1d0c0c">Supprimer</button>
    </div>
  </form>
</dialog>
{% endblock %}

{% block scripts %}
<script>
  const $ = s => document.querySelector(s);

  /* --- Recherche / filtres --- */
  const q = $('#q'),
    fLoc = $('#f_loc'),
    fStatus = $('#f_status'),
    cards = Array.from(document.querySelectorAll('#lot-cards .prod-card')),
    countEl = document.getElementById('lots-count');

  function matches(ds, txt, loc, st) {
    const s = (ds.name + ' ' + (ds.loc || '') + ' ' + (ds.barcode || '')).includes(txt);
    const l = loc ? (ds.loc === loc) : true;
    const t = st ? ((ds.status || '') === st) : true;
    return s && l && t;
  }

  function applyFilter() {
    const txt = (q?.value || '').toLowerCase().trim();
    const loc = (fLoc?.value || '').toLowerCase().trim();
    const st = (fStatus?.value || '').trim();
    let shown = 0;
    cards.forEach(card => {
      const m = matches(card.dataset, txt, loc, st);
      card.style.display = m ? '' : 'none';
      if (m) shown++;
    });
    if (countEl) countEl.textContent = (txt || loc || st) ? shown : cards.length;
  }
  [q, fLoc, fStatus].forEach(el => el && el.addEventListener('input', applyFilter));

  /* --- Toasts via querystring --- */
  (function () {
    const p = new URLSearchParams(location.search);
    if (p.get('added') === '1') window.showToast?.('Stock ajoutÃ©.', 'ok');
    if (p.get('updated') === '1') window.showToast?.('Stock mis Ã  jour.', 'ok');
    if (p.get('deleted') === '1') window.showToast?.('Stock supprimÃ©.', 'warn');
  })();

  /* --- Modales Edit / Delete --- */
  (function () {
    const editDialog = document.getElementById('dlg-edit');
    const delDialog = document.getElementById('dlg-delete');
    const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };

    document.querySelectorAll('.js-edit-open').forEach(btn => {
      btn.addEventListener('click', () => {
        setVal('dlg-lot-id', btn.dataset.id);
        setVal('dlg-qty', btn.dataset.qty);
        setVal('dlg-location', btn.dataset.location_id);
        setVal('dlg-frozen', btn.dataset.frozen || '');
        setVal('dlg-best-before', btn.dataset.best_before || '');
        editDialog?.showModal();
      });
    });

    document.querySelectorAll('.js-delete-open').forEach(btn => {
      btn.addEventListener('click', () => {
        setVal('del-lot-id', btn.dataset.id);
        const msg = document.getElementById('del-msg');
        msg && (msg.textContent = btn.dataset.product ? `Supprimer "${btn.dataset.product}" du stock ?` : 'Supprimer cette entrÃ©e de stock ?');
        delDialog?.showModal();
      });
    });

    // sÃ©curitÃ© : ENTER ne soumet pas la modale delete par mÃ©garde
    delDialog?.querySelector('form')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
    });
  })();
</script>
{% endblock %}
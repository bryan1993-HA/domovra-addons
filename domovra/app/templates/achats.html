{% extends "base.html" %}
{% block title %}Domovra ‚Äî Achats{% endblock %}
{% block head %}
<style>
    .scan-modal {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, .65);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .scan-modal.hidden {
        display: none;
    }

    .scan-box {
        position: relative;
        width: min(92vw, 700px);
        aspect-ratio: 3/4;
        background: #000;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .4);
    }

    #scan_video,
    #scan_overlay {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .scan-hud {
        position: absolute;
        right: .75rem;
        top: .75rem;
        display: flex;
        gap: .5rem;
        z-index: 3
    }

    .scan-tip {
        position: absolute;
        left: 0;
        right: 0;
        bottom: .5rem;
        text-align: center;
        color: #fff;
        font-weight: 600;
        text-shadow: 0 1px 2px #000;
        z-index: 3
    }

    .scan-frame {
        position: absolute;
        inset: 12% 8%;
        border: 3px solid rgba(255, 255, 255, .8);
        border-radius: 12px;
        box-shadow: 0 0 0 200vmax rgba(0, 0, 0, .35);
        z-index: 2;
    }

    .scan-frame::after {
        content: "";
        position: absolute;
        left: 10%;
        right: 10%;
        top: 50%;
        height: 2px;
        background: rgba(0, 255, 128, .9);
        box-shadow: 0 0 12px rgba(0, 255, 128, .9);
        transform: translateY(-1px);
        animation: scanline 2.1s linear infinite;
    }

    @keyframes scanline {
        0% {
            top: 18%
        }

        100% {
            top: 82%
        }
    }
</style>
{% endblock %}

{% block header_right %}
<span class="chip">üõí Achats</span>
{% endblock %}


{% block content %}
<div class="wrap" data-page="achats">

    <div class="card">
        <!-- Titre + bouton Scan √† droite -->
        <div class="title" style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <div>
                <h2>Ajouter au stock</h2>
                <span class="muted">‚Üí page d√©di√©e aux entr√©es (scan ou saisie)</span>
            </div>
            <button type="button" class="btn" id="btn_scan" title="Scanner un code-barres">üì∑</button>
            <button type="button" class="btn" id="btn_scan_live" title="Scanner en direct">üé•</button>

        </div>

        <form id="achats_form" method="post" action="{{ BASE }}achats/add" class="form-grid">

            <!-- EAN -->
            <div>
                <div class="label">Code‚Äëbarres (EAN)</div>
                <div class="infield">
                    <input type="text" name="ean" id="ean" placeholder="Scanner ou saisir" inputmode="numeric"
                        autocomplete="off">
                    <button type="button" class="btn" id="btn_check_ean"
                        title="Rechercher le produit par EAN">üîé</button>
                    <button type="button" class="btn" id="btn_create_prod" title="Cr√©er le produit"
                        style="white-space:nowrap;">‚ûï</button>
                </div>
                <div class="hint" id="ean_hint"></div>
            </div>

            <!-- Produit (s√©lection si d√©j√† existant) -->
            <div>
                <div class="label">Produit</div>
                <select name="product_id" id="product_select" required>
                    <option value="" disabled selected>‚Äî Choisir ou scanner ‚Äî</option>
                    {% for p in products %}
                    <option value="{{ p.id }}" data-barcode="{{ p.barcode or '' }}" data-unit="{{ p.unit or 'pi√®ce' }}"
                        data-pack="" {# pack_of si tu l‚Äôajoutes plus tard #}>
                        {{ p.name }}{% if p.brand %} ‚Äî {{ p.brand }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <div class="hint" id="product_hint"></div>
            </div>

            <!-- Nom sugg√©r√© (si produit inconnu via OFF) -->
            <div>
                <div class="label">Nom (sugg√©r√© par OFF)</div>
                <input type="text" id="name_suggest" placeholder="Rempli apr√®s scan si produit inconnu"
                    autocomplete="off">
                <div class="hint" id="off_qty_hint"></div>
            </div>

            <!-- Quantit√© + unit√© + raccourcis -->
            <div>
                <div class="label">Quantit√©</div>
                <div class="infield">
                    <input type="number" step="0.001" min="0.001" name="qty" id="qty" value="1" required>
                    <select name="unit" id="unit" style="max-width:140px">
                        <option value="pi√®ce">pi√®ce</option>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="l">l</option>
                    </select>
                    <button type="button" class="btn" id="btn_plus1">+1</button>
                    <button type="button" class="btn" id="btn_pack" hidden>+1 pack</button>
                </div>
                <div class="hint" id="qty_hint"></div>
            </div>

            <!-- Emplacement -->
            <div>
                <div class="label">Emplacement</div>
                <select name="location_id" id="location_id" required>
                    {% for loc in locations %}
                    <option value="{{ loc.id }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Dates -->
            <div>
                <div class="label">DLC (optionnel)</div>
                <input type="date" name="best_before" id="best_before">
            </div>

            <div>
                <div class="label">Date de cong√©lation (optionnel)</div>
                <input type="date" name="frozen_on" id="frozen_on">
            </div>

            <!-- Note -->
            <div style="grid-column:1/-1">
                <div class="label">Note (optionnel)</div>
                <textarea name="note" rows="2"
                    placeholder="Infos compl√©mentaires (lot fournisseur, promo, etc.)"></textarea>
            </div>

            <!-- Actions -->
            <div style="grid-column:1/-1; display:flex; gap:.5rem; justify-content:flex-end">
                <button type="reset" class="btn ghost">R√©initialiser</button>
                <button type="submit" class="btn primary">Ajouter</button>
            </div>
            <!-- Aper√ßu vid√©o pour le scan en direct -->
            <div id="live_scanner" style="grid-column:1/-1; display:none;">
                <video id="video_preview" playsinline autoplay muted
                    style="width:100%; max-height:280px; border-radius:12px; background:#000;"></video>
                <div class="hint" id="live_hint">Pointe un code‚Äëbarres vers la cam√©ra‚Ä¶</div>
                <div style="margin-top:.5rem; display:flex; gap:.5rem;">
                    <button type="button" class="btn" id="btn_live_stop">Arr√™ter</button>
                    <button type="button" class="btn ghost" id="btn_live_flip">Changer de cam√©ra</button>
                </div>
            </div>

            <!-- MODALE SCAN -->
            <div id="scan_modal" class="scan-modal hidden" aria-hidden="true">
                <div class="scan-box">
                    <video id="scan_video" playsinline autoplay muted></video>
                    <canvas id="scan_overlay"></canvas>

                    <!-- HUD -->
                    <div class="scan-hud">
                        <button type="button" class="btn ghost" id="scan_flip" title="Changer de cam√©ra">üîÅ</button>
                        <button type="button" class="btn" id="scan_close" title="Fermer">‚úñ</button>
                    </div>

                    <!-- Tip -->
                    <div class="scan-tip">Alignez le code-barres dans le cadre</div>

                    <!-- Cadre de guidage (statique) -->
                    <div class="scan-frame"></div>
                </div>
            </div>


        </form>
        <!-- DEBUG PANEL (cach√© par d√©faut, activ√© via JS) -->
        <div id="dbg_panel" style="display:none; margin-top:1rem;">
            <div class="card" style="background:var(--bg-soft,#1f2937); color:var(--fg,#e5e7eb);">
                <div class="title">
                    <h3>Debug scan</h3>
                </div>
                <pre id="dbg_log"
                    style="white-space:pre-wrap; max-height:220px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<!-- ZXing (d√©j√† ok) -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script>
    (function () {
        // ---------- utils ----------
        const $ = (s, p = document) => p.querySelector(s);
        const toast = (m, t = 'ok') => window.showToast?.(m, t);

        // Champs/form
        const elEAN = $('#ean');

        // Boutons
        const btnLive = $('#btn_scan_live');
        const btnPhoto = $('#btn_scan'); // reste inchang√©, si tu l'utilises

        // Modale : on supporte *les deux* conventions d‚ÄôID
        const modal = $('#scan-modal') || $('#scan_modal');
        const video = $('#scan-video') || $('#scan_video');
        const btnClose = $('#scan-close') || $('#scan_close');

        // √âvite qu‚Äôun mauvais ID casse tout
        function openModal() {
            if (!modal) return;
            if (modal.nodeName.toLowerCase() === 'dialog') {
                modal.showModal();
            } else {
                modal.classList.remove('hidden'); modal.setAttribute('aria-hidden', 'false');
            }
        }
        function closeModal() {
            if (!modal) return;
            if (modal.nodeName.toLowerCase() === 'dialog') {
                try { modal.close(); } catch { }
            } else {
                modal.classList.add('hidden'); modal.setAttribute('aria-hidden', 'true');
            }
        }

        // √âtat cam√©ra
        let stream = null;
        let zxingReader = null;
        let liveActive = false;

        function stopStream() {
            liveActive = false;
            try { zxingReader?.reset?.(); } catch { }
            if (stream) try { stream.getTracks().forEach(t => t.stop()); } catch { }
            stream = null;
        }

        async function onDetected(code) {
            if (!code) return;
            stopStream(); closeModal();
            elEAN && (elEAN.value = ('' + code).replace(/\D+/g, ''));
            toast('Code d√©tect√© : ' + code, 'ok');
            if (typeof lookupByEAN === 'function') lookupByEAN(code);
        }

        // ---------- Live: BarcodeDetector -> fallback ZXing ----------
        async function startLiveScan() {
            if (!video) { toast("√âl√©ment <video> introuvable dans la modale.", "error"); return; }

            // Attributs iOS
            video.setAttribute('playsinline', ''); video.setAttribute('webkit-playsinline', '');
            video.muted = true;

            // Contraintes: arri√®re si possible + un peu de r√©solution
            const constraints = {
                audio: false,
                video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
            };

            // 1) try BarcodeDetector (si https & support)
            if (window.isSecureContext && 'BarcodeDetector' in window) {
                try {
                    const det = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e'] });
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream; try { await video.play(); } catch { }
                    liveActive = true;

                    const tick = async () => {
                        if (!liveActive) return;
                        try {
                            const res = await det.detect(video);
                            if (res && res[0] && res[0].rawValue) return onDetected(res[0].rawValue);
                        } catch { }
                        requestAnimationFrame(tick);
                    };
                    tick();
                    return; // on reste dans ce mode si tout va bien
                } catch (e) {
                    // pass ‚Üí on tentera ZXing juste apr√®s
                }
            }

            // 2) fallback ZXing
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream; try { await video.play(); } catch { }
            } catch (e) {
                toast("Cam√©ra indisponible (permissions/domain). Essaie le mode photo.", "warn");
                stopStream(); closeModal();
                return;
            }

            try {
                if (!zxingReader) zxingReader = new ZXing.BrowserMultiFormatReader(hintsForEAN());
                // optionnel: acc√©l√®re un peu les tentatives
                zxingReader.timeBetweenDecodingAttempts = 150;

                liveActive = true;
                await zxingReader.decodeFromVideoDevice(null, video, (result, err) => {
                    if (!liveActive) return;
                    if (result && (result.text || result.getText)) {
                        const code = result.text || result.getText();
                        if (code) onDetected(code);
                    }
                });
            } catch (e) {
                toast("D√©codage live indisponible ici. Essaie le mode photo.", "warn");
                stopStream(); closeModal();
            }
        }

        // Hints pour ZXing (meilleure d√©tection EAN/UPC)
        function hintsForEAN() {
            const H = ZXing.DecodeHintType, F = ZXing.BarcodeFormat;
            const hints = new Map();
            hints.set(H.POSSIBLE_FORMATS, [F.EAN_13, F.EAN_8, F.UPC_A, F.UPC_E]);
            hints.set(H.TRY_HARDER, true);
            hints.set(H.ASSUME_GS1, true);
            return hints;
        }

        // ---------- Handlers ----------
        btnLive?.addEventListener('click', async () => {
            if (!navigator.mediaDevices?.getUserMedia) { toast('getUserMedia indisponible.', 'warn'); return; }
            openModal();
            await startLiveScan();
        });

        btnClose?.addEventListener('click', () => { stopStream(); closeModal(); });
        // fermeture si clic sur le fond (pour la version <div>)
        modal?.addEventListener('click', (e) => {
            const box = e.target.closest('.scan-box');
            if (!box) { stopStream(); closeModal(); }
        });

        // (facultatif) bouton üì∑ d√©j√† en place chez toi ‚Äî pas modifi√© ici
        // Tu conserves ton handler photo existant si tu le souhaites.

    })();
</script>
{% endblock %}
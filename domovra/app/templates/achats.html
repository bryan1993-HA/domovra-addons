{% extends "base.html" %}
{% block title %}Domovra â€” Achats{% endblock %}
{% block head %}{% endblock %}

{% block header_right %}
<span class="chip">ðŸ›’ Achats</span>
{% endblock %}

{% block content %}
<div class="wrap" data-page="achats">

    <div class="card">
        <!-- Titre + bouton Scan Ã  droite -->
        <div class="title" style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <div>
                <h2>Ajouter au stock</h2>
                <span class="muted">â†’ page dÃ©diÃ©e aux entrÃ©es (scan ou saisie)</span>
            </div>
            <button type="button" class="btn" id="btn_scan" title="Scanner un code-barres">ðŸ“·</button>
            <button type="button" class="btn" id="btn_scan_live" title="Scanner en direct">ðŸŽ¥</button>

        </div>

        <form id="achats_form" method="post" action="{{ BASE }}achats/add" class="form-grid">

            <!-- EAN -->
            <div>
                <div class="label">Codeâ€‘barres (EAN)</div>
                <div class="infield">
                    <input type="text" name="ean" id="ean" placeholder="Scanner ou saisir" inputmode="numeric"
                        autocomplete="off">
                    <button type="button" class="btn" id="btn_check_ean"
                        title="Rechercher le produit par EAN">ðŸ”Ž</button>
                    <button type="button" class="btn" id="btn_create_prod" title="CrÃ©er le produit"
                        style="white-space:nowrap;">âž•</button>
                </div>
                <div class="hint" id="ean_hint"></div>
            </div>

            <!-- Produit (sÃ©lection si dÃ©jÃ  existant) -->
            <div>
                <div class="label">Produit</div>
                <select name="product_id" id="product_select" required>
                    <option value="" disabled selected>â€” Choisir ou scanner â€”</option>
                    {% for p in products %}
                    <option value="{{ p.id }}" data-barcode="{{ p.barcode or '' }}" data-unit="{{ p.unit or 'piÃ¨ce' }}"
                        data-pack="" {# pack_of si tu lâ€™ajoutes plus tard #}>
                        {{ p.name }}{% if p.brand %} â€” {{ p.brand }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <div class="hint" id="product_hint"></div>
            </div>

            <!-- Nom suggÃ©rÃ© (si produit inconnu via OFF) -->
            <div>
                <div class="label">Nom (suggÃ©rÃ© par OFF)</div>
                <input type="text" id="name_suggest" placeholder="Rempli aprÃ¨s scan si produit inconnu"
                    autocomplete="off">
                <div class="hint" id="off_qty_hint"></div>
            </div>

            <!-- QuantitÃ© + unitÃ© + raccourcis -->
            <div>
                <div class="label">QuantitÃ©</div>
                <div class="infield">
                    <input type="number" step="0.001" min="0.001" name="qty" id="qty" value="1" required>
                    <select name="unit" id="unit" style="max-width:140px">
                        <option value="piÃ¨ce">piÃ¨ce</option>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="l">l</option>
                    </select>
                    <button type="button" class="btn" id="btn_plus1">+1</button>
                    <button type="button" class="btn" id="btn_pack" hidden>+1 pack</button>
                </div>
                <div class="hint" id="qty_hint"></div>
            </div>

            <!-- Emplacement -->
            <div>
                <div class="label">Emplacement</div>
                <select name="location_id" id="location_id" required>
                    {% for loc in locations %}
                    <option value="{{ loc.id }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Dates -->
            <div>
                <div class="label">DLC (optionnel)</div>
                <input type="date" name="best_before" id="best_before">
            </div>

            <div>
                <div class="label">Date de congÃ©lation (optionnel)</div>
                <input type="date" name="frozen_on" id="frozen_on">
            </div>

            <!-- Note -->
            <div style="grid-column:1/-1">
                <div class="label">Note (optionnel)</div>
                <textarea name="note" rows="2"
                    placeholder="Infos complÃ©mentaires (lot fournisseur, promo, etc.)"></textarea>
            </div>

            <!-- Actions -->
            <div style="grid-column:1/-1; display:flex; gap:.5rem; justify-content:flex-end">
                <button type="reset" class="btn ghost">RÃ©initialiser</button>
                <button type="submit" class="btn primary">Ajouter</button>
            </div>
            <!-- AperÃ§u vidÃ©o pour le scan en direct -->
            <div id="live_scanner" style="grid-column:1/-1; display:none;">
                <video id="video_preview" playsinline autoplay muted
                    style="width:100%; max-height:280px; border-radius:12px; background:#000;"></video>
                <div class="hint" id="live_hint">Pointe un codeâ€‘barres vers la camÃ©raâ€¦</div>
                <div style="margin-top:.5rem; display:flex; gap:.5rem;">
                    <button type="button" class="btn" id="btn_live_stop">ArrÃªter</button>
                    <button type="button" class="btn ghost" id="btn_live_flip">Changer de camÃ©ra</button>
                </div>
            </div>

        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script>
    (function () {
        const $ = (s, p = document) => p.querySelector(s);
        const toast = (m, t = 'ok') => window.showToast?.(m, t);
        const setText = (el, txt) => { if (el) el.textContent = txt || ''; };

        // Champs
        const eanInput = $('#ean'), eanHint = $('#ean_hint');
        const nameSuggest = $('#name_suggest'), offQtyHint = $('#off_qty_hint');
        const productSelect = $('#product_select'), productHint = $('#product_hint');
        const qtyInput = $('#qty'), unitSel = $('#unit'), btnPlus1 = $('#btn_plus1'), btnPack = $('#btn_pack');

        // VidÃ©o
        const liveBox = $('#live_scanner');
        const videoEl = $('#video_preview');
        const btnLive = $('#btn_scan_live');
        const btnLiveStop = $('#btn_live_stop');
        const btnLiveFlip = $('#btn_live_flip');
        let currentStream = null;
        let currentDeviceId = null;
        let zxingReader = null;
        let liveRunning = false;

        function applyProductDefaults(opt) {
            if (!opt) { btnPack.hidden = true; setText(productHint, ''); setText(offQtyHint, ''); return; }
            const unit = opt.dataset.unit || 'piÃ¨ce';
            const pack = parseFloat(opt.dataset.pack || '0');
            unitSel.value = Array.from(unitSel.options).some(o => o.value === unit) ? unit : 'piÃ¨ce';
            if (pack && pack > 1 && unitSel.value === 'piÃ¨ce') {
                btnPack.hidden = false; setText(offQtyHint, `Pack de ${pack} ${pack > 1 ? 'unitÃ©s' : ''}`);
                btnPack.onclick = () => { const cur = +qtyInput.value || 0; qtyInput.value = String(cur + pack); };
            } else { btnPack.hidden = true; setText(offQtyHint, ''); }
            const bc = opt.dataset.barcode || ''; setText(productHint, bc ? `EAN: ${bc}` : '');
        }
        productSelect.addEventListener('change', () => applyProductDefaults(productSelect.selectedOptions[0]));
        btnPlus1?.addEventListener('click', () => { const cur = +qtyInput.value || 0; qtyInput.value = String(cur + 1); });

        async function lookupByEAN(ean) {
            const code = (ean || '').trim().replace(/\s+/g, ''); if (!code) { toast('EAN vide.', 'warn'); return; }
            eanInput.value = code;

            // 1) Domovra
            try {
                const r = await fetch(`{{ BASE }}api/product/by_barcode?code=${encodeURIComponent(code)}`);
                if (r.ok) {
                    const p = await r.json();
                    const opt = Array.from(productSelect.options).find(o => (o.dataset.barcode || '').replace(/\s+/g, '') === code);
                    productSelect.value = opt ? opt.value : String(p.id);
                    productSelect.dispatchEvent(new Event('change'));
                    setText(eanHint, `Produit trouvÃ© : ${p.name}`);
                    if (!qtyInput.value) qtyInput.value = '1';
                    toast('Produit sÃ©lectionnÃ© depuis le stock.', 'ok');
                    return;
                }
            } catch { }

            // 2) OFF
            try {
                const r = await fetch(`{{ BASE }}api/off?barcode=${encodeURIComponent(code)}`);
                const data = await r.json();
                if (data && data.ok) {
                    setText(eanHint, "Produit non connu dans Domovra (OFF consultÃ©).");
                    nameSuggest.value = data.name || '';
                    setText(offQtyHint, data.quantity ? `QuantitÃ© OFF : ${data.quantity}` : '');
                    if (!qtyInput.value || qtyInput.value === '0') qtyInput.value = '1';
                    toast(`OFF â†’ ${data.name || 'Nom inconnu'}`, 'warn');
                } else {
                    setText(eanHint, "Ni Domovra ni OFF nâ€™ont trouvÃ© ce code.");
                    nameSuggest.value = ''; setText(offQtyHint, ''); toast("Aucun rÃ©sultat pour cet EAN.", "warn");
                }
            } catch {
                setText(eanHint, "Erreur OFF."); toast("Erreur lors de la rÃ©cupÃ©ration OFF.", "error");
            }
        }

        // Recherche EAN
        $('#btn_check_ean')?.addEventListener('click', () => lookupByEAN(eanInput.value));
        eanInput?.addEventListener('keydown', ev => {
            if (ev.key === 'Enter') { ev.preventDefault(); lookupByEAN(eanInput.value); }
        });

        // ---- SCAN PHOTO (OK HTTP/HTTPS)
        $('#btn_scan')?.addEventListener('click', async () => {
            const CAN_SECURE = window.isSecureContext === true;
            const HAS_DET = 'BarcodeDetector' in window;
            // 1) BarcodeDetector sur photo (si dispo)
            if (CAN_SECURE && HAS_DET) {
                try {
                    const file = await pickImageFromCamera(); if (!file) return;
                    const bmp = await createImageBitmap(file);
                    const det = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_e', 'upc_a'] });
                    const found = await det.detect(bmp);
                    if (found?.length) { const code = found[0].rawValue; eanInput.value = code; lookupByEAN(code); return; }
                } catch { }
            }
            // 2) Fallback ZXing sur photo
            try {
                const file = await pickImageFromCamera(); if (!file) return;
                const code = await decodeImageWithZXing(file);
                if (code) { eanInput.value = code; lookupByEAN(code); }
                else toast('Aucun codeâ€‘barres dÃ©tectÃ© sur la photo.', 'warn');
            } catch { toast('Scan indisponible. Utilisez une douchette ou saisissez lâ€™EAN.', 'warn'); }
        });

        // ---- SCAN VIDÃ‰O (HTTPS + autorisation + iframe)
        btnLive?.addEventListener('click', async () => {
            if (liveRunning) return;
            try {
                // Choisir la camÃ©ra arriÃ¨re si possible
                const constraints = { video: currentDeviceId ? { deviceId: { exact: currentDeviceId } } : { facingMode: 'environment' }, audio: false };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                videoEl.srcObject = stream;
                liveBox.style.display = 'block';
                liveRunning = true;

                // ZXing live
                if (!zxingReader) zxingReader = new ZXing.BrowserMultiFormatReader();
                const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
                if (!currentDeviceId && devices?.length) {
                    // essaie de trouver "back" dans le label
                    const back = devices.find(d => /back|rear|environment/i.test(d.label));
                    currentDeviceId = (back || devices[0]).deviceId;
                }
                // DÃ©marre le dÃ©codage en continu
                startZXingContinuous();
                setText($('#live_hint'), 'Pointe un codeâ€‘barres vers la camÃ©raâ€¦');
            } catch (err) {
                // Messages utiles selon le cas
                if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
                    toast("AccÃ¨s camÃ©ra refusÃ© par le navigateur. Autorise la camÃ©ra pour *.ui.nabu.casa.", "error");
                } else if (err && err.name === 'NotFoundError') {
                    toast("Aucune camÃ©ra dÃ©tectÃ©e sur cet appareil.", "error");
                } else {
                    // Cas typique Ingress: lâ€™iframe parent nâ€™autorise pas camera (Permissions-Policy)
                    toast("CamÃ©ra indisponible dans cette vue (Ingress). Utilise le bouton ðŸ“· (photo) ou une douchette.", "warn");
                }
                stopLive();
            }
        });

        btnLiveStop?.addEventListener('click', stopLive);

        btnLiveFlip?.addEventListener('click', async () => {
            try {
                const devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
                if (devices?.length) {
                    const idx = devices.findIndex(d => d.deviceId === currentDeviceId);
                    const next = devices[(idx + 1) % devices.length];
                    currentDeviceId = next.deviceId;
                    await restartLive();
                }
            } catch { }
        });

        async function startZXingContinuous() {
            if (!zxingReader) return;
            try {
                await zxingReader.decodeFromVideoDevice(currentDeviceId || null, videoEl, (result, err) => {
                    if (result && liveRunning) {
                        const code = result.text;
                        eanInput.value = code;
                        toast('Code dÃ©tectÃ© : ' + code, 'ok');
                        // On arrÃªte dÃ¨s la 1re dÃ©tection
                        stopLive();
                        lookupByEAN(code);
                    }
                });
            } catch (e) {
                // Si Ã§a Ã©choue, on affiche un message mais on laisse la vidÃ©o
                setText($('#live_hint'), 'Impossible de dÃ©coder en continu. Essaie le mode ðŸ“· (photo).');
            }
        }

        async function restartLive() {
            stopLive(false);
            btnLive.click();
        }

        function stopLive(hide = true) {
            liveRunning = false;
            try { zxingReader?.reset(); } catch { }
            if (currentStream) {
                for (const tr of currentStream.getTracks()) tr.stop();
            }
            currentStream = null;
            if (hide) liveBox.style.display = 'none';
        }

        // --- Helpers photo
        function pickImageFromCamera() {
            return new Promise(resolve => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.setAttribute('capture', 'environment');
                input.onchange = () => resolve(input.files?.[0] || null);
                input.click();
            });
        }

        async function decodeImageWithZXing(file) {
            return new Promise((resolve) => {
                const fr = new FileReader();
                fr.onload = () => {
                    const img = new Image();
                    img.onload = async () => {
                        try {
                            const reader = new ZXing.BrowserMultiFormatReader();
                            const res = await reader.decodeFromImage(img);
                            resolve(res?.text || null);
                        } catch { resolve(null); }
                    };
                    img.onerror = () => resolve(null);
                    img.src = fr.result;
                };
                fr.onerror = () => resolve(null);
                fr.readAsDataURL(file);
            });
        }

        // CrÃ©er produit
        $('#btn_create_prod')?.addEventListener('click', () => {
            const ean = (eanInput.value || '').trim();
            const next = encodeURIComponent("{{ BASE }}achats");
            const url = `{{ BASE }}products?ean=${encodeURIComponent(ean)}&next=${next}`;
            window.location.href = url;
        });

        // Toast post-ajout
        if (new URLSearchParams(location.search).has('added')) {
            toast("Ajout enregistrÃ© dans le stock.", "ok");
            history.replaceState({}, "", location.pathname);
        }
    })();
</script>
{% endblock %}
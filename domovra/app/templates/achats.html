{% extends "base.html" %}
{% block title %}Domovra ‚Äî Achats{% endblock %}
{% block head %}
<style>
    .scan-modal {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, .65);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .scan-modal.hidden {
        display: none;
    }

    .scan-box {
        position: relative;
        width: min(92vw, 700px);
        aspect-ratio: 3/4;
        background: #000;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .4);
    }

    #scan_video,
    #scan_overlay {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .scan-hud {
        position: absolute;
        right: .75rem;
        top: .75rem;
        display: flex;
        gap: .5rem;
        z-index: 3
    }

    .scan-tip {
        position: absolute;
        left: 0;
        right: 0;
        bottom: .5rem;
        text-align: center;
        color: #fff;
        font-weight: 600;
        text-shadow: 0 1px 2px #000;
        z-index: 3
    }

    .scan-frame {
        position: absolute;
        inset: 12% 8%;
        border: 3px solid rgba(255, 255, 255, .8);
        border-radius: 12px;
        box-shadow: 0 0 0 200vmax rgba(0, 0, 0, .35);
        z-index: 2;
    }

    .scan-frame::after {
        content: "";
        position: absolute;
        left: 10%;
        right: 10%;
        top: 50%;
        height: 2px;
        background: rgba(0, 255, 128, .9);
        box-shadow: 0 0 12px rgba(0, 255, 128, .9);
        transform: translateY(-1px);
        animation: scanline 2.1s linear infinite;
    }

    @keyframes scanline {
        0% {
            top: 18%
        }

        100% {
            top: 82%
        }
    }
</style>
{% endblock %}

{% block header_right %}
<span class="chip">üõí Achats</span>
{% endblock %}


{% block content %}
<div class="wrap" data-page="achats">

    <div class="card">
        <!-- Titre + bouton Scan √† droite -->
        <div class="title" style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <div>
                <h2>Ajouter au stock</h2>
                <span class="muted">‚Üí page d√©di√©e aux entr√©es (scan ou saisie)</span>
            </div>
            <button type="button" class="btn" id="btn_scan" title="Scanner un code-barres">üì∑</button>
            <button type="button" class="btn" id="btn_scan_live" title="Scanner en direct">üé•</button>

        </div>

        <form id="achats_form" method="post" action="{{ BASE }}achats/add" class="form-grid">

            <!-- EAN -->
            <div>
                <div class="label">Code‚Äëbarres (EAN)</div>
                <div class="infield">
                    <input type="text" name="ean" id="ean" placeholder="Scanner ou saisir" inputmode="numeric"
                        autocomplete="off">
                    <button type="button" class="btn" id="btn_check_ean"
                        title="Rechercher le produit par EAN">üîé</button>
                    <button type="button" class="btn" id="btn_create_prod" title="Cr√©er le produit"
                        style="white-space:nowrap;">‚ûï</button>
                </div>
                <div class="hint" id="ean_hint"></div>
            </div>

            <!-- Produit (s√©lection si d√©j√† existant) -->
            <div>
                <div class="label">Produit</div>
                <select name="product_id" id="product_select" required>
                    <option value="" disabled selected>‚Äî Choisir ou scanner ‚Äî</option>
                    {% for p in products %}
                    <option value="{{ p.id }}" data-barcode="{{ p.barcode or '' }}" data-unit="{{ p.unit or 'pi√®ce' }}"
                        data-pack="" {# pack_of si tu l‚Äôajoutes plus tard #}>
                        {{ p.name }}{% if p.brand %} ‚Äî {{ p.brand }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <div class="hint" id="product_hint"></div>
            </div>

            <!-- Nom sugg√©r√© (si produit inconnu via OFF) -->
            <div>
                <div class="label">Nom (sugg√©r√© par OFF)</div>
                <input type="text" id="name_suggest" placeholder="Rempli apr√®s scan si produit inconnu"
                    autocomplete="off">
                <div class="hint" id="off_qty_hint"></div>
            </div>

            <!-- Quantit√© + unit√© + raccourcis -->
            <div>
                <div class="label">Quantit√©</div>
                <div class="infield">
                    <input type="number" step="0.001" min="0.001" name="qty" id="qty" value="1" required>
                    <select name="unit" id="unit" style="max-width:140px">
                        <option value="pi√®ce">pi√®ce</option>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="l">l</option>
                    </select>
                    <button type="button" class="btn" id="btn_plus1">+1</button>
                    <button type="button" class="btn" id="btn_pack" hidden>+1 pack</button>
                </div>
                <div class="hint" id="qty_hint"></div>
            </div>

            <!-- Emplacement -->
            <div>
                <div class="label">Emplacement</div>
                <select name="location_id" id="location_id" required>
                    {% for loc in locations %}
                    <option value="{{ loc.id }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Dates -->
            <div>
                <div class="label">DLC (optionnel)</div>
                <input type="date" name="best_before" id="best_before">
            </div>

            <div>
                <div class="label">Date de cong√©lation (optionnel)</div>
                <input type="date" name="frozen_on" id="frozen_on">
            </div>

            <!-- Note -->
            <div style="grid-column:1/-1">
                <div class="label">Note (optionnel)</div>
                <textarea name="note" rows="2"
                    placeholder="Infos compl√©mentaires (lot fournisseur, promo, etc.)"></textarea>
            </div>

            <!-- Actions -->
            <div style="grid-column:1/-1; display:flex; gap:.5rem; justify-content:flex-end">
                <button type="reset" class="btn ghost">R√©initialiser</button>
                <button type="submit" class="btn primary">Ajouter</button>
            </div>
            <!-- Aper√ßu vid√©o pour le scan en direct -->
            <div id="live_scanner" style="grid-column:1/-1; display:none;">
                <video id="video_preview" playsinline autoplay muted
                    style="width:100%; max-height:280px; border-radius:12px; background:#000;"></video>
                <div class="hint" id="live_hint">Pointe un code‚Äëbarres vers la cam√©ra‚Ä¶</div>
                <div style="margin-top:.5rem; display:flex; gap:.5rem;">
                    <button type="button" class="btn" id="btn_live_stop">Arr√™ter</button>
                    <button type="button" class="btn ghost" id="btn_live_flip">Changer de cam√©ra</button>
                </div>
            </div>

            <!-- MODALE SCAN -->
            <div id="scan_modal" class="scan-modal hidden" aria-hidden="true">
                <div class="scan-box">
                    <video id="scan_video" playsinline autoplay muted></video>
                    <canvas id="scan_overlay"></canvas>

                    <!-- HUD -->
                    <div class="scan-hud">
                        <button type="button" class="btn ghost" id="scan_flip" title="Changer de cam√©ra">üîÅ</button>
                        <button type="button" class="btn" id="scan_close" title="Fermer">‚úñ</button>
                    </div>

                    <!-- Tip -->
                    <div class="scan-tip">Alignez le code-barres dans le cadre</div>

                    <!-- Cadre de guidage (statique) -->
                    <div class="scan-frame"></div>
                </div>
            </div>


        </form>
        <!-- DEBUG PANEL (cach√© par d√©faut, activ√© via JS) -->
        <div id="dbg_panel" style="display:none; margin-top:1rem;">
            <div class="card" style="background:var(--bg-soft,#1f2937); color:var(--fg,#e5e7eb);">
                <div class="title">
                    <h3>Debug scan</h3>
                </div>
                <pre id="dbg_log"
                    style="white-space:pre-wrap; max-height:220px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<!-- ZXing -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>

<script>
    (() => {
        // ====== DEBUG ======
        const DEBUG = true;
        const dbgPanel = document.getElementById('dbg_panel');
        const dbgLogEl = document.getElementById('dbg_log');
        function log(...args) {
            if (!DEBUG) return;
            const msg = args.map(x => (typeof x === 'object' ? JSON.stringify(x) : String(x))).join(' ');
            if (dbgLogEl) {
                dbgPanel.style.display = 'block';
                const ts = new Date().toISOString().substring(11, 19);
                dbgLogEl.textContent += `[${ts}] ${msg}\n`;
                dbgLogEl.scrollTop = dbgLogEl.scrollHeight;
            }
            console?.log?.('[ACHATS]', ...args);
        }
        function toast(msg, type = 'ok') { window.showToast?.(msg, type); log('TOAST', type, msg); }

        // ====== Raccourcis DOM ======
        const $ = (s, p = document) => p.querySelector(s);

        // Champs du formulaire
        const eanInput = $('#ean');
        const eanHint = $('#ean_hint');
        const nameSuggest = $('#name_suggest');
        const offQtyHint = $('#off_qty_hint');

        const productSelect = $('#product_select');
        const productHint = $('#product_hint');

        const qtyInput = $('#qty');
        const unitSel = $('#unit');
        const btnPlus1 = $('#btn_plus1');
        const btnPack = $('#btn_pack');

        // Boutons scan
        const btnPhoto = $('#btn_scan');
        const btnLive = $('#btn_scan_live');

        // Modale (live)
        const modal = $('#scan_modal');
        const vEl = $('#scan_video');
        const overlay = $('#scan_overlay');
        const octx = overlay?.getContext('2d');
        const btnFlip = $('#scan_flip');
        const btnClose = $('#scan_close');

        // ====== √âtat cam√©ra / ZXing ======
        let currentStream = null;
        let currentDeviceId = null;
        let reader = null;         // ZXing.BrowserMultiFormatReader
        let liveRunning = false;
        let torchOn = false;

        // ZXing hints: limiter aux codes 1D courants + TRY_HARDER
        function makeReader() {
            const H = ZXing.DecodeHintType;
            const F = ZXing.BarcodeFormat;
            const hints = new Map();
            hints.set(H.POSSIBLE_FORMATS, [F.EAN_13, F.EAN_8, F.UPC_A, F.UPC_E, F.CODE_128, F.CODE_39]);
            hints.set(H.TRY_HARDER, true);
            return new ZXing.BrowserMultiFormatReader(hints);
        }

        // ====== Helpers UI ======
        function setHint(el, text) { if (el) el.textContent = text || ''; }

        function applyProductDefaults(opt) {
            if (!opt) { if (btnPack) btnPack.hidden = true; setHint(productHint, ''); setHint(offQtyHint, ''); return; }
            const unit = opt.dataset.unit || 'pi√®ce';
            const pack = parseFloat(opt.dataset.pack || '0');
            unitSel.value = Array.from(unitSel.options).some(o => o.value === unit) ? unit : 'pi√®ce';
            if (btnPack) {
                if (pack && pack > 1 && unitSel.value === 'pi√®ce') {
                    btnPack.hidden = false;
                    setHint(offQtyHint, `Pack de ${pack} ${pack > 1 ? 'unit√©s' : ''}`);
                    btnPack.onclick = () => { const cur = +qtyInput.value || 0; qtyInput.value = String(cur + pack); };
                } else { btnPack.hidden = true; setHint(offQtyHint, ''); }
            }
            const bc = opt.dataset.barcode || '';
            setHint(productHint, bc ? `EAN: ${bc}` : '');
        }
        productSelect?.addEventListener('change', () => applyProductDefaults(productSelect.selectedOptions[0]));
        btnPlus1?.addEventListener('click', () => { const cur = +qtyInput.value || 0; qtyInput.value = String(cur + 1); });

        // ====== Lookup EAN (DB locale -> OFF) ======
        async function lookupByEAN(ean) {
            const code = (ean || '').trim().replace(/\s+/g, '');
            if (!code) { toast('EAN vide.', 'warn'); return; }
            eanInput.value = code;
            try {
                const r = await fetch(`{{ BASE }}api/product/by_barcode?code=${encodeURIComponent(code)}`);
                if (r.ok) {
                    const p = await r.json();
                    const opt = Array.from(productSelect.options).find(o => (o.dataset.barcode || '').replace(/\s+/g, '') === code);
                    productSelect.value = opt ? opt.value : String(p.id);
                    productSelect.dispatchEvent(new Event('change'));
                    setHint(eanHint, `Produit trouv√© : ${p.name}`);
                    if (!qtyInput.value) qtyInput.value = '1';
                    toast('Produit s√©lectionn√© depuis le stock.', 'ok');
                    return;
                }
            } catch (e) { log('by_barcode error', String(e)); }
            try {
                const r = await fetch(`{{ BASE }}api/off?barcode=${encodeURIComponent(code)}`);
                const data = await r.json();
                if (data?.ok) {
                    setHint(eanHint, "Produit non connu dans Domovra (OFF consult√©).");
                    nameSuggest.value = data.name || '';
                    setHint(offQtyHint, data.quantity ? `Quantit√© OFF : ${data.quantity}` : '');
                    if (!qtyInput.value || qtyInput.value === '0') qtyInput.value = '1';
                    toast(`OFF ‚Üí ${data.name || 'Nom inconnu'}`, 'warn');
                } else {
                    setHint(eanHint, "Ni Domovra ni OFF n‚Äôont trouv√© ce code.");
                    nameSuggest.value = ''; setHint(offQtyHint, ''); toast("Aucun r√©sultat pour cet EAN.", "warn");
                }
            } catch (e) {
                setHint(eanHint, "Erreur OFF."); toast("Erreur lors de la r√©cup√©ration OFF.", "error");
                log('OFF fetch error', String(e));
            }
        }
        $('#btn_check_ean')?.addEventListener('click', () => lookupByEAN(eanInput.value));
        eanInput?.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); lookupByEAN(eanInput.value); } });

        // ====== Mode PHOTO (marche en HTTP/HTTPS) ======
        function pickImageFromCamera() {
            return new Promise(resolve => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.setAttribute('capture', 'environment'); // hint pour mobile
                const ua = navigator.userAgent || '';
                if (/iPad|iPhone|iPod/.test(ua)) {
                    input.accept = 'image/*;capture=camera';
                    input.setAttribute('capture', 'camera');
                }
                let triedAlt = false;
                input.onchange = () => resolve(input.files?.[0] || null);
                input.addEventListener('click', () => {
                    setTimeout(() => {
                        if (!input.files?.length && !triedAlt && /Android/.test(ua)) {
                            triedAlt = true;
                            const alt = document.createElement('input');
                            alt.type = 'file'; alt.accept = 'image/*'; alt.setAttribute('capture', 'camera');
                            alt.onchange = () => resolve(alt.files?.[0] || null);
                            alt.click();
                        }
                    }, 700);
                });
                input.click();
            });
        }

        async function decodeImageWithZXing(file) {
            return new Promise((resolve) => {
                const fr = new FileReader();
                fr.onload = () => {
                    const img = new Image();
                    img.onload = async () => {
                        try {
                            if (!reader) reader = makeReader();
                            const res = await reader.decodeFromImage(img);
                            resolve(res?.text || null);
                        } catch (e) { resolve(null); }
                    };
                    img.onerror = () => resolve(null);
                    img.src = fr.result;
                };
                fr.onerror = () => resolve(null);
                fr.readAsDataURL(file);
            });
        }

        btnPhoto?.addEventListener('click', async () => {
            // 1) BarcodeDetector (si dispo et contexte s√©curis√©)
            if (window.isSecureContext && 'BarcodeDetector' in window) {
                try {
                    const file = await pickImageFromCamera(); if (!file) return;
                    const bmp = await createImageBitmap(file);
                    const det = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_e', 'upc_a', 'code_128', 'code_39'] });
                    const found = await det.detect(bmp);
                    if (found?.length) {
                        const code = found[0].rawValue;
                        eanInput.value = code;
                        toast('Code d√©tect√© : ' + code, 'ok');
                        lookupByEAN(code);
                        return;
                    }
                } catch (e) { log('BarcodeDetector photo error', String(e)); }
            }
            // 2) Fallback ZXing
            try {
                const file = await pickImageFromCamera(); if (!file) return;
                const code = await decodeImageWithZXing(file);
                if (code) {
                    eanInput.value = code;
                    toast('Code d√©tect√© : ' + code, 'ok');
                    lookupByEAN(code);
                } else {
                    toast('Aucun code‚Äëbarres d√©tect√© sur la photo.', 'warn');
                }
            } catch (e) {
                toast('Scan indisponible. Utilisez une douchette ou saisissez l‚ÄôEAN.', 'warn');
            }
        });

        // ====== Live VIDEO (cam√©ra arri√®re, haute r√©solution, autofocus, lampe) ======
        async function getVideoInputs() {
            if (!navigator.mediaDevices?.enumerateDevices) return [];
            const all = await navigator.mediaDevices.enumerateDevices();
            return all.filter(d => d.kind === 'videoinput');
        }

        function fitOverlayToVideo() {
            if (!overlay || !vEl) return;
            const r = vEl.getBoundingClientRect();
            overlay.width = r.width * devicePixelRatio;
            overlay.height = r.height * devicePixelRatio;
        }
        function clearOverlay() { if (octx) { octx.clearRect(0, 0, overlay.width, overlay.height); } }
        function drawGuide() {
            if (!octx) return;
            clearOverlay();
            const w = overlay.width, h = overlay.height;
            const rectW = w * 0.7, rectH = h * 0.18;
            const x = (w - rectW) / 2, y = (h - rectH) / 2;
            octx.lineWidth = 3 * devicePixelRatio;
            octx.strokeStyle = 'rgba(255,255,255,0.85)';
            octx.strokeRect(x, y, rectW, rectH);
            // scanline
            octx.fillStyle = 'rgba(0,255,128,0.9)';
            const t = (Date.now() / 7) % rectH;
            octx.fillRect(x + rectW * 0.08, y + t, rectW * 0.84, 2 * devicePixelRatio);
        }

        async function applyTrackTuning(track) {
            if (!track?.applyConstraints) return;
            const caps = track.getCapabilities?.() || {};
            const cons = {};
            // focus continu si dispo
            if (caps.focusMode && caps.focusMode.includes('continuous')) cons.focusMode = 'continuous';
            // zoom (d√©marrage l√©ger)
            if (typeof caps.zoom === 'number' || (caps.zoom && caps.zoom.max)) {
                const z = caps.zoom.max ? Math.min(2, caps.zoom.max) : caps.zoom; // petit zoom
                if (z) cons.zoom = z;
            }
            // torch (on laisse off par d√©faut)
            if ('torch' in caps) cons.torch = torchOn;
            if (Object.keys(cons).length) {
                try { await track.applyConstraints({ advanced: [cons] }); } catch { }
            }
        }

        async function setTorch(on) {
            try {
                const track = currentStream?.getVideoTracks?.()[0];
                if (!track) return false;
                const caps = track.getCapabilities?.() || {};
                if (!('torch' in caps)) return false;
                await track.applyConstraints({ advanced: [{ torch: !!on }] });
                torchOn = !!on;
                return true;
            } catch (e) { return false; }
        }

        // Bouton lampe ajout√© dans l'HUD si absent
        let torchBtn = document.getElementById('scan_torch');
        if (!torchBtn) {
            torchBtn = document.createElement('button');
            torchBtn.type = 'button';
            torchBtn.id = 'scan_torch';
            torchBtn.className = 'btn ghost';
            torchBtn.title = 'Lampe';
            torchBtn.textContent = 'üî¶';
            const hud = modal?.querySelector('.scan-hud');
            hud?.insertBefore(torchBtn, btnClose || null);
        }
        torchBtn?.addEventListener('click', async () => {
            const ok = await setTorch(!torchOn);
            if (!ok) toast("Lampe non disponible sur cet appareil.", "warn");
        });

        async function startLive() {
            // Contraintes vid√©o "muscl√©es" pour aider le d√©codage
            const constraints = {
                audio: false,
                video: currentDeviceId
                    ? { deviceId: { exact: currentDeviceId } }
                    : {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1920 },   // haute r√©solution
                        height: { ideal: 1080 },
                    }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            currentStream = stream;
            vEl.srcObject = stream;

            // Choisir explicitement la cam√©ra arri√®re si list√©e
            const vids = await getVideoInputs();
            if (!currentDeviceId && vids.length) {
                const back = vids.find(d => /back|rear|environment|arri√®re/i.test(d.label));
                currentDeviceId = (back || vids[0]).deviceId;
            }
            // Tuning autofocus / zoom / torch
            await applyTrackTuning(stream.getVideoTracks()[0]);

            // ZXing reader
            if (!reader) reader = makeReader();
            liveRunning = true;

            // guide visuel
            fitOverlayToVideo();
            const anim = () => {
                if (!liveRunning) return;
                drawGuide();
                requestAnimationFrame(anim);
            };
            requestAnimationFrame(anim);

            // D√©codage continu
            await reader.decodeFromVideoDevice(currentDeviceId || null, vEl, (result, err) => {
                if (result && liveRunning) {
                    liveRunning = false;
                    try { reader?.reset(); } catch { }
                    try { for (const t of (currentStream?.getTracks?.() || [])) t.stop(); } catch { }
                    currentStream = null;

                    const code = result.text;
                    eanInput.value = code;
                    toast('Code d√©tect√© : ' + code, 'ok');

                    // ferme la modale proprement
                    modal?.classList.add('hidden');
                    modal?.setAttribute('aria-hidden', 'true');

                    lookupByEAN(code);
                }
            });
        }

        function stopLive() {
            liveRunning = false;
            try { reader?.reset(); } catch { }
            try { for (const t of (currentStream?.getTracks?.() || [])) t.stop(); } catch { }
            currentStream = null;
            clearOverlay();
        }

        // Ouvrir / fermer la modale
        function openModal() {
            modal?.classList.remove('hidden');
            modal?.setAttribute('aria-hidden', 'false');
        }
        function closeModal() {
            modal?.classList.add('hidden');
            modal?.setAttribute('aria-hidden', 'true');
            stopLive();
        }

        // Handlers
        btnLive?.addEventListener('click', async () => {
            if (!navigator.mediaDevices?.getUserMedia) {
                toast("getUserMedia indisponible.", "warn"); return;
            }
            openModal();
            try {
                await startLive();
            } catch (err) {
                log('live error', err?.name, err?.message);
                toast("Cam√©ra live indisponible ici. Essaie üì∑ (photo) ou une douchette.", "warn");
                closeModal();
            }
        });
        btnClose?.addEventListener('click', closeModal);
        modal?.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        btnFlip?.addEventListener('click', async () => {
            const devs = await getVideoInputs();
            if (!devs.length) return toast("Aucune autre cam√©ra d√©tect√©e.", "warn");
            const idx = devs.findIndex(d => d.deviceId === currentDeviceId);
            currentDeviceId = devs[(idx + 1 + devs.length) % devs.length].deviceId;
            stopLive();
            openModal();
            try { await startLive(); } catch { closeModal(); }
        });

        // Cr√©ation produit via bouton
        $('#btn_create_prod')?.addEventListener('click', () => {
            const ean = (eanInput.value || '').trim();
            const next = encodeURIComponent("{{ BASE }}achats");
            const url = `{{ BASE }}products?ean=${encodeURIComponent(ean)}&next=${next}`;
            window.location.href = url;
        });

        // Toast apr√®s ajout
        if (new URLSearchParams(location.search).has('added')) {
            toast("Ajout enregistr√© dans le stock.", "ok");
            history.replaceState({}, "", location.pathname);
        }

        // Log √©tat au chargement
        log('Page load', {
            href: location.href,
            isSecure: window.isSecureContext === true,
            hasBarDet: ('BarcodeDetector' in window),
            hasMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
            ua: navigator.userAgent
        });
    })();
</script>
{% endblock %}
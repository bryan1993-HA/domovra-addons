{% extends "base.html" %}
{% block title %}Domovra ‚Äî Achats{% endblock %}
{% block head %}
<style>
    .scan-modal {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, .65);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .scan-modal.hidden {
        display: none;
    }

    .scan-box {
        position: relative;
        width: min(92vw, 700px);
        aspect-ratio: 3/4;
        background: #000;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, .4);
    }

    #scan_video,
    #scan_overlay {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .scan-hud {
        position: absolute;
        right: .75rem;
        top: .75rem;
        display: flex;
        gap: .5rem;
        z-index: 3
    }

    .scan-tip {
        position: absolute;
        left: 0;
        right: 0;
        bottom: .5rem;
        text-align: center;
        color: #fff;
        font-weight: 600;
        text-shadow: 0 1px 2px #000;
        z-index: 3
    }

    .scan-frame {
        position: absolute;
        inset: 12% 8%;
        border: 3px solid rgba(255, 255, 255, .8);
        border-radius: 12px;
        box-shadow: 0 0 0 200vmax rgba(0, 0, 0, .35);
        z-index: 2;
    }

    .scan-frame::after {
        content: "";
        position: absolute;
        left: 10%;
        right: 10%;
        top: 50%;
        height: 2px;
        background: rgba(0, 255, 128, .9);
        box-shadow: 0 0 12px rgba(0, 255, 128, .9);
        transform: translateY(-1px);
        animation: scanline 2.1s linear infinite;
    }

    @keyframes scanline {
        0% {
            top: 18%
        }

        100% {
            top: 82%
        }
    }
</style>
{% endblock %}

{% block header_right %}
<span class="chip">üõí Achats</span>
{% endblock %}


{% block content %}
<div class="wrap" data-page="achats">

    <div class="card">
        <!-- Titre + bouton Scan √† droite -->
        <div class="title" style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <div>
                <h2>Ajouter au stock</h2>
                <span class="muted">‚Üí page d√©di√©e aux entr√©es (scan ou saisie)</span>
            </div>
            <button type="button" class="btn" id="btn_scan" title="Scanner un code-barres">üì∑</button>
            <button type="button" class="btn" id="btn_scan_live" title="Scanner en direct">üé•</button>

        </div>

        <form id="achats_form" method="post" action="{{ BASE }}achats/add" class="form-grid">

            <!-- EAN -->
            <div>
                <div class="label">Code‚Äëbarres (EAN)</div>
                <div class="infield">
                    <input type="text" name="ean" id="ean" placeholder="Scanner ou saisir" inputmode="numeric"
                        autocomplete="off">
                    <button type="button" class="btn" id="btn_check_ean"
                        title="Rechercher le produit par EAN">üîé</button>
                    <button type="button" class="btn" id="btn_create_prod" title="Cr√©er le produit"
                        style="white-space:nowrap;">‚ûï</button>
                </div>
                <div class="hint" id="ean_hint"></div>
            </div>

            <!-- Produit (s√©lection si d√©j√† existant) -->
            <div>
                <div class="label">Produit</div>
                <select name="product_id" id="product_select" required>
                    <option value="" disabled selected>‚Äî Choisir ou scanner ‚Äî</option>
                    {% for p in products %}
                    <option value="{{ p.id }}" data-barcode="{{ p.barcode or '' }}" data-unit="{{ p.unit or 'pi√®ce' }}"
                        data-pack="" {# pack_of si tu l‚Äôajoutes plus tard #}>
                        {{ p.name }}{% if p.brand %} ‚Äî {{ p.brand }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <div class="hint" id="product_hint"></div>
            </div>

            <!-- Nom sugg√©r√© (si produit inconnu via OFF) -->
            <div>
                <div class="label">Nom (sugg√©r√© par OFF)</div>
                <input type="text" id="name_suggest" placeholder="Rempli apr√®s scan si produit inconnu"
                    autocomplete="off">
                <div class="hint" id="off_qty_hint"></div>
            </div>

            <!-- Quantit√© + unit√© + raccourcis -->
            <div>
                <div class="label">Quantit√©</div>
                <div class="infield">
                    <input type="number" step="0.001" min="0.001" name="qty" id="qty" value="1" required>
                    <select name="unit" id="unit" style="max-width:140px">
                        <option value="pi√®ce">pi√®ce</option>
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="l">l</option>
                    </select>
                    <button type="button" class="btn" id="btn_plus1">+1</button>
                    <button type="button" class="btn" id="btn_pack" hidden>+1 pack</button>
                </div>
                <div class="hint" id="qty_hint"></div>
            </div>

            <!-- Emplacement -->
            <div>
                <div class="label">Emplacement</div>
                <select name="location_id" id="location_id" required>
                    {% for loc in locations %}
                    <option value="{{ loc.id }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Dates -->
            <div>
                <div class="label">DLC (optionnel)</div>
                <input type="date" name="best_before" id="best_before">
            </div>

            <div>
                <div class="label">Date de cong√©lation (optionnel)</div>
                <input type="date" name="frozen_on" id="frozen_on">
            </div>

            <!-- Note -->
            <div style="grid-column:1/-1">
                <div class="label">Note (optionnel)</div>
                <textarea name="note" rows="2"
                    placeholder="Infos compl√©mentaires (lot fournisseur, promo, etc.)"></textarea>
            </div>

            <!-- Actions -->
            <div style="grid-column:1/-1; display:flex; gap:.5rem; justify-content:flex-end">
                <button type="reset" class="btn ghost">R√©initialiser</button>
                <button type="submit" class="btn primary">Ajouter</button>
            </div>
            <!-- Aper√ßu vid√©o pour le scan en direct -->
            <div id="live_scanner" style="grid-column:1/-1; display:none;">
                <video id="video_preview" playsinline autoplay muted
                    style="width:100%; max-height:280px; border-radius:12px; background:#000;"></video>
                <div class="hint" id="live_hint">Pointe un code‚Äëbarres vers la cam√©ra‚Ä¶</div>
                <div style="margin-top:.5rem; display:flex; gap:.5rem;">
                    <button type="button" class="btn" id="btn_live_stop">Arr√™ter</button>
                    <button type="button" class="btn ghost" id="btn_live_flip">Changer de cam√©ra</button>
                </div>
            </div>

            <!-- MODALE SCAN -->
            <div id="scan_modal" class="scan-modal hidden" aria-hidden="true">
                <div class="scan-box">
                    <video id="scan_video" playsinline autoplay muted></video>
                    <canvas id="scan_overlay"></canvas>

                    <!-- HUD -->
                    <div class="scan-hud">
                        <button type="button" class="btn ghost" id="scan_flip" title="Changer de cam√©ra">üîÅ</button>
                        <button type="button" class="btn" id="scan_close" title="Fermer">‚úñ</button>
                    </div>

                    <!-- Tip -->
                    <div class="scan-tip">Alignez le code-barres dans le cadre</div>

                    <!-- Cadre de guidage (statique) -->
                    <div class="scan-frame"></div>
                </div>
            </div>


        </form>
        <!-- DEBUG PANEL (cach√© par d√©faut, activ√© via JS) -->
        <div id="dbg_panel" style="display:none; margin-top:1rem;">
            <div class="card" style="background:var(--bg-soft,#1f2937); color:var(--fg,#e5e7eb);">
                <div class="title">
                    <h3>Debug scan</h3>
                </div>
                <pre id="dbg_log"
                    style="white-space:pre-wrap; max-height:220px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<!-- ZXing -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script>
(function () {
  // ===== util =====
  const $ = (s,p=document)=>p.querySelector(s);
  const toast = (m,t='ok')=>window.showToast?.(m,t);

  // --- form refs
  const eanInput = $('#ean');
  const eanHint  = $('#ean_hint');
  const productSel = $('#product_select');
  const nameSuggest = $('#name_suggest');
  const offQtyHint  = $('#off_qty_hint');
  const qtyInput = $('#qty');
  const unitSel  = $('#unit');

  // --- scan (aper√ßu dans la page)
  const liveBox   = $('#live_scanner');
  const videoEl   = $('#video_preview');
  const btnLive   = $('#btn_scan_live');
  const btnStop   = $('#btn_live_stop');
  const btnFlip   = $('#btn_live_flip');

  // --- scan (photo)
  const btnPhoto  = $('#btn_scan');

  let currentStream = null;
  let currentDeviceId = null;
  let zxingReader = null;
  let liveRunning = false;

  // ===== helpers produit =====
  function setHint(el, txt){ if(el) el.textContent = txt||''; }
  function applyProductDefaults(opt){
    if(!opt) return;
    const unit = opt.dataset.unit || 'pi√®ce';
    unitSel.value = Array.from(unitSel.options).some(o=>o.value===unit) ? unit : 'pi√®ce';
  }
  productSel?.addEventListener('change', ()=>applyProductDefaults(productSel.selectedOptions[0]));

  // ===== lookup EAN (DB -> OFF) =====
  async function lookupByEAN(ean){
    const code=(ean||'').trim().replace(/\s+/g,''); if(!code){toast('EAN vide','warn');return;}
    eanInput.value = code;

    try{
      const r = await fetch(`{{ BASE }}api/product/by_barcode?code=${encodeURIComponent(code)}`);
      if(r.ok){
        const p = await r.json();
        const opt=[...productSel.options].find(o=>(o.dataset.barcode||'').replace(/\s+/g,'')===code);
        productSel.value = opt ? opt.value : String(p.id);
        productSel.dispatchEvent(new Event('change'));
        setHint(eanHint, `Produit trouv√© : ${p.name}`);
        if(!qtyInput.value) qtyInput.value='1';
        toast('Produit s√©lectionn√© depuis le stock','ok');
        return;
      }
    }catch{}
    try{
      const r = await fetch(`{{ BASE }}api/off?barcode=${encodeURIComponent(code)}`);
      const data = await r.json();
      if(data?.ok){
        setHint(eanHint,"Produit non connu dans Domovra (OFF consult√©).");
        nameSuggest.value = data.name || '';
        setHint(offQtyHint, data.quantity ? `Quantit√© OFF : ${data.quantity}` : '');
        if(!qtyInput.value || qtyInput.value==='0') qtyInput.value='1';
        toast(`OFF ‚Üí ${data.name || 'Nom inconnu'}`,'warn');
      }else{
        setHint(eanHint,"Ni Domovra ni OFF n‚Äôont trouv√© ce code.");
        nameSuggest.value=''; setHint(offQtyHint,''); toast("Aucun r√©sultat pour cet EAN.","warn");
      }
    }catch{
      setHint(eanHint,"Erreur OFF."); toast("Erreur OFF.","error");
    }
  }
  $('#btn_check_ean')?.addEventListener('click', ()=>lookupByEAN(eanInput.value));
  eanInput?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); lookupByEAN(eanInput.value);} });

  // ===== ZXing hints (am√©liore EAN) =====
  function zxingHints(){
    const H = ZXing.DecodeHintType, F = ZXing.BarcodeFormat;
    const hints = new Map();
    hints.set(H.POSSIBLE_FORMATS, [F.EAN_13, F.EAN_8, F.UPC_A, F.UPC_E]);
    hints.set(H.TRY_HARDER, true);
    hints.set(H.ASSUME_GS1, true);
    return hints;
  }

  // ===== PHOTO (fallback universel) =====
  function pickImageFromCamera(){
    return new Promise(resolve=>{
      const input=document.createElement('input');
      input.type='file'; input.accept='image/*'; input.setAttribute('capture','environment');
      if(/iPad|iPhone|iPod/.test(navigator.userAgent)){ input.accept='image/*;capture=camera'; input.setAttribute('capture','camera'); }
      input.onchange=()=>resolve(input.files?.[0]||null);
      input.click();
    });
  }
  async function decodeImageWithZXing(file){
    return new Promise((resolve)=>{
      const fr=new FileReader();
      fr.onload=()=>{
        const img=new Image();
        img.onload=async()=>{
          try{
            const reader = new ZXing.BrowserMultiFormatReader(zxingHints());
            const res = await reader.decodeFromImage(img);
            resolve(res?.text || null);
          }catch{ resolve(null); }
        };
        img.onerror=()=>resolve(null);
        img.src=fr.result;
      };
      fr.onerror=()=>resolve(null);
      fr.readAsDataURL(file);
    });
  }
  btnPhoto?.addEventListener('click', async ()=>{
    // 1) BarcodeDetector (si HTTPS + support)
    if(window.isSecureContext && 'BarcodeDetector' in window){
      try{
        const file = await pickImageFromCamera(); if(!file) return;
        const bmp = await createImageBitmap(file);
        const det = new BarcodeDetector({formats:['ean_13','ean_8','upc_e','upc_a']});
        const found = await det.detect(bmp);
        if(found?.length){ const code=found[0].rawValue; eanInput.value=code; return lookupByEAN(code); }
      }catch{}
    }
    // 2) ZXing
    const file = await pickImageFromCamera(); if(!file) return;
    const code = await decodeImageWithZXing(file);
    if(code){ eanInput.value=code; return lookupByEAN(code); }
    toast('Aucun code‚Äëbarres d√©tect√© sur la photo.','warn');
  });

  // ===== LIVE (r√©ouverture cam√©ra arri√®re fiable) =====
  async function listVideoInputs(){
    if(!navigator.mediaDevices?.enumerateDevices) return [];
    const all = await navigator.mediaDevices.enumerateDevices();
    return all.filter(d=>d.kind==='videoinput');
  }

  async function startLive(targetVideo){
    // Contraintes simples : on *sugg√®re* la cam√©ra arri√®re
    const constraints = {
      audio:false,
      video: currentDeviceId ? { deviceId: { exact: currentDeviceId } }
                             : { facingMode: { ideal:'environment' } }
    };

    // 1) ouvre la cam√©ra
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = stream;
    targetVideo.srcObject = stream;
    // iOS/Safari a parfois besoin d‚Äôun .play()
    try { await targetVideo.play?.(); } catch {}

    // 2) si on n‚Äôa pas encore un deviceId, on choisit un ‚Äúback‚Äù s‚Äôil existe
    const devs = await listVideoInputs();
    if(!currentDeviceId && devs.length){
      const back = devs.find(d=>/back|rear|environment|arri√®re/i.test(d.label));
      currentDeviceId = (back || devs[0]).deviceId;
    }

    // 3) ZXing (avec hints EAN)
    if(!zxingReader) zxingReader = new ZXing.BrowserMultiFormatReader(zxingHints());
    liveRunning = true;
    await zxingReader.decodeFromVideoDevice(
      currentDeviceId || null,
      targetVideo,
      (result, err)=>{
        if(!liveRunning) return;
        if(result){
          const code = result.text;
          liveRunning = false;
          stopLive(false);
          eanInput.value = code;
          toast('Code d√©tect√© : '+code,'ok');
          lookupByEAN(code);
        }
      }
    );
  }

  function stopLive(hideBox=true){
    try{ zxingReader?.reset?.(); }catch{}
    if(currentStream){ try{ currentStream.getTracks().forEach(t=>t.stop()); }catch{} }
    currentStream = null;
    if(hideBox && liveBox) liveBox.style.display='none';
  }

  // Boutons live
  btnLive?.addEventListener('click', async ()=>{
    if(!navigator.mediaDevices?.getUserMedia){ toast('Cam√©ra indisponible','warn'); return; }
    try{
      liveBox.style.display='block';
      await startLive(videoEl);
    }catch(err){
      toast('Cam√©ra live indisponible ici. Essaie üì∑ (photo).','warn');
      stopLive();
    }
  });

  btnStop?.addEventListener('click', ()=>stopLive());

  btnFlip?.addEventListener('click', async ()=>{
    const devs = await listVideoInputs();
    if(!devs.length){ toast('Aucune autre cam√©ra d√©tect√©e.','warn'); return; }
    const idx = devs.findIndex(d=>d.deviceId===currentDeviceId);
    currentDeviceId = devs[(idx+1+devs.length)%devs.length].deviceId;
    stopLive(false);
    await startLive(videoEl);
  });

  // ===== cr√©er produit (inchang√©)
  $('#btn_create_prod')?.addEventListener('click', ()=>{
    const ean = (eanInput.value||'').trim();
    const next = encodeURIComponent("{{ BASE }}achats");
    location.href = `{{ BASE }}products?ean=${encodeURIComponent(ean)}&next=${next}`;
  });

  // ===== toast apr√®s ajout (inchang√©)
  if(new URLSearchParams(location.search).has('added')){
    toast("Ajout enregistr√© dans le stock.","ok");
    history.replaceState({}, "", location.pathname);
  }
})();
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Domovra ‚Äî Fiche produit{% endblock %}

{% block head %}
{% endblock %}

{% block header_right %}
<span class="chip">üóÇÔ∏è Fiches produit : <b>{{ items|length }}</b></span>
{% endblock %}

{% block content %}
<div class="wrap" data-page="product">

  <!-- Ajouter un produit -->
  <div class="card">
    <div class="title">
      <h2>Ajouter un produit</h2>
      <span class="muted">‚Üí cr√©er une fiche produit compl√®te</span>
    </div>

    {# Styles de grille sp√©cifiques √† CE formulaire (scop√©s) #}
    <style>
      /* Grille dense mais lisible sur desktop ; se replie proprement en mobile */
      .wrap form#create_form.form-grid {
        display: grid !important;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr auto;
        gap: 12px;
        align-items: end;
      }

      /* Forcer certains champs √† occuper toute la ligne */
      .wrap form#create_form .full {
        grid-column: 1 / -1;
      }

      .wrap form#create_form .half {
        grid-column: auto / span 3;
      }

      .wrap form#create_form .third {
        grid-column: auto / span 2;
      }

      @media (max-width: 1200px) {
        .wrap form#create_form.form-grid {
          grid-template-columns: 2fr 1fr 1fr 1fr auto;
        }
      }

      @media (max-width: 900px) {
        .wrap form#create_form.form-grid {
          grid-template-columns: 1fr 1fr 1fr;
        }

        .wrap form#create_form .btn-wide {
          grid-column: 1 / -1;
          justify-self: stretch;
        }

        .wrap form#create_form .full,
        .wrap form#create_form .half,
        .wrap form#create_form .third {
          grid-column: 1 / -1;
        }
      }

      @media (max-width: 700px) {
        .wrap form#create_form.form-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Radios ‚ÄúDLC / DDM‚Äù compacts */
      .expiry-kind {
        display: grid;
        grid-auto-flow: column;
        gap: 10px;
        align-items: center;
      }

      .expiry-kind label {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        white-space: nowrap;
      }

      /* Ligne d‚Äôaide plus fine sous les fieldsets */
      .field-hint {
        margin-top: 4px;
        font-size: .9rem;
        color: var(--muted);
      }
    </style>

    <form id="create_form" method="post" action="{{ BASE }}product/add" class="add-product-form">

      <!-- Nom & Description (pleine largeur) -->
      <div class="field" style="grid-column:1 / -1">
        <div class="label">Nom du produit <span class="help" tabindex="0" data-tip="Nom court et explicite."></span>
        </div>
        <input name="name" id="create_name" type="text" required placeholder="ex. P√¢tes, Lait demi-√©cr√©m√©">
      </div>

      <div class="field" style="grid-column:1 / -1">
        <div class="label">Description <span class="help" tabindex="0" data-tip="ex. Brique UHT, 6√ó1 L, marque‚Ä¶"></span>
        </div>
        <textarea name="description" id="create_desc" rows="2" placeholder="ex. Brique UHT, 6√ó1 L, marque‚Ä¶"></textarea>
      </div>

      <!-- Ligne 1 : emplacement / unit√© / cat√©gorie -->
      <div class="field">
        <div class="label">Emplacement par d√©faut <span class="help" tabindex="0"
            data-tip="L√† o√π tu ranges habituellement ce produit."></span></div>
        <select name="default_location_id" id="create_default_location_id">
          <option value="">‚Äî Aucun (choisir √† l‚Äôajout en stock) ‚Äî</option>
          {% for loc in locations or [] %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="field">
        <div class="label">Unit√© par d√©faut</div>
        <select name="unit" id="create_unit">
          <optgroup label="Comptage">
            <option value="pi√®ce" selected>pi√®ce</option>
            <option value="tranche">tranche</option>
            <option value="paquet">paquet</option>
            <option value="bo√Æte">bo√Æte</option>
            <option value="bocal">bocal</option>
            <option value="bouteille">bouteille</option>
            <option value="sachet">sachet</option>
            <option value="lot">lot</option>
            <option value="barquette">barquette</option>
            <option value="rouleau">rouleau</option>
            <option value="dosette">dosette</option>
          </optgroup>
          <optgroup label="Poids">
            <option value="g">g</option>
            <option value="kg">kg</option>
          </optgroup>
          <optgroup label="Volume">
            <option value="ml">ml</option>
            <option value="L">L</option>
          </optgroup>
        </select>
      </div>

      <div class="field">
        <div class="label">Cat√©gorie de produits</div>
        <input name="category" id="create_category" placeholder="ex. Produits laitiers, Viande, Condiments‚Ä¶">
      </div>

      <!-- Ligne 2 : min_qty (suffixe), alerte, parent -->
      <div class="field">
        <div class="label">Quantit√© minimum en stock <span class="help" tabindex="0"
            data-tip="Seuil d‚Äôalerte propre √† ce produit."></span></div>
        <div class="infield-qty">
          <input name="min_qty" id="create_min_qty" type="number" min="0" step="1" placeholder="ex. 1"
            value="{{ SETTINGS.low_stock_default }}">
          <span id="create_min_unit" class="suffix">pi√®ce</span>
        </div>
        <div class="hint muted" id="create_min_hint">Conseil : 1, 2, 3 pi√®ces‚Ä¶</div>
      </div>

      <div class="field">
        <div class="label">Alerte stock faible actif ?</div>
        <select name="low_stock_enabled" id="create_low_enabled">
          <option value="1" selected>Oui</option>
          <option value="0">Non</option>
        </select>
      </div>

      <div class="field">
        <div class="label">Produit parent</div>
        <select name="parent_id" id="create_parent">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for p in parents or [] %}
          <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Ligne 3 : DLC/DDM, shelf, no-freeze, freeze-shelf -->
      <div class="field">
        <div class="label">Type d‚Äô√©ch√©ance</div>
        <div class="segmented">
          <label><input type="radio" name="expiry_kind" value="DLC" checked><span>DLC</span></label>
          <label><input type="radio" name="expiry_kind" value="DDM"><span>DDM</span></label>
        </div>
      </div>

      <div class="field">
        <div class="label">P√©remption par d√©faut (jours)</div>
        <input name="shelf" id="create_shelf" type="number" min="1" placeholder="ex. 90">
      </div>

      <div class="field no-freeze-cell">
        <label class="checkbox-inline">
          <input type="checkbox" id="create_no_freeze" name="no_freeze" value="1">
          <span>Ne doit pas √™tre congel√©</span>
        </label>
      </div>

      <div class="field" id="create_freeze_group">
        <div class="label">P√©remption apr√®s cong√©lation (jours)</div>
        <input name="default_freeze_shelf_days" id="create_freeze_shelf" type="number" min="1" placeholder="ex. 180">
      </div>

      <!-- Ligne boutons -->
      <div class="field" style="grid-column:1 / -2">
        <!-- vide: garde l‚Äôespace, aligne les boutons √† droite comme locations -->
      </div>
      <div class="field">
        <button class="secondary btn-wide" type="submit">Ôºã Ajouter</button>
      </div>
    </form>


  </div>


  <!-- Outils -->
  <div class="card">
    <div class="title">
      <h2>Outils</h2><span class="muted">Recherche</span>
    </div>
    <div class="row" style="align-items:center">
      <input id="q" type="search" placeholder="Rechercher une fiche produit‚Ä¶" style="flex:1;min-width:220px">
    </div>
  </div>


  <!-- Liste -->
  <div class="card">
    <div class="title">
      <h2>Fiches produit</h2><span class="muted">Table (bureau) / Cartes (mobile)</span>
    </div>

    <table id="tbl">
      <colgroup>
        <col style="width:28%">
        <col style="width:50%">
        <col style="width:22%">
      </colgroup>
      <thead>
        <tr>
          <th>Nom</th>
          <th>Infos</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody">
        {% if items %}
        {% for it in items %}
        {% set threshold = it.min_qty if it.min_qty is not none else SETTINGS.low_stock_default %}
        {% set is_low = ( it.qty_total < threshold ) %} <tr data-name="{{ it.name|lower }}"
          data-unit="{{ it.unit|lower }}" data-barcode="{{ (it.barcode or '')|lower }}">
          <td>
            <div style="font-weight:600;display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <span>{{ it.name }}</span>
              {% if it.barcode %}<span class="muted">EAN : {{ it.barcode }}</span>{% endif %}
              {% if is_low %}<span class="pill danger">üîª Faible stock</span>{% endif %}
            </div>
          </td>
          <td>
            <div class="stats">
              <span class="stat"><span class="k">Unit√©</span><span> :</span><span class="v">{{ it.unit }}</span></span>
              <span class="stat"><span class="k">Conservation</span><span> :</span><span class="v">{{
                  it.default_shelf_life_days }} j</span></span>
              <span class="stat"><span class="k">Stocks</span><span> :</span><span class="v">{{ it.lots_count
                  }}</span></span>
              <span class="stat"><span class="k">Qt√© totale</span><span> :</span><span class="v">{{
                  '%.2f'|format(it.qty_total) }}</span></span>
              <span class="stat"><span class="k">Seuil min</span><span> :</span><span class="v">{{ threshold
                  }}</span></span>
            </div>
          </td>
          <td>
            <div class="actions" style="display:grid;gap:8px">
              <div class="row2" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <button class="secondary js-edit-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
                  data-desc="{{ it.description or '' }}" data-default-location="{{ it.default_location_id or '' }}"
                  data-min="{{ it.min_qty if it.min_qty is not none else '' }}"
                  data-low-enabled="{{ 1 if (it.low_stock_enabled is not none and it.low_stock_enabled!=0) else 0 }}"
                  data-expiry-kind="{{ (it.expiry_kind or 'DLC') }}" data-shelf="{{ it.default_shelf_life_days or '' }}"
                  data-freeze-shelf="{{ it.default_freeze_shelf_days or '' }}"
                  data-no-freeze="{{ 1 if (it.no_freeze is not none and it.no_freeze!=0) else 0 }}"
                  data-category="{{ it.category or '' }}" data-unit="{{ it.unit or 'pi√®ce' }}"
                  data-parent="{{ it.parent_id or '' }}">‚úèÔ∏è Modifier</button>

                <button class="secondary js-delete-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
                  data-lots="{{ it.lots_count|int }}">üóëÔ∏è Supprimer</button>
              </div>
            </div>
          </td>

          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="3" class="muted">Aucun produit.</td>
          </tr>
          {% endif %}
      </tbody>
    </table>

    <!-- Mobile cards -->
    <div class="cards" id="cards">
      {% for it in items %}
      {% set threshold = it.min_qty if it.min_qty is not none else SETTINGS.low_stock_default %}
      {% set is_low = ( it.qty_total < threshold ) %} <div class="card-item" data-name="{{ it.name|lower }}"
        data-unit="{{ it.unit|lower }}" data-barcode="{{ (it.barcode or '')|lower }}">
        <div class="card-head">
          <div class="card-name">{{ it.name }}{% if is_low %} <span class="pill danger">üîª Faible stock</span>{% endif
            %}</div>
        </div>

        <button class="card-toggle js-card-toggle" type="button" aria-expanded="false" aria-controls="more-{{ it.id }}">
          <span>Plus d‚Äôinfos</span><span class="chev">‚ñ∂</span>
        </button>

        <div class="card-extra" id="more-{{ it.id }}" hidden>
          <div class="card-info">
            {% if it.barcode %}<span class="stat"><span class="k">EAN</span><span> :</span><span class="v">{{ it.barcode
                }}</span></span>{% endif %}
            <span class="stat"><span class="k">Unit√©</span><span> :</span><span class="v">{{ it.unit }}</span></span>
            <span class="stat"><span class="k">Conservation</span><span> :</span><span class="v">{{
                it.default_shelf_life_days }} j</span></span>
            <span class="stat"><span class="k">Stocks</span><span> :</span><span class="v">{{ it.lots_count
                }}</span></span>
            <span class="stat"><span class="k">Qt√©</span><span> :</span><span class="v">{{ '%.2f'|format(it.qty_total)
                }}</span></span>
            <span class="stat"><span class="k">Seuil min</span><span> :</span><span class="v">{{ threshold
                }}</span></span>
          </div>
        </div>

        <div class="card-actions">
          <button class="secondary js-edit-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-desc="{{ it.description or '' }}" data-default-location="{{ it.default_location_id or '' }}"
            data-min="{{ it.min_qty if it.min_qty is not none else '' }}"
            data-low-enabled="{{ 1 if (it.low_stock_enabled is not none and it.low_stock_enabled!=0) else 0 }}"
            data-expiry-kind="{{ (it.expiry_kind or 'DLC') }}" data-shelf="{{ it.default_shelf_life_days or '' }}"
            data-freeze-shelf="{{ it.default_freeze_shelf_days or '' }}"
            data-no-freeze="{{ 1 if (it.no_freeze is not none and it.no_freeze!=0) else 0 }}"
            data-category="{{ it.category or '' }}" data-unit="{{ it.unit or 'pi√®ce' }}"
            data-parent="{{ it.parent_id or '' }}">‚úèÔ∏è Modifier</button>
          <button class="secondary js-delete-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-lots="{{ it.lots_count|int }}">üóëÔ∏è Supprimer</button>
        </div>

    </div>
    {% endfor %}
  </div>
</div>
</div>

<!-- Dialogs -->
<dialog id="dlg-edit">
  <form method="post" action="{{ BASE }}product/update" style="display:grid;gap:10px;min-width:min(680px,96vw)">
    <h3 style="margin:0">Modifier la fiche produit</h3>
    <input type="hidden" name="product_id" id="dlg-product-id">

    <div>
      <div class="label">Nom</div>
      <input type="text" name="name" id="dlg-name" required>
    </div>

    <div>
      <div class="label">Description</div>
      <textarea name="description" id="dlg-desc" rows="2"></textarea>
    </div>

    <div class="row" style="gap:10px">
      <div style="flex:1">
        <div class="label">Emplacement par d√©faut</div>
        <select name="default_location_id" id="dlg-default-location">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for loc in locations or [] %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div style="flex:1">
        <div class="label">Unit√©</div>
        <select name="unit" id="dlg-unit">
          <optgroup label="Comptage">
            <option value="pi√®ce">pi√®ce</option>
            <option value="tranche">tranche</option>
            <option value="paquet">paquet</option>
            <option value="bo√Æte">bo√Æte</option>
            <option value="bocal">bocal</option>
            <option value="bouteille">bouteille</option>
            <option value="sachet">sachet</option>
            <option value="lot">lot</option>
            <option value="barquette">barquette</option>
            <option value="rouleau">rouleau</option>
            <option value="dosette">dosette</option>
          </optgroup>
          <optgroup label="Poids">
            <option value="g">g</option>
            <option value="kg">kg</option>
          </optgroup>
          <optgroup label="Volume">
            <option value="ml">ml</option>
            <option value="L">L</option>
          </optgroup>
        </select>
      </div>

      <div class="field">
        <div class="label">
          Quantit√© minimum en stock
          <span class="help" tabindex="0" data-tip="Conseil‚ÄØ: commence par 1, 2 ou 3 selon le produit."></span>
        </div>
        <div class="infield-qty">
          <input id="create_min_qty" ...>
          <span class="suffix" id="create_min_suffix">pi√®ce</span>
        </div>
      </div>

    </div>

    <div class="row" style="gap:10px">
      <div style="flex:1">
        <div class="label">Alerte stock faible actif ?</div>
        <select name="low_stock_enabled" id="dlg-low-enabled">
          <option value="1">Oui</option>
          <option value="0">Non</option>
        </select>
      </div>

      <div style="flex:1">
        <div class="label">Type d‚Äô√©ch√©ance</div>
        <div>
          <label style="margin-right:10px"><input type="radio" name="expiry_kind" id="dlg-exp-dlc" value="DLC">
            DLC</label>
          <label><input type="radio" name="expiry_kind" id="dlg-exp-ddm" value="DDM"> DDM</label>
        </div>
      </div>

      <div style="flex:1">
        <div class="label">P√©remption par d√©faut (jours)</div>
        <!-- IMPORTANT: name="shelf" pour rester compatible avec ta route -->
        <input type="number" name="shelf" id="dlg-shelf" min="1" placeholder="ex. 90">
      </div>
    </div>

    <div class="row" style="gap:10px">
      <div style="flex:1">
        <label class="label" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="dlg-no-freeze" name="no_freeze" value="1">
          Ne doit pas √™tre congel√©
        </label>
      </div>

      <div style="flex:1" id="dlg-freeze-group">
        <div class="label">P√©remption apr√®s cong√©lation (jours)</div>
        <input type="number" name="default_freeze_shelf_days" id="dlg-freeze-shelf" min="1" placeholder="ex. 180">
      </div>

      <div style="flex:1">
        <div class="label">Cat√©gorie</div>
        <input name="category" id="dlg-category" placeholder="ex. Produits laitiers">
      </div>
    </div>

    <div>
      <div class="label">Produit parent</div>
      <select name="parent_id" id="dlg-parent">
        <option value="">‚Äî Aucun ‚Äî</option>
        {% for p in parents or [] %}
        <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-edit').close()">Annuler</button>
      <button class="secondary">Enregistrer</button>
    </div>
  </form>
</dialog>


<dialog id="dlg-delete">
  <form method="post" action="{{ BASE }}product/delete" style="display:grid;gap:10px;min-width:min(420px,92vw)">
    <h3 style="margin:0">Supprimer le produit</h3>
    <input type="hidden" name="product_id" id="del-product-id">
    <div class="muted" id="del-msg">La suppression retirera aussi les stocks li√©s √† ce produit.</div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-delete').close()">Annuler</button>
      <button class="secondary" style="background:var(--danger);border:0;color:#1d0c0c">Supprimer</button>
    </div>
  </form>
</dialog>

{% endblock %}

{% block scripts %}
<script>

  // utilitaires d√©j√† pr√©sents : const $ = s => document.querySelector(s); setSelectValue(sel,val)

  function applyDlgMinUnitLogic() {
    const unit = $('#dlg-unit')?.value || 'pi√®ce';
    const minInput = $('#dlg-min');
    const unitSuffix = $('#dlg_min_unit');
    if (!minInput || !unitSuffix) return;

    let step = 1, suffix = unit, placeholder = 'ex. 1';
    switch (unit) {
      case 'L': step = 1; suffix = 'L'; placeholder = 'ex. 1 (‚Üí 1 L, 2 L ‚Ä¶)'; break;
      case 'ml': step = 50; suffix = 'ml'; placeholder = 'ex. 500 (‚Üí 500 ml ‚Ä¶)'; break;
      case 'kg': step = 0.1; suffix = 'kg'; placeholder = 'ex. 0.5 (‚Üí 0,5 kg ‚Ä¶)'; break;
      case 'g': step = 50; suffix = 'g'; placeholder = 'ex. 500 (‚Üí 500 g ‚Ä¶)'; break;
      default: step = 1; suffix = unit || 'pi√®ce'; placeholder = 'ex. 1';
    }
    minInput.step = String(step);
    minInput.placeholder = placeholder;
    unitSuffix.textContent = suffix;
  }

  function applyDlgFreezeVisibility() {
    const nf = $('#dlg-no-freeze');
    const grp = $('#dlg-freeze-group');
    if (!nf || !grp) return;
    grp.style.display = nf.checked ? 'none' : '';
  }

  document.addEventListener('click', function (e) {
    const edit = e.target.closest('.js-edit-open');
    if (!edit) return;

    // Hidden + texte
    $('#dlg-product-id').value = edit.dataset.id || '';
    $('#dlg-name').value = edit.dataset.name || '';
    $('#dlg-desc').value = edit.dataset.desc || '';

    // Selects
    setSelectValue($('#dlg-default-location'), edit.dataset.defaultLocation || '');
    setSelectValue($('#dlg-unit'), edit.dataset.unit || 'pi√®ce');
    setSelectValue($('#dlg-low-enabled'), (edit.dataset.lowEnabled === '0' ? '0' : '1'));
    setSelectValue($('#dlg-category'), edit.dataset.category || '');
    setSelectValue($('#dlg-parent'), edit.dataset.parent || '');

    // Nombres
    $('#dlg-min').value = (edit.dataset.min || '');
    $('#dlg-shelf').value = (edit.dataset.shelf || '');
    $('#dlg-freeze-shelf').value = (edit.dataset.freezeShelf || '');

    // Radios DLC / DDM
    const kind = (edit.dataset.expiryKind || 'DLC').toUpperCase();
    $('#dlg-exp-dlc').checked = (kind === 'DLC');
    $('#dlg-exp-ddm').checked = (kind === 'DDM');

    // Checkbox no_freeze + masquage champ cong√©lation
    const nf = $('#dlg-no-freeze');
    nf.checked = (edit.dataset.noFreeze === '1');
    applyDlgFreezeVisibility();

    // Logique unit√© pour min_qty
    applyDlgMinUnitLogic();

    // Listeners (une seule fois id√©alement ; si tu veux √™tre safe, tu peux d√©tacher avant)
    $('#dlg-unit').addEventListener('change', applyDlgMinUnitLogic);
    nf.addEventListener('change', applyDlgFreezeVisibility);

    $('#dlg-edit').showModal();
  });

  /* Recherche live */
  const q = document.getElementById('q'), tbody = document.getElementById('tbody'), cards = document.getElementById('cards');
  const rows = Array.from(tbody ? tbody.children : []), cardsItems = Array.from(cards ? cards.children : []);
  function applyFilter(s) {
    const t = s.toLowerCase().trim(); let shown = 0;
    rows.forEach(tr => {
      const txt = tr.dataset.name + ' ' + tr.dataset.unit + ' ' + (tr.dataset.barcode || '');
      const m = txt.includes(t); tr.style.display = m ? '' : 'none'; if (m) shown++;
    });
    cardsItems.forEach(c => {
      const txt = c.dataset.name + ' ' + c.dataset.unit + ' ' + (c.dataset.barcode || '');
      const m = txt.includes(t); c.style.display = m ? '' : 'none';
    });
    const pc = document.getElementById('prod-count'); if (pc) pc.textContent = t ? shown : rows.length;
  }
  if (q) q.addEventListener('input', e => applyFilter(e.target.value));

  /* Utilitaires */
  const $ = s => document.querySelector(s);
  function setSelectValue(sel, val) {
    if (!sel) return;
    [...sel.querySelectorAll('option[data-temp="1"]')].forEach(o => o.remove());
    const opts = [...sel.options].map(o => o.value);
    if (opts.includes(val)) sel.value = val;
    else if (val) { const o = document.createElement('option'); o.value = val; o.textContent = val + ' (autre)'; o.dataset.temp = '1'; sel.insertBefore(o, sel.firstChild); sel.value = val; }
  }

  /* === Logique min_qty selon l'unit√© === */
  (function () {
    const unitSel = document.getElementById('create_unit');
    const minInput = document.getElementById('create_min_qty');
    const unitSuffix = document.getElementById('min_qty_unit');
    const hint = document.getElementById('min_qty_hint');

    if (!unitSel || !minInput || !unitSuffix || !hint) return;

    function applyUnitLogic(u) {
      let step = 1, placeholder = 'ex. 1', suffix = u || '';
      let hintTxt = '';

      switch (u) {
        case 'L':
          step = 1; placeholder = 'ex. 1 (‚Üí 1 L, 2 L ...)'; suffix = 'L';
          hintTxt = 'Pas conseill√© : 1 L. Valeurs enti√®res.';
          break;
        case 'ml':
          step = 50; placeholder = 'ex. 500 (‚Üí 500 ml, 550 ml ...)'; suffix = 'ml';
          hintTxt = 'Pas conseill√© : 50 ml.';
          break;
        case 'kg':
          step = 0.1; placeholder = 'ex. 0.5 (‚Üí 0,5 kg, 0,6 kg ...)'; suffix = 'kg';
          hintTxt = 'Pas conseill√© : 0,1 kg.';
          break;
        case 'g':
          step = 50; placeholder = 'ex. 500 (‚Üí 500 g, 550 g ...)'; suffix = 'g';
          hintTxt = 'Pas conseill√© : 50 g.';
          break;
        default:
          // unit√©s de comptage (pi√®ce, paquet, bouteille, etc.)
          step = 1; placeholder = 'ex. 1'; suffix = u || 'pi√®ce';
          hintTxt = 'Pas conseill√© : 1.';
          break;
      }

      minInput.step = String(step);
      minInput.placeholder = placeholder;
      unitSuffix.textContent = suffix;
      hint.textContent = hintTxt;
    }

    unitSel.addEventListener('change', e => applyUnitLogic(e.target.value));
    // init au chargement
    applyUnitLogic(unitSel.value || 'pi√®ce');
  })();

  /* === Afficher/Masquer 'Apr√®s cong√©lation (jours)' === */
  (function () {
    const chk = document.getElementById('create_no_freeze_chk');
    const grp = document.getElementById('freeze_shelf_group');
    if (!chk || !grp) return;

    function apply() { grp.style.display = chk.checked ? 'none' : ''; }
    chk.addEventListener('change', apply);
    // init
    apply();
  })();


  /* Modales Modifier / Supprimer */
  document.addEventListener('click', function (e) {
    const edit = e.target.closest('.js-edit-open'); const del = e.target.closest('.js-delete-open');
    if (edit) {
      $('#dlg-product-id').value = edit.dataset.id;
      $('#dlg-name').value = edit.dataset.name || '';
      setSelectValue($('#dlg-unit'), edit.dataset.unit || 'pi√®ce');
      $('#dlg-shelf').value = edit.dataset.shelf || 90;
      $('#dlg-min').value = (edit.dataset.min || '{{ SETTINGS.low_stock_default }}');
      $('#dlg-edit').showModal(); return;
    }
    if (del) {
      $('#del-product-id').value = del.dataset.id;
      const name = del.dataset.name || ''; const lots = parseInt(del.dataset.lots || '0', 10);
      $('#del-msg').textContent = lots > 0
        ? `La suppression retirera aussi les ${lots} stock(s) li√©(s) √† ¬´ ${name} ¬ª.`
        : `Supprimer ¬´ ${name} ¬ª ?`;
      $('#dlg-delete').showModal(); return;
    }
  });

  /* Reset cr√©ation */
  (function () {
    const r = document.getElementById('create_reset'); if (!r) return;
    r.addEventListener('click', () => {
      ['create_name', 'create_desc', 'create_default_location_id', 'create_min_qty',
        'create_low_stock_enabled', 'create_shelf', 'create_freeze_shelf', 'create_no_freeze',
        'create_category', 'create_unit', 'create_parent_id'
      ].forEach(id => {

        const el = document.getElementById(id);
        if (el) el.value = id === 'create_min_qty' ? '{{ SETTINGS.low_stock_default }}' : '';
      });
      const u = document.getElementById('create_unit'); if (u) u.value = 'pi√®ce';
    });
  })();

  // === Logique create: min_qty selon unit√© + suffixe + hint
  (function () {
    const unitSel = document.getElementById('create_unit');
    const minInput = document.getElementById('create_min_qty');
    const suffix = document.getElementById('create_min_unit');
    const hint = document.getElementById('create_min_hint');

    function applyUnitLogic() {
      const u = (unitSel?.value || 'pi√®ce');
      let step = 1, suf = u, h = '';
      switch (u) {
        case 'L': step = 1; suf = 'L'; h = 'Conseil : seuil en litres entiers (1, 2, ‚Ä¶)'; break;
        case 'ml': step = 50; suf = 'ml'; h = 'Conseil : pas de 50 ml (50, 100, ‚Ä¶)'; break;
        case 'kg': step = 0.1; suf = 'kg'; h = 'Conseil : pas de 0,1 kg (0,5 ; 1,0 ‚Ä¶)'; break;
        case 'g': step = 50; suf = 'g'; h = 'Conseil : pas de 50 g (250, 500, ‚Ä¶)'; break;
        default: step = 1; suf = (u || 'pi√®ce'); h = 'Conseil : 1, 2, 3 pi√®ces‚Ä¶';
      }
      if (minInput) {
        minInput.step = String(step);
        if (!minInput.value) minInput.placeholder = (step === 1 ? 'ex. 1' : `ex. ${step}`);
      }
      if (suffix) suffix.textContent = suf;
      if (hint) hint.textContent = h;
    }

    if (unitSel) {
      unitSel.addEventListener('change', applyUnitLogic);
      applyUnitLogic();
    }
  })();

  // === Logique create: masquer "apr√®s cong√©lation" si non-congelable
  (function () {
    const cb = document.getElementById('create_no_freeze');
    const grp = document.getElementById('create_freeze_group');
    function applyFreezeVisibility() {
      if (!cb || !grp) return;
      grp.style.display = cb.checked ? 'none' : '';
      if (cb.checked) {
        const f = document.getElementById('create_freeze_shelf');
        if (f) f.value = '';
      }
    }
    if (cb) {
      cb.addEventListener('change', applyFreezeVisibility);
      applyFreezeVisibility();
    }
  })();


  /* Toasts via ?added=1 */
  (function () { const p = new URLSearchParams(location.search); if (p.get('added') === '1') window.showToast('Produit ajout√©.', 'ok'); })();

  /* OFF + Scanner */
  const elCode = $('#off_barcode'), elSearch = $('#off_search'), elCapture = $('#off_capture'), elFile = $('#off_file'),
    elPaste = $('#off_paste'), elClear = $('#off_clear'), elError = $('#off_error'), elRes = $('#off_result'),
    elImg = $('#off_img'), elName = $('#off_name'), elBrand = $('#off_brand'), elQty = $('#off_qty'), elFillCreate = $('#off_fill_create');
  const cfName = $('#create_name'), cfUnitSel = $('#create_unit'), cfBarcode = $('#create_barcode');

  function showError(msg) { if (!elError) return; elError.textContent = msg || 'Erreur'; elError.hidden = false; }
  function clearError() { if (!elError) return; elError.hidden = true; elError.textContent = ''; }
  function clearResult() { if (!elRes) return; elRes.hidden = true; if (elFillCreate) elFillCreate.dataset.payload = ''; }

  function normalizeOFF(data) {
    const p = (data && data.product) || {};
    const nm = p.product_name || p.generic_name || p.brands_tags?.[0] || '';
    const brand = p.brands || (p.brands_tags && p.brands_tags.join(', ')) || '';
    const img = p.image_small_url || p.image_front_url || p.image_url || '';
    const qty = p.quantity || p.serving_quantity || p.serving_size || '';
    return { name: nm, brand, img, quantity_hint: qty };
  }
  function showResult(o) {
    elImg.src = o.img || ''; elName.textContent = o.name || '‚Äî'; elBrand.textContent = o.brand || '‚Äî'; elQty.textContent = o.quantity_hint || '‚Äî';
    elRes.hidden = false; if (elFillCreate) elFillCreate.dataset.payload = JSON.stringify(o);
  }

  async function doLookup() {
    clearError(); clearResult();
    const code = (elCode.value || '').replace(/\D+/g, '');
    if (!code) { showError('Renseigne un code-barres valide.'); return; }
    elSearch.disabled = true; elSearch.textContent = '‚Ä¶';
    try {
      const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
      if (!res.ok) throw new Error('Erreur r√©seau (' + res.status + ')');
      const data = await res.json();
      if (!data || data.status !== 1) {
        showError('Produit introuvable sur Open Food Facts. Tu peux l‚Äôajouter manuellement (le code-barres sera conserv√©).');
        if (cfBarcode) cfBarcode.value = code; return;
      }
      const obj = normalizeOFF(data); showResult(obj); if (cfBarcode) cfBarcode.value = code;
    } catch (e) { console.error(e); showError('Erreur lors de la recherche. R√©essaie.'); }
    finally { elSearch.disabled = false; elSearch.textContent = 'üîé Rechercher'; }
  }

  document.getElementById('off_search').addEventListener('click', doLookup);
  elCode.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); doLookup(); } });
  document.getElementById('off_clear').addEventListener('click', () => { elCode.value = ''; clearError(); clearResult(); });
  document.getElementById('off_paste').addEventListener('click', async () => {
    try { const t = await navigator.clipboard.readText(); elCode.value = (t || '').replace(/\D+/g, ''); doLookup(); }
    catch { showError('Impossible de lire le presse-papiers.'); }
  });

  /* Scanner live (BarcodeDetector + ZXing) */
  const dlgScan = document.getElementById('scan-modal'), scanVideo = document.getElementById('scan-video'), btnScanClose = document.getElementById('scan-close');
  let scanning = false, zxingReader = null, zxingLiveActive = false;

  async function onBarcodeDetected(code) { if (!code) return; elCode.value = code.replace(/\D+/g, ''); await closeScanModal(); doLookup(); }

  async function openScanModal() {
    if (!dlgScan) return; dlgScan.showModal(); scanning = true;
    scanVideo.muted = true; scanVideo.playsInline = true; scanVideo.setAttribute('playsinline', ''); scanVideo.setAttribute('webkit-playsinline', '');
    if ('BarcodeDetector' in window) {
      try {
        const detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e'] });
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        scanVideo.srcObject = stream; try { await scanVideo.play(); } catch (_) { }
        const tick = async () => {
          if (!scanning) return;
          try {
            const bm = await detector.detect(scanVideo);
            if (bm && bm[0] && bm[0].rawValue) { await onBarcodeDetected(bm[0].rawValue); return; }
          } catch { }
          requestAnimationFrame(tick);
        };
        tick(); return;
      } catch (e) { /* fallback */ }
    }
    startZXingLive();
  }
  async function closeScanModal() {
    scanning = false; if (dlgScan && dlgScan.open) dlgScan.close();
    const s = scanVideo && (scanVideo.srcObject); if (s && s.getTracks) s.getTracks().forEach(t => t.stop());
    if (zxingReader && zxingLiveActive) { try { await zxingReader.reset(); } catch { } zxingLiveActive = false; }
  }
  async function loadZXing() {
    return new Promise((resolve, reject) => {
      if (window.ZXing) return resolve(window.ZXing);
      const s = document.createElement('script'); s.src = 'https://unpkg.com/@zxing/library@latest';
      s.onload = () => resolve(window.ZXing); s.onerror = () => reject(new Error('ZXing indisponible')); document.head.appendChild(s);
    });
  }
  async function startZXingLive() {
    try {
      scanVideo.muted = true; scanVideo.playsInline = true; scanVideo.setAttribute('playsinline', ''); scanVideo.setAttribute('webkit-playsinline', '');
      if (!window.ZXing) await loadZXing();
      if (!zxingReader) zxingReader = new ZXing.BrowserMultiFormatReader();
      zxingReader.decodeFromVideoDevice(undefined, scanVideo, async (result, err) => {
        if (!scanning) return;
        if (result && result.getText) {
          const code = (result.getText() || '').replace(/\D+/g, '');
          if (code) await onBarcodeDetected(code);
        }
      });
      zxingLiveActive = true; scanning = true;
    } catch (e) { showError("Impossible de d√©marrer le flux live. Utilise ¬´ Prendre une photo ¬ª."); }
  }
  document.getElementById('off_scan').addEventListener('click', openScanModal);
  btnScanClose.addEventListener('click', closeScanModal);

  /* Mode Photo universel */
  document.getElementById('off_capture').addEventListener('click', () => document.getElementById('off_file').click());
  document.getElementById('off_file').addEventListener('change', async (ev) => {
    const file = ev.target.files && ev.target.files[0]; if (!file) return;
    try {
      if (!window.ZXing) await loadZXing();
      if (!zxingReader) zxingReader = new ZXing.BrowserMultiFormatReader();
      const imgURL = URL.createObjectURL(file);
      const img = document.createElement('img'); img.src = imgURL; await img.decode();
      const res = await zxingReader.decodeFromImageElement(img);
      const code = res && res.getText ? (res.getText() || '').replace(/\D+/g, '') : '';
      if (code) await onBarcodeDetected(code); else showError('Aucun code d√©tect√© sur la photo.');
    } catch (e) { showError('Erreur lecture de la photo.'); }
    finally { ev.target.value = ''; }
  });

  /* Toggle "Plus d'infos" mobile */
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.js-card-toggle'); if (!btn) return;
    const id = btn.getAttribute('aria-controls'); const panel = document.getElementById(id); if (!panel) return;
    const open = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', String(!open));
    panel.hidden = open;
    const label = btn.querySelector('span:first-child'); if (label) label.textContent = open ? 'Plus d‚Äôinfos' : 'Moins d‚Äôinfos';
  });
</script>
{% endblock %}
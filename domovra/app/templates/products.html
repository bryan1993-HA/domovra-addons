{% extends "base.html" %}
{% block title %}Domovra ‚Äî Fiche produit{% endblock %}

{% block head %}{% endblock %}

{% block header_right %}
<span class="chip">üóÇÔ∏è Fiches produit : <b>{{ items|length }}</b></span>
{% endblock %}

{% block content %}
<div class="wrap" data-page="product">

  <!-- Ajouter un produit -->
  <div class="card">
    <div class="title">
      <h2>Ajouter un produit</h2>
      <span class="muted">‚Üí cr√©er une fiche produit compl√®te</span>
    </div>

    <!-- grille (conserve ta classe pour r√©utiliser ton CSS) -->
    <form id="create_form" method="post" action="{{ BASE }}product/add" class="add-product-form">

      <!-- Nom & Description -->
      <div class="field" style="grid-column:1 / -1">
        <div class="label">Nom du produit <span class="help" tabindex="0" data-tip="Nom court et explicite."></span>
        </div>
        <input name="name" id="create_name" type="text" required placeholder="ex. P√¢tes, Lait demi-√©cr√©m√©">
      </div>

      <div class="field" style="grid-column:1 / -1">
        <div class="label">Description <span class="help" tabindex="0" data-tip="ex. Brique UHT, 6√ó1 L, marque‚Ä¶"></span>
        </div>
        <textarea name="description" id="create_desc" rows="2" placeholder="ex. Brique UHT, 6√ó1 L, marque‚Ä¶"></textarea>
      </div>

      <!-- Ligne 1 -->
      <div class="field">
        <div class="label">Emplacement par d√©faut <span class="help" tabindex="0"
            data-tip="L√† o√π tu ranges habituellement ce produit."></span></div>
        <select name="default_location_id" id="create_default_location_id">
          <option value="">‚Äî Aucun (choisir √† l‚Äôajout en stock) ‚Äî</option>
          {% for loc in locations or [] %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="field">
        <div class="label">Unit√© par d√©faut</div>
        <select name="unit" id="create_unit">
          <optgroup label="Comptage">
            <option value="pi√®ce" selected>pi√®ce</option>
            <option value="tranche">tranche</option>
            <option value="paquet">paquet</option>
            <option value="bo√Æte">bo√Æte</option>
            <option value="bocal">bocal</option>
            <option value="bouteille">bouteille</option>
            <option value="sachet">sachet</option>
            <option value="lot">lot</option>
            <option value="barquette">barquette</option>
            <option value="rouleau">rouleau</option>
            <option value="dosette">dosette</option>
          </optgroup>
          <optgroup label="Poids">
            <option value="g">g</option>
            <option value="kg">kg</option>
          </optgroup>
          <optgroup label="Volume">
            <option value="ml">ml</option>
            <option value="L">L</option>
          </optgroup>
        </select>
      </div>

      <div class="field">
        <div class="label">Cat√©gorie de produits</div>
        <select name="category" id="create_category">
          <option value="">‚Äî Choisir une cat√©gorie ‚Äî</option>

          <optgroup label="Alimentation">
            <option>Fruits & l√©gumes</option>
            <option>Viande</option>
            <option>Poisson & fruits de mer</option>
            <option>Produits laitiers</option>
            <option>≈íufs</option>
            <option>Charcuterie</option>
            <option>Fromages</option>
            <option>Boulangerie & p√¢tisserie</option>
            <option>C√©r√©ales, p√¢tes & riz</option>
            <option>√âpicerie sal√©e</option>
            <option>√âpicerie sucr√©e</option>
            <option>Conserves & bocaux</option>
            <option>Condiments & sauces</option>
            <option>Huiles & vinaigres</option>
            <option>Boissons</option>
            <option>Surgel√©s</option>
            <option>Bio / Sans gluten</option>
          </optgroup>

          <optgroup label="Non alimentaire">
            <option>Hygi√®ne & beaut√©</option>
            <option>Entretien & m√©nager</option>
            <option>Animaux</option>
            <option>B√©b√©</option>
            <option>Autre</option>
          </optgroup>
        </select>
      </div>


      <!-- Ligne 2 -->
      <div class="field">
        <div class="label">Quantit√© minimum en stock <span class="help" tabindex="0"
            data-tip="Seuil d‚Äôalerte propre √† ce produit."></span></div>
        <div class="infield-qty">
          <input name="min_qty" id="create_min_qty" type="number" min="0" step="any" placeholder="ex. 1"
            value="{{ SETTINGS.low_stock_default }}">
          <span id="create_min_unit" class="suffix">pi√®ce</span>
        </div>
        <div class="hint muted" id="create_min_hint">Conseil : 1, 2, 3 pi√®ces‚Ä¶</div>
      </div>

      <div class="field">
        <div class="label">Alerte stock faible actif ?</div>
        <select name="low_stock_enabled" id="create_low_enabled">
          <option value="1" selected>Oui</option>
          <option value="0">Non</option>
        </select>
      </div>

      <div class="field">
        <div class="label">Produit parent</div>
        <select name="parent_id" id="create_parent">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for p in parents or [] %}
          <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Ligne 3 -->
      <div class="field">
        <div class="label">Type d‚Äô√©ch√©ance</div>
        <div class="segmented">
          <label><input type="radio" name="expiry_kind" value="DLC" checked><span>DLC</span></label>
          <label><input type="radio" name="expiry_kind" value="DDM"><span>DDM</span></label>
        </div>
      </div>

      <div class="field">
        <div class="label">P√©remption par d√©faut (jours)</div>
        <input name="shelf" id="create_shelf" type="number" min="1" placeholder="ex. 90">
      </div>

      <div class="field no-freeze-cell">
        <label class="checkbox-inline">
          <input type="checkbox" id="create_no_freeze" name="no_freeze" value="1">
          <span>Ne doit pas √™tre congel√©</span>
        </label>
      </div>

      <div class="field" id="create_freeze_group">
        <div class="label">P√©remption apr√®s cong√©lation (jours)</div>
        <input name="default_freeze_shelf_days" id="create_freeze_shelf" type="number" min="1" placeholder="ex. 180">
      </div>

      <!-- Bouton -->
      <div class="field btn-wide">
        <button class="secondary" type="submit">Ôºã Ajouter</button>
      </div>
    </form>
  </div>

  <!-- Outils -->
  <div class="card">
    <div class="title">
      <h2>Outils</h2>
      <span class="muted">
        Recherche
        <span class="help" tabindex="0" aria-label="Aide recherche" data-tip="
Exemples :
‚Ä¢ nom : lait, chorizo, p√¢tes
‚Ä¢ cat√©gorie : produits laitiers
‚Ä¢ unit√© : g, L, ml
‚Ä¢ p√©remption : dlc, ddm
‚Ä¢ cong√©lation : interdit
‚Ä¢ code-barres : 3029330003533
Astuce : tu peux combiner (ex. ¬´ ddm produits laitiers ¬ª)."></span>
      </span>
    </div>

    <div class="row tools-row" style="align-items:center">
      <input id="q" type="search" placeholder="Rechercher une fiche produit‚Ä¶" />
    </div>
  </div>

  <!-- === Liste (CARTES UNIQUEMENT) ===================================== -->

  <div class="card">
    <div class="title">
      <h2>Fiches produit</h2><span class="muted">Cartes</span>
    </div>

    <div id="cardsGrid" class="cards-grid">
      {% for it in items %}
      {% set threshold = it.min_qty if it.min_qty is not none else SETTINGS.low_stock_default %}
      {% set is_low = (it.qty_total < (it.min_qty if it.min_qty is not none else 0) and (it.min_qty is not none)) %}
        <article class="prod-card"
        data-name="{{ (it.name ~ ' ' ~ (it.category or '') ~ ' ' ~ (it.unit or '') ~ ' ' ~ (it.barcode or ''))|lower }}"
        data-barcode="{{ (it.barcode or '')|lower }}" data-category="{{ (it.category or '')|lower }}"
        data-unit="{{ (it.unit or '')|lower }}" data-expiry="{{ (it.expiry_kind or 'DLC')|lower }}" {# "dlc" ou "ddm" #}
        data-freeze="{{ 1 if (it.no_freeze or 0)!=0 else 0 }}" {# 1=interdit de congeler #}
        data-location="{{ (loc_map.get((it.default_location_id|string)) or '')|lower if it.default_location_id else '' }}"
        data-lots="{{ it.lots_count|int }}" data-qty="{{ '%.3f'|format(it.qty_total) }}"
        data-hasbarcode="{{ 1 if it.barcode else 0 }}"
        data-low="{{ 1 if (it.min_qty is not none and it.qty_total < it.min_qty) else 0 }}">
        <header class="pc-head">
          <div class="pc-title">
            <h3 class="pc-name">{{ it.name }}</h3>
            {% if it.category %}<span class="pill">{{ it.category }}</span>{% endif %}
            {% if is_low %}<span class="pill danger">üîª Faible stock</span>{% endif %}
          </div>
          <div class="pc-sub muted">
            {{ it.unit }} / {{ it.expiry_kind or 'DLC' }}
            {% if it.no_freeze %} / ‚ùÑÔ∏è interdit{% endif %}
          </div>
        </header>

        <div class="pc-body">
          <div class="stat"><span class="k">Stocks</span><span class="v">{{ it.lots_count }}</span></div>
          {% set Q = fmt_qty(it.qty_total, it.unit) %}
          <div class="stat">
            <span class="k">Qt√© totale</span>
            <span class="v">{{ Q.v }} {{ (Q.u or it.unit)|pluralize_fr(Q.v) }}</span>
          </div>
          {% if it.min_qty is not none %}
          <div class="stat"><span class="k">Seuil min</span><span class="v">{{ it.min_qty|pretty_num }}</span></div>
          {% endif %}
          {% if it.default_location_id %}
          <div class="stat"><span class="k">üìç Emplacement</span><span class="v">
              {{ loc_map.get((it.default_location_id|string)) or '‚Äî' }}
            </span></div>
          {% endif %}
          <div class="stat"><span class="k">Conservation (par d√©faut)</span><span class="v">{{
              it.default_shelf_life_days }} j</span></div>
          {% if it.barcode %}<div class="stat"><span class="k">EAN</span><span class="v">{{ it.barcode }}</span></div>{%
          endif %}
          {% if it.description %}<div class="stat full"><span class="k">Description</span><span class="v">{{
              it.description }}</span></div>{% endif %}
        </div>

        <footer class="pc-actions">
          <button class="secondary js-view-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-category="{{ it.category or '' }}" data-unit="{{ it.unit or '' }}"
            data-expiry-kind="{{ it.expiry_kind or 'DLC' }}" data-no-freeze="{{ 1 if (it.no_freeze or 0)!=0 else 0 }}"
            data-shelf="{{ it.default_shelf_life_days or '' }}"
            data-default-location="{{ it.default_location_id or '' }}" data-barcode="{{ it.barcode or '' }}"
            data-min="{{ it.min_qty if it.min_qty is not none else '' }}" data-desc="{{ it.description or '' }}"
            data-lots="{{ it.lots_count|int }}" data-qty="{{ '%.2f'|format(it.qty_total) }}">
            üëÅÔ∏è Voir
          </button>

          <button class="secondary js-edit-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-desc="{{ it.description or '' }}" data-default-location="{{ it.default_location_id or '' }}"
            data-min="{{ it.min_qty if it.min_qty is not none else '' }}"
            data-low-enabled="{{ 1 if (it.low_stock_enabled is not none and it.low_stock_enabled!=0) else 0 }}"
            data-expiry-kind="{{ (it.expiry_kind or 'DLC') }}" data-shelf="{{ it.default_shelf_life_days or '' }}"
            data-freeze-shelf="{{ it.default_freeze_shelf_days or '' }}"
            data-no-freeze="{{ 1 if (it.no_freeze is not none and it.no_freeze!=0) else 0 }}"
            data-category="{{ it.category or '' }}" data-unit="{{ it.unit or 'pi√®ce' }}"
            data-parent="{{ it.parent_id or '' }}">
            ‚úèÔ∏è Modifier
          </button>

          <button class="secondary js-delete-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-lots="{{ it.lots_count|int }}">
            üóëÔ∏è Supprimer
          </button>
        </footer>
        </article>
        {% endfor %}
    </div>
  </div>

</div>

<!-- ===== Dialogs ======================================================= -->

<!-- Voir (fiche compl√®te, lecture seule) -->
<dialog id="dlg-view">
  <div style="display:grid;gap:14px;min-width:min(820px,96vw)">
    <div class="tabs compact">
      <button class="tab active" type="button">Aper√ßu du produit</button>
      <a class="tab" id="v-tab-in" href="#">Entr√©es du stock</a>
      <a class="tab" id="v-tab-journal" href="#">Journal du stock</a>
      <span style="margin-left:auto" class="muted">üõí üßæ</span>
    </div>

    <h2 id="v-name" style="text-align:center;margin:0">‚Äî</h2>

    <div class="kv">
      <div><b>Quantit√© en stock :</b> <span id="v-qty">‚Äî</span></div>
      <div><b>Valeur du stock :</b> <span class="muted">‚Äî (non suivi)</span></div>
      <div><b>Emplacement par d√©faut :</b> <span id="v-loc">‚Äî</span></div>
      <div><b>Dernier achat :</b> <span id="v-last-in">Jamais</span></div>
      <div><b>Derni√®re utilisation :</b> <span id="v-last-out">Jamais</span></div>
      <div><b>Dernier prix :</b> <span class="muted">‚Äî</span></div>
      <div><b>stock moyen :</b> <span class="muted">‚Äî</span></div>
      <div><b>Dur√©e moyenne de conservation :</b> <span id="v-avg-shelf">‚Äî</span></div>
      <div><b>Taux de p√©remption :</b> <span id="v-expired-rate">‚Äî</span></div>
    </div>

    <div>
      <h3 style="margin:8px 0 6px">Historique des prix</h3>
      <div class="muted" style="border:1px dashed var(--line);border-radius:10px;padding:12px">
        Suivi des prix non activ√© dans Domovra V1 (sera aliment√© via la page Stock).
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-view').close()">Fermer</button>
    </div>
  </div>
</dialog>


<!-- √âditer -->
<dialog id="dlg-edit">
  <form method="post" action="{{ BASE }}product/update" style="display:grid;gap:10px;min-width:min(680px,96vw)">
    <h3 style="margin:0">Modifier la fiche produit</h3>
    <input type="hidden" name="product_id" id="dlg-product-id">

    <div>
      <div class="label">Nom</div>
      <input type="text" name="name" id="dlg-name" required>
    </div>

    <div>
      <div class="label">Description</div>
      <textarea name="description" id="dlg-desc" rows="2"></textarea>
    </div>

    <div class="row" style="gap:10px">
      <div style="flex:1">
        <div class="label">Emplacement par d√©faut</div>
        <select name="default_location_id" id="dlg-default-location">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for loc in locations or [] %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div style="flex:1">
        <div class="label">Unit√©</div>
        <select name="unit" id="dlg-unit">
          <optgroup label="Comptage">
            <option value="pi√®ce">pi√®ce</option>
            <option value="tranche">tranche</option>
            <option value="paquet">paquet</option>
            <option value="bo√Æte">bo√Æte</option>
            <option value="bocal">bocal</option>
            <option value="bouteille">bouteille</option>
            <option value="sachet">sachet</option>
            <option value="lot">lot</option>
            <option value="barquette">barquette</option>
            <option value="rouleau">rouleau</option>
            <option value="dosette">dosette</option>
          </optgroup>
          <optgroup label="Poids">
            <option value="g">g</option>
            <option value="kg">kg</option>
          </optgroup>
          <optgroup label="Volume">
            <option value="ml">ml</option>
            <option value="L">L</option>
          </optgroup>
        </select>
      </div>

      <div style="flex:1">
        <div class="label">Quantit√© minimum en stock</div>
        <div class="infield-qty">
          <input name="min_qty" id="dlg-min" type="number" min="0" step="any" placeholder="ex. 1">
          <span class="suffix" id="dlg_min_unit">pi√®ce</span>
        </div>
      </div>
    </div>

    <div class="row" style="gap:10px">
      <div style="flex:1">
        <div class="label">Alerte stock faible actif ?</div>
        <select name="low_stock_enabled" id="dlg-low-enabled">
          <option value="1">Oui</option>
          <option value="0">Non</option>
        </select>
      </div>

      <div style="flex:1">
        <div class="label">Type d‚Äô√©ch√©ance</div>
        <div>
          <label style="margin-right:10px"><input type="radio" name="expiry_kind" id="dlg-exp-dlc" value="DLC">
            DLC</label>
          <label><input type="radio" name="expiry_kind" id="dlg-exp-ddm" value="DDM"> DDM</label>
        </div>
      </div>

      <div style="flex:1">
        <div class="label">P√©remption par d√©faut (jours)</div>
        <input type="number" name="shelf" id="dlg-shelf" min="1" placeholder="ex. 90">
      </div>
    </div>

    <div class="row" style="gap:10px">
      <div style="flex:1">
        <label class="label" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="dlg-no-freeze" name="no_freeze" value="1">
          Ne doit pas √™tre congel√©
        </label>
      </div>

      <div style="flex:1" id="dlg-freeze-group">
        <div class="label">P√©remption apr√®s cong√©lation (jours)</div>
        <input type="number" name="default_freeze_shelf_days" id="dlg-freeze-shelf" min="1" placeholder="ex. 180">
      </div>

      <div style="flex:1">
        <div class="label">Cat√©gorie</div>
        <select name="category" id="dlg-category">
          <option value="">‚Äî Choisir une cat√©gorie ‚Äî</option>

          <optgroup label="Alimentation">
            <option>Fruits & l√©gumes</option>
            <option>Viande</option>
            <option>Poisson & fruits de mer</option>
            <option>Produits laitiers</option>
            <option>≈íufs</option>
            <option>Charcuterie</option>
            <option>Fromages</option>
            <option>Boulangerie & p√¢tisserie</option>
            <option>C√©r√©ales, p√¢tes & riz</option>
            <option>√âpicerie sal√©e</option>
            <option>√âpicerie sucr√©e</option>
            <option>Conserves & bocaux</option>
            <option>Condiments & sauces</option>
            <option>Huiles & vinaigres</option>
            <option>Boissons</option>
            <option>Surgel√©s</option>
            <option>Bio / Sans gluten</option>
          </optgroup>

          <optgroup label="Non alimentaire">
            <option>Hygi√®ne & beaut√©</option>
            <option>Entretien & m√©nager</option>
            <option>Animaux</option>
            <option>B√©b√©</option>
            <option>Autre</option>
          </optgroup>
        </select>
      </div>


      <div>
        <div class="label">Produit parent</div>
        <select name="parent_id" id="dlg-parent">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for p in parents or [] %}
          <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="row" style="justify-content:flex-end;gap:8px">
        <button type="button" onclick="document.getElementById('dlg-edit').close()">Annuler</button>
        <button class="secondary">Enregistrer</button>
      </div>
  </form>
</dialog>

<!-- Supprimer -->
<dialog id="dlg-delete">
  <form method="post" action="{{ BASE }}product/delete" style="display:grid;gap:10px;min-width:min(420px,92vw)">
    <h3 style="margin:0">Supprimer le produit</h3>
    <input type="hidden" name="product_id" id="del-product-id">
    <div class="muted" id="del-msg">La suppression retirera aussi les stocks li√©s √† ce produit.</div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-delete').close()">Annuler</button>
      <button class="secondary" style="background:var(--danger);border:0;color:#1d0c0c">Supprimer</button>
    </div>
  </form>
</dialog>

{% endblock %}

{% block scripts %}
<script type="application/json" id="loc-map-data">
  {{ loc_map | tojson }}
</script>

<script>
  /* ====== Recherche intelligente (cartes) ======
     Exemples : ddm -has:barcode qty>0 | cat:"Produits laitiers" u:g is:low | loc:Frigo -nofreeze
     ‚ö†Ô∏é n√©cessite des data-attributes sur .prod-card : category, unit, expiry, freeze, location, lots, qty, hasbarcode, low
  */
  const q = document.getElementById('q');
  const grid = document.getElementById('cardsGrid');
  const cards = Array.from(grid ? grid.children : []);

  function tokenize(str) {
    const tokens = [];
    let cur = '', inQ = false;
    for (let i = 0; i < str.length; i++) {
      const c = str[i];
      if (c === '"') { inQ = !inQ; continue; }
      if (!inQ && /\s/.test(c)) { if (cur) { tokens.push(cur); cur = ''; } }
      else { cur += c; }
    }
    if (cur) tokens.push(cur);
    return tokens;
  }

  function parseQuery(qs) {
    const raw = (qs || '').trim().toLowerCase();
    if (!raw) return { text: [], filters: [], excludes: [] };

    const tokens = tokenize(raw);
    const text = [];
    const filters = [];
    const excludes = [];

    const pushFilter = (arr, key, op, val) => arr.push({ key, op, val });

    tokens.forEach(tok => {
      let t = tok, neg = false;
      if (t.startsWith('-')) { neg = true; t = t.slice(1); }

      if (t === 'dlc' || t === 'ddm') {
        pushFilter(neg ? excludes : filters, 'expiry', '==', t); return;
      }
      if (t === 'nofreeze' || t === 'freeze:no') {
        pushFilter(neg ? excludes : filters, 'freeze', '==', 1); return;
      }
      if (t === 'freeze:yes') {
        pushFilter(neg ? excludes : filters, 'freeze', '==', 0); return;
      }
      if (t === 'is:low' || t === 'low') {
        pushFilter(neg ? excludes : filters, 'low', '==', 1); return;
      }
      if (t === 'has:barcode') {
        pushFilter(neg ? excludes : filters, 'hasbarcode', '==', 1); return;
      }

      const m = t.match(/^([a-z]+)([=<>]{1,2})?(.*)$/);
      if (m) {
        let [, key, op, val] = m;
        key = key.trim(); op = (op || '==').trim(); val = (val || '').trim();
        if (val.startsWith(':')) val = val.slice(1);

        if (key === 'cat') key = 'category';
        if (key === 'u') key = 'unit';
        if (key === 'loc') key = 'location';
        if (key === 'ean') key = 'barcode';

        if (key === 'freeze') val = (/^(1|yes|true|on)$/i.test(val)) ? 1 : 0;
        if (['lots', 'qty'].includes(key)) {
          val = parseFloat(val.replace(',', '.'));
          if (Number.isNaN(val)) return;
        }
        pushFilter(neg ? excludes : filters, key, op, val);
        return;
      }

      text.push(t);
    });

    return { text, filters, excludes };
  }

  function matchesOps(num, op, val) {
    if (typeof num !== 'number' || Number.isNaN(num)) return false;
    switch (op) {
      case '>': return num > val;
      case '>=': return num >= val;
      case '<': return num < val;
      case '<=': return num <= val;
      case '!=': return num != val; // eslint-disable-line eqeqeq
      case '==':
      default: return num == val; // eslint-disable-line eqeqeq
    }
  }

  function cardMatches(card, query) {
    const txt = (card.dataset.name || '');

    for (const t of query.text) {
      if (!txt.includes(t)) return false;
    }

    const ds = card.dataset;

    for (const f of query.filters) {
      const k = f.key, op = f.op, v = f.val;
      switch (k) {
        case 'category':
        case 'unit':
        case 'location':
        case 'barcode':
        case 'expiry':
          if (!String(ds[k] || '').includes(String(v))) return false;
          break;

        case 'freeze':
        case 'low':
        case 'hasbarcode': {
          const cur = parseInt(ds[k] || '0', 10) || 0;
          if (!matchesOps(cur, op, parseInt(v, 10))) return false;
          break;
        }

        case 'lots': {
          const cur = parseInt(ds.lots || '0', 10) || 0;
          if (!matchesOps(cur, op, v)) return false;
          break;
        }
        case 'qty': {
          const cur = parseFloat(ds.qty || '0') || 0;
          if (!matchesOps(cur, op, v)) return false;
          break;
        }

        default:
          if (!txt.includes(String(v))) return false;
      }
    }

    for (const f of query.excludes) {
      const k = f.key, op = f.op, v = f.val;
      let hit = false;
      switch (k) {
        case 'category':
        case 'unit':
        case 'location':
        case 'barcode':
        case 'expiry':
          hit = String(ds[k] || '').includes(String(v)); break;
        case 'freeze':
        case 'low':
        case 'hasbarcode':
          hit = matchesOps(parseInt(ds[k] || '0', 10) || 0, op, parseInt(v, 10)); break;
        case 'lots':
          hit = matchesOps(parseInt(ds.lots || '0', 10) || 0, op, v); break;
        case 'qty':
          hit = matchesOps(parseFloat(ds.qty || '0') || 0, op, v); break;
        default:
          hit = txt.includes(String(v));
      }
      if (hit) return false;
    }

    return true;
  }

  let searchTimer = null;
  function runSmartSearch(qs) {
    const query = parseQuery(qs);
    let shown = 0;
    cards.forEach(card => {
      const ok = cardMatches(card, query);
      card.style.display = ok ? '' : 'none';
      if (ok) shown++;
    });
    const chip = document.querySelector('[data-page="product"] .chip b');
    if (chip) chip.textContent = String(qs ? shown : cards.length);
  }

  if (q) {
    q.placeholder = 'Ex.  ddm -has:barcode qty>0   |   cat:"Produits laitiers" u:g is:low';
    q.addEventListener('input', (e) => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => runSmartSearch(e.target.value), 120);
    });
  }

  /* ====== Helpers communs ====== */
  const $ = s => document.querySelector(s);

  // Config par unit√© (step visuel, suffixe, placeholder, hint)
  const UNIT_CFG = {
    'pi√®ce': { step: 1, suffix: 'pi√®ce', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 pi√®ces‚Ä¶' },
    'tranche': { step: 1, suffix: 'tranche', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 tranches‚Ä¶' },
    'paquet': { step: 1, suffix: 'paquet', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 paquets‚Ä¶' },
    'bo√Æte': { step: 1, suffix: 'bo√Æte', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 bo√Ætes‚Ä¶' },
    'boite': { step: 1, suffix: 'bo√Æte', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 bo√Ætes‚Ä¶' },
    'bocal': { step: 1, suffix: 'bocal', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 bocaux‚Ä¶' },
    'bouteille': { step: 1, suffix: 'bouteille', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 bouteilles‚Ä¶' },
    'sachet': { step: 1, suffix: 'sachet', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 sachets‚Ä¶' },
    'lot': { step: 1, suffix: 'lot', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 lots‚Ä¶' },
    'barquette': { step: 1, suffix: 'barquette', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 barquettes‚Ä¶' },
    'rouleau': { step: 1, suffix: 'rouleau', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 rouleaux‚Ä¶' },
    'dosette': { step: 1, suffix: 'dosette', placeholder: 'ex. 1', hint: 'Conseil : 1, 2, 3 dosettes‚Ä¶' },
    'g': { step: 50, suffix: 'g', placeholder: 'ex. 500', hint: 'Par 50 g (500 g, 750 g, ‚Ä¶)' },
    'kg': { step: 0.1, suffix: 'kg', placeholder: 'ex. 0.5', hint: 'Par 0,1 kg (0,5 kg, 1,0 kg, ‚Ä¶)' },
    'ml': { step: 50, suffix: 'ml', placeholder: 'ex. 500', hint: 'Par 50 ml (500 ml, 750 ml, ‚Ä¶)' },
    'L': { step: 1, suffix: 'L', placeholder: 'ex. 1', hint: 'Par 1 L (1 L, 2 L, ‚Ä¶)' },
    'l': { step: 1, suffix: 'L', placeholder: 'ex. 1', hint: 'Par 1 L (1 L, 2 L, ‚Ä¶)' },
  };
  function cfgForUnit(u) {
    const key = String(u || 'pi√®ce');
    return UNIT_CFG[key] || { step: 1, suffix: (u || 'pi√®ce'), placeholder: 'ex. 1', hint: '' };
  }

  function setSelectValue(sel, val) {
    if (!sel || sel.tagName !== 'SELECT') return;
    [...sel.querySelectorAll('option[data-temp="1"]')].forEach(o => o.remove());
    const opts = [...sel.options].map(o => o.value);
    if (opts.includes(val)) sel.value = val;
    else if (val) {
      const o = document.createElement('option');
      o.value = val; o.textContent = val + ' (autre)'; o.dataset.temp = '1';
      sel.insertBefore(o, sel.firstChild); sel.value = val;
    }
  }

  /* ====== Voir (fiche compl√®te, lecture seule) ====== */
  let locMap = {};
  try {
    const raw = document.getElementById('loc-map-data')?.textContent || '{}';
    locMap = JSON.parse(raw);
  } catch { locMap = {}; }

  function humanizeDate(iso) {
    if (!iso) return 'Jamais';
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    const today = new Date();
    const diff = Math.floor((today - d) / 86400000);
    if (diff <= 0) return "aujourd‚Äôhui";
    if (diff === 1) return "hier";
    return `${iso}  ¬∑  il y a ${diff} jour${diff > 1 ? 's' : ''}`;
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.js-view-open');
    if (!btn) return;

    const name = btn.dataset.name || 'Fiche produit';
    const unit = btn.dataset.unit || '';
    const qty = btn.dataset.qty || '0';
    const lots = btn.dataset.lots || '0';
    const loc = locMap[btn.dataset.defaultLocation || ''] || '‚Äî';

    const lastIn = humanizeDate(btn.dataset.lastIn || '');
    const lastOut = humanizeDate(btn.dataset.lastOut || '');

    const avgShelf = btn.dataset.avgShelf && btn.dataset.avgShelf !== '0' ? `${btn.dataset.avgShelf} j` : '‚Äî';
    const expRate = btn.dataset.expiredRate && btn.dataset.expiredRate !== '0' ? `${btn.dataset.expiredRate}%` : '0 %';

    document.getElementById('v-name').textContent = name;
    document.getElementById('v-qty').textContent =
      `${qty} ${unit}${Number(qty) == 1 ? '' : 's'} (${lots} lot${Number(lots) == 1 ? '' : 's'})`;
    document.getElementById('v-loc').textContent = loc;
    document.getElementById('v-last-in').textContent = lastIn;
    document.getElementById('v-last-out').textContent = lastOut;
    document.getElementById('v-avg-shelf').textContent = avgShelf;
    document.getElementById('v-expired-rate').textContent = expRate;

    const encoded = encodeURIComponent(name);
    const linkIn = document.getElementById('v-tab-in');
    const linkJ = document.getElementById('v-tab-journal');
    if (linkIn) linkIn.href = '{{ BASE }}lots?product=' + encoded;
    if (linkJ) linkJ.href = '{{ BASE }}journal';

    document.getElementById('dlg-view').showModal();
  });

  /* ====== AJOUT : logique d‚Äôunit√© -> min_qty (step visuel + hint) ====== */
  (function setupCreateFormUnitLogic() {
    const unitSel = document.getElementById('create_unit');
    const minInput = document.getElementById('create_min_qty');
    const minSuffix = document.getElementById('create_min_unit');
    const minHint = document.getElementById('create_min_hint');
    const noFreeze = document.getElementById('create_no_freeze');
    const freezeGrp = document.getElementById('create_freeze_group');

    function applyCreateMinUnitLogic() {
      const u = unitSel?.value || 'pi√®ce';
      const cfg = cfgForUnit(u);

      if (minInput) {
        minInput.setAttribute('step', 'any');           // autorise tout
        minInput.dataset.stepCustom = String(cfg.step); // pas pour fl√®ches
        minInput.placeholder = cfg.placeholder;
      }
      if (minSuffix) minSuffix.textContent = cfg.suffix;
      if (minHint) minHint.textContent = cfg.hint || '';
    }

    function applyCreateFreezeVisibility() {
      if (!noFreeze || !freezeGrp) return;
      freezeGrp.style.display = noFreeze.checked ? 'none' : '';
    }

    if (unitSel) unitSel.addEventListener('change', applyCreateMinUnitLogic);
    if (noFreeze) noFreeze.addEventListener('change', applyCreateFreezeVisibility);

    applyCreateMinUnitLogic();
    applyCreateFreezeVisibility();
  })();

  /* ====== √âDITION : logique d‚Äôunit√© -> min_qty (step visuel) ====== */
  function applyDlgMinUnitLogic() {
    const unit = $('#dlg-unit')?.value || 'pi√®ce';
    const minInput = $('#dlg-min');
    const unitSuffix = $('#dlg_min_unit');
    if (!minInput || !unitSuffix) return;

    const cfg = cfgForUnit(unit);
    minInput.setAttribute('step', 'any');
    minInput.dataset.stepCustom = String(cfg.step);
    minInput.placeholder = cfg.placeholder;
    unitSuffix.textContent = cfg.suffix;
  }
  function applyDlgFreezeVisibility() {
    const nf = $('#dlg-no-freeze');
    const grp = $('#dlg-freeze-group');
    if (!nf || !grp) return;
    grp.style.display = nf.checked ? 'none' : '';
  }

  document.addEventListener('click', function (e) {
    const edit = e.target.closest('.js-edit-open');
    const del = e.target.closest('.js-delete-open');

    if (edit) {
      $('#dlg-product-id').value = edit.dataset.id || '';
      $('#dlg-name').value = edit.dataset.name || '';
      $('#dlg-desc').value = edit.dataset.desc || '';

      setSelectValue($('#dlg-default-location'), edit.dataset.defaultLocation || '');
      setSelectValue($('#dlg-unit'), edit.dataset.unit || 'pi√®ce');
      setSelectValue($('#dlg-low-enabled'), (edit.dataset.lowEnabled === '0' ? '0' : '1'));
      const cat = $('#dlg-category'); if (cat) cat.value = edit.dataset.category || '';
      setSelectValue($('#dlg-parent'), edit.dataset.parent || '');

      $('#dlg-min').value = (edit.dataset.min || '');
      $('#dlg-shelf').value = (edit.dataset.shelf || '');
      $('#dlg-freeze-shelf').value = (edit.dataset.freezeShelf || '');

      const kind = (edit.dataset.expiryKind || 'DLC').toUpperCase();
      $('#dlg-exp-dlc').checked = (kind === 'DLC');
      $('#dlg-exp-ddm').checked = (kind === 'DDM');

      const nf = $('#dlg-no-freeze'); if (nf) nf.checked = (edit.dataset.noFreeze === '1');

      applyDlgFreezeVisibility();
      applyDlgMinUnitLogic();

      const unitSel = $('#dlg-unit');
      if (unitSel) unitSel.addEventListener('change', applyDlgMinUnitLogic);
      if (nf) nf.addEventListener('change', applyDlgFreezeVisibility);

      $('#dlg-edit').showModal();
      return;
    }

    if (del) {
      $('#del-product-id').value = del.dataset.id;
      const name = del.dataset.name || '';
      const lots = parseInt(del.dataset.lots || '0', 10);
      document.getElementById('del-msg').textContent = lots > 0
        ? `La suppression retirera aussi les ${lots} stock(s) li√©(s) √† ¬´ ${name} ¬ª.`
        : `Supprimer ¬´ ${name} ¬ª ?`;
      document.getElementById('dlg-delete').showModal();
      return;
    }
  });

  /* ====== Pas personnalis√©s via fl√®ches ‚Üë/‚Üì (sans bloquer la saisie libre) ====== */
  document.addEventListener('keydown', (e) => {
    const input = e.target.closest('input[type=number][data-step-custom]');
    if (!input) return;
    const step = parseFloat(input.dataset.stepCustom || '1');
    if (isNaN(step) || step <= 0) return;

    const cur = parseFloat(input.value || '0') || 0;
    if (e.key === 'ArrowUp') { e.preventDefault(); input.value = (cur + step).toString(); }
    if (e.key === 'ArrowDown') { e.preventDefault(); input.value = (cur - step).toString(); }
  });

</script>


{% endblock %}
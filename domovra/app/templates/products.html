{% extends "base.html" %}
{% block title %}Domovra ‚Äî Fiche produit{% endblock %}

{% block head %}{% endblock %}

{% block header_right %}
<span class="chip">üóÇÔ∏è Fiches produit : <b>{{ items|length }}</b></span>
{% endblock %}

{% block content %}
<div class="wrap" data-page="product">

  <!-- Ajouter un produit -->
  <div class="card">
    <div class="title">
      <h2>Ajouter un produit</h2>
      <span class="muted">‚Üí cr√©er une fiche produit compl√®te</span>
    </div>

    <!-- grille (conserve ta classe pour r√©utiliser ton CSS) -->
    <form id="create_form" method="post" action="{{ BASE }}product/add" class="add-product-form">

      <!-- Nom & Description -->
      <div class="field" style="grid-column:1 / -1">
        <div class="label">Nom du produit <span class="help" tabindex="0" data-tip="Nom court et explicite."></span>
        </div>
        <input name="name" id="create_name" type="text" required placeholder="ex. P√¢tes, Lait demi-√©cr√©m√©">
      </div>

      <div class="field" style="grid-column:1 / -1">
        <div class="label">Description <span class="help" tabindex="0" data-tip="ex. Brique UHT, 6√ó1 L, marque‚Ä¶"></span>
        </div>
        <textarea name="description" id="create_desc" rows="2" placeholder="ex. Brique UHT, 6√ó1 L, marque‚Ä¶"></textarea>
      </div>

      <!-- Ligne 1 -->
      <div class="field">
        <div class="label">Emplacement par d√©faut <span class="help" tabindex="0"
            data-tip="L√† o√π tu ranges habituellement ce produit."></span></div>
        <select name="default_location_id" id="create_default_location_id">
          <option value="">‚Äî Aucun (choisir √† l‚Äôajout en stock) ‚Äî</option>
          {% for loc in locations or [] %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="field">
        <div class="label">Unit√© par d√©faut</div>
        <select name="unit" id="create_unit">
          <optgroup label="Comptage">
            <option value="pi√®ce" selected>pi√®ce</option>
            <option value="tranche">tranche</option>
            <option value="paquet">paquet</option>
            <option value="bo√Æte">bo√Æte</option>
            <option value="bocal">bocal</option>
            <option value="bouteille">bouteille</option>
            <option value="sachet">sachet</option>
            <option value="lot">lot</option>
            <option value="barquette">barquette</option>
            <option value="rouleau">rouleau</option>
            <option value="dosette">dosette</option>
          </optgroup>
          <optgroup label="Poids">
            <option value="g">g</option>
            <option value="kg">kg</option>
          </optgroup>
          <optgroup label="Volume">
            <option value="ml">ml</option>
            <option value="L">L</option>
          </optgroup>
        </select>
      </div>

      <div class="field">
        <div class="label">Cat√©gorie de produits</div>
        <input name="category" id="create_category" placeholder="ex. Produits laitiers, Viande, Condiments‚Ä¶">
      </div>

      <!-- Ligne 2 -->
      <div class="field">
        <div class="label">Quantit√© minimum en stock <span class="help" tabindex="0"
            data-tip="Seuil d‚Äôalerte propre √† ce produit."></span></div>
        <div class="infield-qty">
          <input name="min_qty" id="create_min_qty" type="number" min="0" step="1" placeholder="ex. 1"
            value="{{ SETTINGS.low_stock_default }}">
          <span id="create_min_unit" class="suffix">pi√®ce</span>
        </div>
        <div class="hint muted" id="create_min_hint">Conseil : 1, 2, 3 pi√®ces‚Ä¶</div>
      </div>

      <div class="field">
        <div class="label">Alerte stock faible actif ?</div>
        <select name="low_stock_enabled" id="create_low_enabled">
          <option value="1" selected>Oui</option>
          <option value="0">Non</option>
        </select>
      </div>

      <div class="field">
        <div class="label">Produit parent</div>
        <select name="parent_id" id="create_parent">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for p in parents or [] %}
          <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Ligne 3 -->
      <div class="field">
        <div class="label">Type d‚Äô√©ch√©ance</div>
        <div class="segmented">
          <label><input type="radio" name="expiry_kind" value="DLC" checked><span>DLC</span></label>
          <label><input type="radio" name="expiry_kind" value="DDM"><span>DDM</span></label>
        </div>
      </div>

      <div class="field">
        <div class="label">P√©remption par d√©faut (jours)</div>
        <input name="shelf" id="create_shelf" type="number" min="1" placeholder="ex. 90">
      </div>

      <div class="field no-freeze-cell">
        <label class="checkbox-inline">
          <input type="checkbox" id="create_no_freeze" name="no_freeze" value="1">
          <span>Ne doit pas √™tre congel√©</span>
        </label>
      </div>

      <div class="field" id="create_freeze_group">
        <div class="label">P√©remption apr√®s cong√©lation (jours)</div>
        <input name="default_freeze_shelf_days" id="create_freeze_shelf" type="number" min="1" placeholder="ex. 180">
      </div>

      <!-- Bouton -->
      <div class="field btn-wide">
        <button class="secondary" type="submit">Ôºã Ajouter</button>
      </div>
    </form>
  </div>

  <!-- Outils -->
  <div class="card">
    <div class="title">
      <h2>Outils</h2><span class="muted">Recherche</span>
    </div>
    <div class="row tools-row" style="align-items:center">
      <input id="q" type="search" placeholder="Rechercher une fiche produit‚Ä¶" />
    </div>
  </div>

  <!-- === Liste (CARTES UNIQUEMENT) ===================================== -->


  <div class="card">
    <div class="title">
      <h2>Fiches produit</h2><span class="muted">Cartes</span>
    </div>

    <div id="cardsGrid" class="cards-grid">
      {% for it in items %}
      {% set threshold = it.min_qty if it.min_qty is not none else SETTINGS.low_stock_default %}
      {% set is_low = (it.qty_total < (it.min_qty if it.min_qty is not none else 0) and (it.min_qty is not none)) %}
        <article class="prod-card"
        data-name="{{ (it.name ~ ' ' ~ (it.category or '') ~ ' ' ~ (it.unit or '') ~ ' ' ~ (it.barcode or ''))|lower }}"
        data-barcode="{{ (it.barcode or '')|lower }}">
        <header class="pc-head">
          <div class="pc-title">
            <h3 class="pc-name">{{ it.name }}</h3>
            {% if it.category %}<span class="pill">{{ it.category }}</span>{% endif %}
            {% if is_low %}<span class="pill danger">üîª Faible stock</span>{% endif %}
          </div>
          <div class="pc-sub muted">
            {{ it.unit }} ‚Ä¢ DLC/DDM : {{ it.expiry_kind or 'DLC' }}
            {% if it.no_freeze %} ‚Ä¢ ‚ùÑÔ∏è interdit{% endif %}
          </div>
        </header>

        <div class="pc-body">
          <div class="stat"><span class="k">Stocks</span><span class="v">{{ it.lots_count }}</span></div>
          <div class="stat"><span class="k">Qt√© totale</span><span class="v">{{ '%.2f'|format(it.qty_total) }} {{
              it.unit|pluralize_fr(it.qty_total) }}</span></div>
          {% if it.min_qty is not none %}
          <div class="stat"><span class="k">Seuil min</span><span class="v">{{ it.min_qty }}</span></div>
          {% endif %}
          {% if it.default_location_id %}
          <div class="stat"><span class="k">üìç Emplacement</span><span class="v">
              {{ loc_map.get((it.default_location_id|string)) or '‚Äî' }}
            </span></div>
          {% endif %}
          <div class="stat"><span class="k">Conservation (par d√©faut)</span><span class="v">{{
              it.default_shelf_life_days }} j</span></div>
          {% if it.barcode %}<div class="stat"><span class="k">EAN</span><span class="v">{{ it.barcode }}</span></div>{%
          endif %}
          {% if it.description %}<div class="stat full"><span class="k">Description</span><span class="v">{{
              it.description }}</span></div>{% endif %}
        </div>

        <footer class="pc-actions">
          <button class="secondary js-view-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-category="{{ it.category or '' }}" data-unit="{{ it.unit or '' }}"
            data-expiry-kind="{{ it.expiry_kind or 'DLC' }}" data-no-freeze="{{ 1 if (it.no_freeze or 0)!=0 else 0 }}"
            data-shelf="{{ it.default_shelf_life_days or '' }}"
            data-default-location="{{ it.default_location_id or '' }}" data-barcode="{{ it.barcode or '' }}"
            data-min="{{ it.min_qty if it.min_qty is not none else '' }}" data-desc="{{ it.description or '' }}"
            data-lots="{{ it.lots_count|int }}" data-qty="{{ '%.2f'|format(it.qty_total) }}">
            üëÅÔ∏è Voir
          </button>

          <button class="secondary js-edit-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-desc="{{ it.description or '' }}" data-default-location="{{ it.default_location_id or '' }}"
            data-min="{{ it.min_qty if it.min_qty is not none else '' }}"
            data-low-enabled="{{ 1 if (it.low_stock_enabled is not none and it.low_stock_enabled!=0) else 0 }}"
            data-expiry-kind="{{ (it.expiry_kind or 'DLC') }}" data-shelf="{{ it.default_shelf_life_days or '' }}"
            data-freeze-shelf="{{ it.default_freeze_shelf_days or '' }}"
            data-no-freeze="{{ 1 if (it.no_freeze is not none and it.no_freeze!=0) else 0 }}"
            data-category="{{ it.category or '' }}" data-unit="{{ it.unit or 'pi√®ce' }}"
            data-parent="{{ it.parent_id or '' }}">
            ‚úèÔ∏è Modifier
          </button>

          <button class="secondary js-delete-open" data-id="{{ it.id }}" data-name="{{ it.name }}"
            data-lots="{{ it.lots_count|int }}">
            üóëÔ∏è Supprimer
          </button>
        </footer>
        </article>
        {% endfor %}
    </div>
  </div>

</div>

<!-- ===== Dialogs ======================================================= -->

<!-- Voir (fiche compl√®te, lecture seule) -->
<dialog id="dlg-view">
  <div style="display:grid;gap:14px;min-width:min(820px,96vw)">
    <div class="tabs compact">
      <button class="tab active" type="button">Aper√ßu du produit</button>
      <a class="tab" id="v-tab-in" href="#">Entr√©es du stock</a>
      <a class="tab" id="v-tab-journal" href="#">Journal du stock</a>
      <span style="margin-left:auto" class="muted">üõí üßæ</span>
    </div>

    <h2 id="v-name" style="text-align:center;margin:0">‚Äî</h2>

    <div class="kv">
      <div><b>Quantit√© en stock :</b> <span id="v-qty">‚Äî</span></div>
      <div><b>Valeur du stock :</b> <span class="muted">‚Äî (non suivi)</span></div>
      <div><b>Emplacement par d√©faut :</b> <span id="v-loc">‚Äî</span></div>
      <div><b>Dernier achat :</b> <span id="v-last-in">Jamais</span></div>
      <div><b>Derni√®re utilisation :</b> <span id="v-last-out">Jamais</span></div>
      <div><b>Dernier prix :</b> <span class="muted">‚Äî</span></div>
      <div><b>stock moyen :</b> <span class="muted">‚Äî</span></div>
      <div><b>Dur√©e moyenne de conservation :</b> <span id="v-avg-shelf">‚Äî</span></div>
      <div><b>Taux de p√©remption :</b> <span id="v-expired-rate">‚Äî</span></div>
    </div>

    <div>
      <h3 style="margin:8px 0 6px">Historique des prix</h3>
      <div class="muted" style="border:1px dashed var(--line);border-radius:10px;padding:12px">
        Suivi des prix non activ√© dans Domovra V1 (sera aliment√© via la page Stock).
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-view').close()">Fermer</button>
    </div>
  </div>
</dialog>


<!-- √âditer -->
<dialog id="dlg-edit">
  <form method="post" action="{{ BASE }}product/update" style="display:grid;gap:10px;min-width:min(680px,96vw)">
    <h3 style="margin:0">Modifier la fiche produit</h3>
    <input type="hidden" name="product_id" id="dlg-product-id">

    <div>
      <div class="label">Nom</div>
      <input type="text" name="name" id="dlg-name" required>
    </div>

    <div>
      <div class="label">Description</div>
      <textarea name="description" id="dlg-desc" rows="2"></textarea>
    </div>

    <div class="row" style="gap:10px">
      <div style="flex:1">
        <div class="label">Emplacement par d√©faut</div>
        <select name="default_location_id" id="dlg-default-location">
          <option value="">‚Äî Aucun ‚Äî</option>
          {% for loc in locations or [] %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div style="flex:1">
        <div class="label">Unit√©</div>
        <select name="unit" id="dlg-unit">
          <optgroup label="Comptage">
            <option value="pi√®ce">pi√®ce</option>
            <option value="tranche">tranche</option>
            <option value="paquet">paquet</option>
            <option value="bo√Æte">bo√Æte</option>
            <option value="bocal">bocal</option>
            <option value="bouteille">bouteille</option>
            <option value="sachet">sachet</option>
            <option value="lot">lot</option>
            <option value="barquette">barquette</option>
            <option value="rouleau">rouleau</option>
            <option value="dosette">dosette</option>
          </optgroup>
          <optgroup label="Poids">
            <option value="g">g</option>
            <option value="kg">kg</option>
          </optgroup>
          <optgroup label="Volume">
            <option value="ml">ml</option>
            <option value="L">L</option>
          </optgroup>
        </select>
      </div>

      <div style="flex:1">
        <div class="label">Quantit√© minimum en stock</div>
        <div class="infield-qty">
          <input name="min_qty" id="dlg-min" type="number" min="0" step="1" placeholder="ex. 1">
          <span class="suffix" id="dlg_min_unit">pi√®ce</span>
        </div>
      </div>
    </div>

    <div class="row" style="gap:10px">
      <div style="flex:1">
        <div class="label">Alerte stock faible actif ?</div>
        <select name="low_stock_enabled" id="dlg-low-enabled">
          <option value="1">Oui</option>
          <option value="0">Non</option>
        </select>
      </div>

      <div style="flex:1">
        <div class="label">Type d‚Äô√©ch√©ance</div>
        <div>
          <label style="margin-right:10px"><input type="radio" name="expiry_kind" id="dlg-exp-dlc" value="DLC">
            DLC</label>
          <label><input type="radio" name="expiry_kind" id="dlg-exp-ddm" value="DDM"> DDM</label>
        </div>
      </div>

      <div style="flex:1">
        <div class="label">P√©remption par d√©faut (jours)</div>
        <input type="number" name="shelf" id="dlg-shelf" min="1" placeholder="ex. 90">
      </div>
    </div>

    <div class="row" style="gap:10px">
      <div style="flex:1">
        <label class="label" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="dlg-no-freeze" name="no_freeze" value="1">
          Ne doit pas √™tre congel√©
        </label>
      </div>

      <div style="flex:1" id="dlg-freeze-group">
        <div class="label">P√©remption apr√®s cong√©lation (jours)</div>
        <input type="number" name="default_freeze_shelf_days" id="dlg-freeze-shelf" min="1" placeholder="ex. 180">
      </div>

      <div style="flex:1">
        <div class="label">Cat√©gorie</div>
        <input name="category" id="dlg-category" placeholder="ex. Produits laitiers">
      </div>
    </div>

    <div>
      <div class="label">Produit parent</div>
      <select name="parent_id" id="dlg-parent">
        <option value="">‚Äî Aucun ‚Äî</option>
        {% for p in parents or [] %}
        <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-edit').close()">Annuler</button>
      <button class="secondary">Enregistrer</button>
    </div>
  </form>
</dialog>

<!-- Supprimer -->
<dialog id="dlg-delete">
  <form method="post" action="{{ BASE }}product/delete" style="display:grid;gap:10px;min-width:min(420px,92vw)">
    <h3 style="margin:0">Supprimer le produit</h3>
    <input type="hidden" name="product_id" id="del-product-id">
    <div class="muted" id="del-msg">La suppression retirera aussi les stocks li√©s √† ce produit.</div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" onclick="document.getElementById('dlg-delete').close()">Annuler</button>
      <button class="secondary" style="background:var(--danger);border:0;color:#1d0c0c">Supprimer</button>
    </div>
  </form>
</dialog>

{% endblock %}

{% block scripts %}
<script type="application/json" id="loc-map-data">
  {{ loc_map | tojson }}
</script>

<script>
  /* ====== Recherche (cartes) ====== */
  const q = document.getElementById('q');
  const grid = document.getElementById('cardsGrid');
  const cards = Array.from(grid ? grid.children : []);
  function applyFilterCards(s) {
    const t = (s || '').toLowerCase().trim();
    let shown = 0;
    cards.forEach(card => {
      const txt = card.dataset.name || '';
      const ok = txt.includes(t);
      card.style.display = ok ? '' : 'none';
      if (ok) shown++;
    });
    const chip = document.querySelector('[data-page="product"] .chip b');
    if (chip) chip.textContent = String(t ? shown : cards.length);
  }
  if (q) q.addEventListener('input', e => applyFilterCards(e.target.value));

  /* ====== Voir (fiche compl√®te, lecture seule) ====== */

  // Map des emplacements fournie depuis le tag JSON
  let locMap = {};
  try {
    const raw = document.getElementById('loc-map-data')?.textContent || '{}';
    locMap = JSON.parse(raw);
  } catch { locMap = {}; }


  function humanizeDate(iso) {
    if (!iso) return 'Jamais';
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    const today = new Date();
    const diff = Math.floor((today - d) / 86400000);
    if (diff <= 0) return "aujourd‚Äôhui";
    if (diff === 1) return "hier";
    return `${iso}  ¬∑  il y a ${diff} jour${diff > 1 ? 's' : ''}`;
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.js-view-open');
    if (!btn) return;

    const name = btn.dataset.name || 'Fiche produit';
    const unit = btn.dataset.unit || '';
    const qty = btn.dataset.qty || '0';
    const lots = btn.dataset.lots || '0';
    const loc = locMap[btn.dataset.defaultLocation || ''] || '‚Äî';

    const lastIn = humanizeDate(btn.dataset.lastIn || '');
    const lastOut = humanizeDate(btn.dataset.lastOut || '');

    const avgShelf = btn.dataset.avgShelf && btn.dataset.avgShelf !== '0' ? `${btn.dataset.avgShelf} j` : '‚Äî';
    const expRate = btn.dataset.expiredRate && btn.dataset.expiredRate !== '0' ? `${btn.dataset.expiredRate}%` : '0 %';

    document.getElementById('v-name').textContent = name;
    document.getElementById('v-qty').textContent = `${qty} ${unit}${Number(qty) == 1 ? '' : 's'} (${lots} lot${Number(lots) == 1 ? '' : 's'})`;
    document.getElementById('v-loc').textContent = loc;
    document.getElementById('v-last-in').textContent = lastIn;
    document.getElementById('v-last-out').textContent = lastOut;
    document.getElementById('v-avg-shelf').textContent = avgShelf;
    document.getElementById('v-expired-rate').textContent = expRate;

    // liens des onglets
    const encoded = encodeURIComponent(name);
    const linkIn = document.getElementById('v-tab-in');
    const linkJ = document.getElementById('v-tab-journal');
    if (linkIn) linkIn.href = '{{ BASE }}lots?product=' + encoded;
    if (linkJ) linkJ.href = '{{ BASE }}journal';

    document.getElementById('dlg-view').showModal();
  });

  /* ====== √âdition : logique d‚Äôunit√© -> suffixe/step pour min ====== */
  const $ = s => document.querySelector(s);
  function applyDlgMinUnitLogic() {
    const unit = $('#dlg-unit')?.value || 'pi√®ce';
    const minInput = $('#dlg-min');
    const unitSuffix = $('#dlg_min_unit');
    if (!minInput || !unitSuffix) return;

    let step = 1, suffix = unit, placeholder = 'ex. 1';
    switch (unit) {
      case 'L': step = 1; suffix = 'L'; placeholder = 'ex. 1'; break;
      case 'ml': step = 50; suffix = 'ml'; placeholder = 'ex. 500'; break;
      case 'kg': step = 0.1; suffix = 'kg'; placeholder = 'ex. 0.5'; break;
      case 'g': step = 50; suffix = 'g'; placeholder = 'ex. 500'; break;
      default: step = 1; suffix = unit || 'pi√®ce'; placeholder = 'ex. 1';
    }
    minInput.step = String(step);
    minInput.placeholder = placeholder;
    unitSuffix.textContent = suffix;
  }
  function applyDlgFreezeVisibility() {
    const nf = $('#dlg-no-freeze');
    const grp = $('#dlg-freeze-group');
    if (!nf || !grp) return;
    grp.style.display = nf.checked ? 'none' : '';
  }

  document.addEventListener('click', function (e) {
    const edit = e.target.closest('.js-edit-open');
    const del = e.target.closest('.js-delete-open');
    if (edit) {
      $('#dlg-product-id').value = edit.dataset.id || '';
      $('#dlg-name').value = edit.dataset.name || '';
      $('#dlg-desc').value = edit.dataset.desc || '';
      setSelectValue($('#dlg-default-location'), edit.dataset.defaultLocation || '');
      setSelectValue($('#dlg-unit'), edit.dataset.unit || 'pi√®ce');
      setSelectValue($('#dlg-low-enabled'), (edit.dataset.lowEnabled === '0' ? '0' : '1'));
      setSelectValue($('#dlg-category'), edit.dataset.category || '');
      setSelectValue($('#dlg-parent'), edit.dataset.parent || '');
      $('#dlg-min').value = (edit.dataset.min || '');
      $('#dlg-shelf').value = (edit.dataset.shelf || '');
      $('#dlg-freeze-shelf').value = (edit.dataset.freezeShelf || '');
      const kind = (edit.dataset.expiryKind || 'DLC').toUpperCase();
      $('#dlg-exp-dlc').checked = (kind === 'DLC');
      $('#dlg-exp-ddm').checked = (kind === 'DDM');
      const nf = $('#dlg-no-freeze'); nf.checked = (edit.dataset.noFreeze === '1');
      applyDlgFreezeVisibility();
      applyDlgMinUnitLogic();
      $('#dlg-unit').addEventListener('change', applyDlgMinUnitLogic);
      nf.addEventListener('change', applyDlgFreezeVisibility);
      $('#dlg-edit').showModal();
      return;
    }
    if (del) {
      $('#del-product-id').value = del.dataset.id;
      const name = del.dataset.name || ''; const lots = parseInt(del.dataset.lots || '0', 10);
      document.getElementById('del-msg').textContent = lots > 0
        ? `La suppression retirera aussi les ${lots} stock(s) li√©(s) √† ¬´ ${name} ¬ª .`
        : `Supprimer ¬´ ${name} ¬ª ?`;
      document.getElementById('dlg-delete').showModal(); return;
    }
  });

  function setSelectValue(sel, val) {
    if (!sel) return;
    [...sel.querySelectorAll('option[data-temp="1"]')].forEach(o => o.remove());
    const opts = [...sel.options].map(o => o.value);
    if (opts.includes(val)) sel.value = val;
    else if (val) {
      const o = document.createElement('option');
      o.value = val; o.textContent = val + ' (autre)'; o.dataset.temp = '1';
      sel.insertBefore(o, sel.firstChild); sel.value = val;
    }
  }
</script>
{% endblock %}
{% extends "base.html" %}
{% block title %}Domovra — Accueil (En travaux){% endblock %}

{% block head %}

{% endblock %}

{% block content %}
<div class="wrap">

  <!-- ===================== Consommer un produit ===================== -->
  <div class="card consume-card" data-role="consume">
    <div class="title">
      <h2>Consommer un produit</h2><span class="muted">→ sélectionnez un produit</span>
    </div>

    <!-- Produit (datalist) -->
    <div class="field">
      <div class="label">Produit</div>
      <input id="consume-product-input" list="consume-products-dl" placeholder="Commencez à taper..."
        autocomplete="off">
      <datalist id="consume-products-dl">
        {% for p in products %}
        <option value="{{ p.name }}" data-id="{{ p.id }}" data-brand="{{ p.brand or '' }}"
          data-unit="{{ p.unit or '' }}">
          {{ p.name }}{% if p.brand %} — {{ p.brand }}{% endif %}{% if p.unit %} ({{ p.unit }}){% endif %}
        </option>
        {% endfor %}
      </datalist>
      <input type="hidden" id="consume-product-id">
    </div>

    <!-- Infos -->
    <div class="consume-infos grid-2">
      <div class="info">
        <div class="muted">FIFO (lot) / DLC</div>
        <div class="strong" id="consume-fifo">—</div>
      </div>
      <div class="info">
        <div class="muted">Emplacement</div>
        <div class="strong" id="consume-location">—</div>
      </div>
      <div class="info">
        <div class="muted">Quantité totale</div>
        <div class="strong"><span id="consume-total">—</span> <span id="consume-unit"></span></div>
      </div>
      <div class="info">
        <div class="muted">Marque</div>
        <div class="strong" id="consume-brand">—</div>
      </div>
    </div>

    <!-- Quantité -->
    <div class="field">
      <div class="label">Quantité à consommer</div>
      <div class="qty-controls">
        <input id="consume-qty" type="number" inputmode="numeric" step="1" min="0" placeholder="0">
        <div class="quick-btns">
          <button type="button" class="btn small ghost" data-qset="1">−1</button>
          <button type="button" class="btn small ghost" data-qset="2">−2</button>
          <button type="button" class="btn small ghost" data-qset="3">−3</button>
        </div>
      </div>
    </div>

    <!-- Lien debug JSON -->
    <div id="consume-debug" class="muted small" style="display:none; margin:.25rem 0 .5rem">
      🔎 <a id="consume-json-link" href="#" target="_blank" rel="noopener">Ouvrir la réponse JSON</a>
      <span id="consume-json-meta"></span>
    </div>

    <!-- Bouton -->
    <div class="field">
      <button type="button" class="btn primary" id="consume-validate" disabled>Valider la consommation</button>
      <div class="muted small">Consomme en FIFO (lot(s) à DLC la plus proche).</div>
    </div>
  </div>

  <!-- ===================== Script ===================== -->
  <script>
    (function () {
      const $input = document.getElementById('consume-product-input');
      const $hiddenId = document.getElementById('consume-product-id');
      const $dl = document.getElementById('consume-products-dl');

      const $fifo = document.getElementById('consume-fifo');
      const $loc = document.getElementById('consume-location');
      const $tot = document.getElementById('consume-total');
      const $unit = document.getElementById('consume-unit');
      const $brand = document.getElementById('consume-brand');

      const $qty = document.getElementById('consume-qty');
      const $btns = document.querySelectorAll('.quick-btns [data-qset]');
      const $validate = document.getElementById('consume-validate');

      const $debugRow = document.getElementById('consume-debug');
      const $jsonLink = document.getElementById('consume-json-link');
      const $jsonMeta = document.getElementById('consume-json-meta');

      let lastInfo = null;

      // ---------- Console helpers ----------
      function log(...args) { try { console.log('[consume]', ...args); } catch { } }
      function dbg(...args) { try { console.debug('[consume]', ...args); } catch { } }
      function warn(...args) { try { console.warn('[consume]', ...args); } catch { } }
      function err(...args) { try { console.error('[consume]', ...args); } catch { } }

      function normalize(s) {
        return (s || "").toString().trim().toLowerCase()
          .normalize('NFD').replace(/\p{Diacritic}/gu, '')
          .replace(/\s+/g, ' ');
      }

      const nameMap = (() => {
        const map = new Map();
        $dl.querySelectorAll('option').forEach(opt => {
          const key = normalize(opt.value);
          if (key && !map.has(key)) {
            map.set(key, {
              id: opt.getAttribute('data-id') ? parseInt(opt.getAttribute('data-id'), 10) : null,
              brand: opt.getAttribute('data-brand') || '',
              unit: opt.getAttribute('data-unit') || ''
            });
          }
        });
        return map;
      })();

      function findSelectedProduct() {
        const val = ($input.value || '').trim();
        if (!val) return null;
        if (window.CSS && CSS.escape) {
          const opt = $dl.querySelector(`option[value="${CSS.escape(val)}"]`);
          if (opt) {
            const id = opt.getAttribute('data-id');
            return id ? { id: parseInt(id, 10) } : null;
          }
        }
        const rec = nameMap.get(normalize(val));
        return rec && rec.id ? { id: rec.id } : null;
      }

      function makeIngressUrl(path, params) {
        const u = new URL(path.replace(/^\//, ''), window.location.href);
        if (params) for (const [k, v] of Object.entries(params)) u.searchParams.set(k, v);
        return u.toString();
      }

      async function fetchProductInfo(pid) {
        const url = makeIngressUrl('api/product-info', { product_id: String(pid) });
        dbg('GET', url);
        const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
        const txt = await r.text();
        dbg('Response', r.status, txt);
        let data = null; try { data = JSON.parse(txt); } catch { }
        if (!r.ok) return { error: 'http', status: r.status };
        return data ?? { error: 'parse' };
      }

      function updateDebugLink(pid) {
        if (!$debugRow || !$jsonLink) return;
        if (pid) {
          const url = makeIngressUrl('api/product-info', { product_id: String(pid) });
          $jsonLink.href = url;
          if ($jsonMeta) $jsonMeta.textContent = ` (product_id=${pid})`;
          $debugRow.style.display = '';
        } else {
          $jsonLink.removeAttribute('href');
          if ($jsonMeta) $jsonMeta.textContent = '';
          $debugRow.style.display = 'none';
        }
      }

      function currentQty() {
        const v = parseFloat(($qty.value || '').replace(',', '.'));
        return isFinite(v) && v > 0 ? v : 0;
      }

      function updateValidateState() {
        const pid = ($hiddenId.value || '').trim();
        const q = currentQty();
        const stock = lastInfo ? (typeof lastInfo.total_qty === 'number'
          ? lastInfo.total_qty : parseFloat(lastInfo.total_qty || '0') || 0) : 0;
        $validate.disabled = !(pid && q > 0 && stock > 0);
      }

      function fillInfos(payload) {
        if (!payload || payload.error) {
          lastInfo = null;
          const msg = payload?.error === 'http' ? `Erreur HTTP ${payload.status}`
            : payload?.error === 'parse' ? 'Réponse illisible' : 'Erreur réseau';
          warn('fillInfos error:', payload);
          $fifo.textContent = msg;
          $loc.textContent = '—';
          $tot.textContent = '—';
          $unit.textContent = '';
          $brand.textContent = '—';
          updateValidateState();
          return;
        }

        lastInfo = payload;
        dbg('fillInfos payload:', payload);

        const lotId = payload.fifo && payload.fifo.lot_id ? payload.fifo.lot_id : null;
        const dlc = payload.fifo && payload.fifo.best_before ? payload.fifo.best_before : null;
        $fifo.textContent = lotId ? ('#' + lotId + (dlc ? (' — ' + dlc) : '')) : 'Aucun lot dispo';

        $loc.textContent = (payload.fifo && payload.fifo.location) ? payload.fifo.location : '—';

        const t = (typeof payload.total_qty === 'number') ? payload.total_qty
          : (parseFloat(payload.total_qty || '0') || 0);
        $tot.textContent = t.toString();
        $unit.textContent = (payload.unit && String(payload.unit).trim()) || '';

        let brandFromApi = (payload.brand && String(payload.brand).trim()) || '';
        if (!brandFromApi) {
          const val = ($input.value || '').trim();
          const opt = Array.from($dl.options).find(o => (o.value || '').trim() === val);
          brandFromApi = (opt && opt.getAttribute('data-brand') || '').trim();
        }
        $brand.textContent = brandFromApi || '—';

        updateValidateState();
      }

      async function onProductChanged() {
        $hiddenId.value = '';
        fillInfos(null);
        const sel = findSelectedProduct();
        updateDebugLink(sel && sel.id ? sel.id : null);
        if (!sel || !sel.id) return;

        dbg('onProductChanged -> product_id', sel.id);
        $hiddenId.value = String(sel.id);
        const data = await fetchProductInfo(sel.id);
        fillInfos(data);
      }

      function onQuickBtn(e) {
        const val = parseInt(e.currentTarget.getAttribute('data-qset'), 10) || 0;
        $qty.value = val ? String(val) : '';
        $qty.dispatchEvent(new Event('input'));
      }

      // ---- API côté front ----
      async function postLotConsume(lotId, qty) {
        const url = new URL('lot/consume', window.location.href);
        const form = new URLSearchParams();
        form.set('lot_id', String(lotId));
        form.set('qty', String(qty));
        dbg('POST lot/consume', { lotId, qty, url: url.toString() });
        const r = await fetch(url.toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: form.toString()
        });
        dbg('POST lot/consume -> status', r.status);
        return r.ok;
      }

      async function logEvent(kind, payload) {
        const url = makeIngressUrl('api/log');
        try {
          dbg('POST api/log', { kind, payload, url });
          await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ kind, payload })
          });
        } catch (e) {
          warn('logEvent failed', e);
        }
      }

      async function consumeFIFO(pid, qty) {
        const info = (lastInfo && lastInfo.product_id === pid) ? lastInfo : await fetchProductInfo(pid);
        if (!info || info.error) throw new Error('info unavailable');
        if (!info.lots || info.lots.length === 0) throw new Error('no stock');

        const productName = ($input.value || '').trim();
        const unit = (info.unit || '').trim();

        let remaining = qty;
        let consumed = 0;
        const ops = [];

        console.groupCollapsed('[consume] FIFO run', { pid, qty });
        try {
          for (const l of info.lots) {
            if (remaining <= 1e-12) break;
            const lotQty = parseFloat(l.qty || '0') || 0;
            if (lotQty <= 0) continue;

            const take = Math.min(remaining, lotQty);
            dbg('lot step', { lot_id: l.lot_id, lotQty, take });

            const ok = await postLotConsume(l.lot_id, take);
            if (!ok) throw new Error('lot/consume failed');

            consumed += take;
            remaining = Math.max(0, remaining - take);
            ops.push({ lot_id: l.lot_id, take, before: lotQty, after: Math.max(0, lotQty - take), best_before: l.best_before, location: l.location });

            // LOG par lot
            logEvent('lot_consume', {
              lot_id: l.lot_id,
              product_id: pid,
              qty_delta: -take,
              before: lotQty,
              after: Math.max(0, lotQty - take),
              best_before: l.best_before,
              location: l.location,
              unit,
              name: productName
            });
          }
        } finally {
          console.groupEnd();
        }

        // LOG récap produit
        logEvent('product_consume', {
          product_id: pid,
          requested_qty: qty,
          consumed_qty: consumed,
          remaining_to_consume: remaining,
          operations_count: ops.length,
          unit,
          name: productName
        });

        return { remaining, consumed, ops };
      }

      // ---------- Bouton "Valider la consommation" ----------
      $validate.addEventListener('click', async () => {
        const pid = parseInt(($hiddenId.value || '0'), 10);
        const q = parseFloat((($qty.value || '').replace(',', '.')));
        if (!pid || !(q > 0)) return;

        try {
          const res = await consumeFIFO(pid, q);
          if (res.remaining > 0) {
            (window.showToast || ((m) => alert(m)))(`Partiel : consommé ${res.consumed}/${q}`, 'warn');
          } else {
            (window.showToast || ((m) => alert(m)))(`Consommé ${res.consumed}`, 'ok');
          }
          $qty.value = '';

          // refresh infos
          const info = await fetchProductInfo(pid);
          fillInfos(info);
        } catch (e) {
          err('consume click failed', e);
          (window.showToast || ((m) => alert(m)))('Consommation impossible', 'error');
        }
      });

      ['input', 'change', 'blur'].forEach(evt => $input.addEventListener(evt, onProductChanged));
      $btns.forEach(b => b.addEventListener('click', onQuickBtn));
      $qty.addEventListener('input', updateValidateState);
      $qty.addEventListener('change', updateValidateState);
    })();
  </script>

  <!-- À consommer (Top 8) -->
  <div class="card">
    <div class="title">
      <h2>À consommer (Top 8)</h2>
    </div>

    <!-- Desktop -->
    <div class="top8-table table-responsive">
      <table>
        <thead>
          <tr>
            <th>Produit</th>
            <th>Emp.</th>
            <th>Qté</th>
            <th>DLC</th>
            <th>État</th>
            <th style="text-align:right">Action</th>
          </tr>
        </thead>
        <tbody>
          {% if lots %}
          {% for it in lots %}
          {% if loop.index0 < 8 %} <tr>
            <td>{{ it.product }}</td>
            <td class="muted">{{ it.location }}</td>
            <td>{{ '%.2f'|format(it.qty)|trim('0')|trim('.') }} {{ it.unit|pluralize_fr(it.qty) }}</td>
            <td>{{ it.best_before or '—' }}</td>
            <td>
              {% if it.status == 'red' %}<span class="pill danger">Urgent</span>
              {% elif it.status == 'yellow' %}<span class="pill warn">Bientôt</span>
              {% else %}<span class="pill ok">OK</span>{% endif %}
            </td>
            <td style="text-align:right">
              <form method="post" action="{{ BASE }}lot/consume" class="row" style="justify-content:flex-end;gap:8px">
                <input type="hidden" name="lot_id" value="{{ it.id }}">
                <input type="number" name="qty" value="1" min="0.1" step="0.1" style="max-width:90px">
                <button class="secondary" style="flex:0 0 120px">Consommer</button>
              </form>
            </td>
            </tr>
            {% endif %}
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="6" class="muted">Aucun lot enregistré.</td>
            </tr>
            {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Mobile -->
    <div class="top8-cards">
      {% if lots %}
      {% for it in lots %}
      {% if loop.index0 < 8 %} <div class="lot-card">
        <div class="lot-main">
          <div class="lot-title">{{ it.product }}</div>
          <div class="lot-meta">
            <span>📍 {{ it.location }}</span>
            <span>⚖️ {{ '%.2f'|format(it.qty)|trim('0')|trim('.') }} {{ it.unit|pluralize_fr(it.qty) }}</span>
            <span>🗓️ {{ it.best_before or '—' }}</span>
            <span>
              {% if it.status == 'red' %}<span class="pill danger">Urgent</span>
              {% elif it.status == 'yellow' %}<span class="pill warn">Bientôt</span>
              {% else %}<span class="pill ok">OK</span>{% endif %}
            </span>
          </div>
        </div>
        <form method="post" action="{{ BASE }}lot/consume" class="lot-action">
          <input type="hidden" name="lot_id" value="{{ it.id }}">
          <input type="number" name="qty" value="1" min="0.1" step="0.1">
          <button class="secondary">Consommer</button>
        </form>
    </div>
    {% endif %}
    {% endfor %}
    {% else %}
    <div class="muted">Aucun lot enregistré.</div>
    {% endif %}
  </div>
</div>

</div>

<!-- Produits en faible stock (Top 8) -->
<div class="card">
  <div class="title">
    <h2>Produits en faible stock (Top 8)</h2>
  </div>

  <div class="top8-table table-responsive">
    <table>
      <thead>
        <tr>
          <th>Produit</th>
          <th>Stock total</th>
          <th>Seuil min</th>
          <th>Manque</th>
        </tr>
      </thead>
      <tbody>
        {% if low_products and low_products|length > 0 %}
        {% for p in low_products %}
        {% if loop.index0 < 8 %} {% set q=(p.qty_total if p.qty_total is defined else 0) | float %} {% set
          minq=(p.min_qty if p.min_qty is defined else 0) | float %} {% set manque=(minq - q) if minq> q else 0 %}
          <tr>
            <td>{{ p.name }}</td>
            <td>
              {% if q == 0 %}
              0 {{ p.unit|pluralize_fr(0) }}
              {% else %}
              {{ ('%.2f' % q) | trim('0') | trim('.') }} {{ p.unit|pluralize_fr(q) }}
              {% endif %}
            </td>
            <td>{{ (minq|int if minq == minq|int else minq) }}</td>
            <td>
              {% if manque > 0 %}
              {{ manque|int }} {{ p.unit|pluralize_fr(manque) }}
              {% else %}0{% endif %}
            </td>
          </tr>
          {% endif %}
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="4" class="muted">Aucun produit en faible stock.</td>
          </tr>
          {% endif %}
      </tbody>
    </table>
  </div>

  <div class="top8-cards">
    {% if low_products and low_products|length > 0 %}
    {% for p in low_products %}
    {% if loop.index0 < 8 %} {% set q=(p.qty_total if p.qty_total is defined else 0) | float %} {% set minq=(p.min_qty
      if p.min_qty is defined else 0) | float %} {% set manque=(minq - q) if minq> q else 0 %}
      <div class="lot-card">
        <div class="lot-main">
          <div class="lot-title">{{ p.name }}</div>
          <div class="lot-meta">
            <span>⚖️ {% if q == 0 %}0 {{ p.unit|pluralize_fr(0) }}{% else %}{{ ('%.2f' % q) | trim('0') | trim('.') }}
              {{ p.unit|pluralize_fr(q) }}{% endif %}</span>
            <span>🎯 Seuil : {{ (minq|int if minq == minq|int else minq) }}</span>
            <span>Manque : {% if manque > 0 %}{{ manque|int }} {{ p.unit|pluralize_fr(manque) }}{% else %}0{% endif
              %}</span>
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
      {% else %}
      <div class="muted">Aucun produit en faible stock.</div>
      {% endif %}
  </div>
</div>

</div>
{% endblock %}
{% extends "base.html" %}
{% block title %}Domovra ‚Äî Accueil{% endblock %}

{% block head %}

{% endblock %}

{% block content %}
<div class="wrap">

  <!-- Ajout express -->
  <div class="card">
    <div class="title">
      <h2>Ajout express</h2><span class="muted">‚Üí produit existant ‚Üí ajout au stock</span>
    </div>
    <form method="post" action="{{ BASE }}lot/add" class="row form-grid">
      <div class="field">
        <div class="label">Produit</div>
        <select name="product_id" required>
          <option value="">Produit‚Ä¶</option>
          {% for p in products %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="field">
        <div class="label">Emplacement</div>
        <select name="location_id" required>
          <option value="">Emplacement‚Ä¶</option>
          {% for l in locations %}<option value="{{ l.id }}">{{ l.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="field">
        <div class="label">Quantit√©</div>
        <input type="number" name="qty" value="1" min="0.1" step="0.1">
      </div>
      <div class="field">
        <div class="label">√Ä consommer avant</div>
        <input type="date" name="best_before">
      </div>
      <button class="secondary btn-add-stock">Ôºã Ajouter au stock</button>
    </form>
    <div class="row" style="margin-top:8px">
      <a class="chip" href="{{ BASE }}products">+ Nouveau produit</a>
      <a class="chip" href="{{ BASE }}locations">+ Nouvel emplacement</a>
    </div>
  </div>

  <!-- ===================== Carte : Consommer un produit (lecture seule) ===================== -->
  <div class="card consume-card" data-role="consume">
    <div class="title">
      <h2>Consommer un produit</h2><span class="muted">‚Üí s√©lectionnez un produit</span>
    </div>

    <!-- Ligne 1 : Produit (datalist) -->
    <div class="field">
      <div class="label">Produit</div>
      <input id="consume-product-input" list="consume-products-dl" placeholder="Commencez √† taper..."
        autocomplete="off">
      <datalist id="consume-products-dl">
        {% for p in products %}
        <option value="{{ p.name }}" data-id="{{ p.id }}" data-brand="{{ p.brand or '' }}"
          data-unit="{{ p.unit or '' }}">{{ p.name }}{% if p.brand %} ‚Äî {{ p.brand }}{% endif %}{% if p.unit %} ({{
          p.unit }}){% endif %}</option>
        {% endfor %}
      </datalist>
      <input type="hidden" id="consume-product-id">
    </div>

    <!-- Ligne 2 : Infos FIFO + totaux -->
    <div class="consume-infos grid-2">
      <div class="info">
        <div class="muted">FIFO (lot) / DLC</div>
        <div class="strong" id="consume-fifo">‚Äî</div>
      </div>
      <div class="info">
        <div class="muted">Emplacement</div>
        <div class="strong" id="consume-location">‚Äî</div>
      </div>
      <div class="info">
        <div class="muted">Quantit√© totale</div>
        <div class="strong"><span id="consume-total">‚Äî</span> <span id="consume-unit"></span></div>
      </div>
      <div class="info">
        <div class="muted">Marque</div>
        <div class="strong" id="consume-brand">‚Äî</div>
      </div>
    </div>

    <!-- Ligne 3 : quantit√© + boutons rapides -->
    <div class="field">
      <div class="label">Quantit√© √† consommer</div>
      <div class="qty-controls">
        <input id="consume-qty" type="number" inputmode="numeric" step="1" min="0" placeholder="0">
        <div class="quick-btns">
          <button type="button" class="btn small ghost" data-qset="1">‚àí1</button>
          <button type="button" class="btn small ghost" data-qset="2">‚àí2</button>
          <button type="button" class="btn small ghost" data-qset="3">‚àí3</button>
        </div>
      </div>
    </div>

    <!-- Ligne 4 : bouton (d√©sactiv√© √† cette √©tape) -->
    <div class="field">
      <button type="button" class="btn primary" id="consume-validate" disabled>Valider la consommation</button>
      <div class="muted small">La validation sera activ√©e √† l‚Äô√©tape 3.</div>
    </div>
  </div>

  <!-- ===================== Script (lecture seule) ===================== -->
  <script>
    (function () {
      const BASE = "{{ BASE }}";
      const $input = document.getElementById('consume-product-input');
      const $hiddenId = document.getElementById('consume-product-id');
      const $dl = document.getElementById('consume-products-dl');

      const $fifo = document.getElementById('consume-fifo');
      const $loc = document.getElementById('consume-location');
      const $tot = document.getElementById('consume-total');
      const $unit = document.getElementById('consume-unit');
      const $brand = document.getElementById('consume-brand');

      const $qty = document.getElementById('consume-qty');
      const $btns = document.querySelectorAll('.quick-btns [data-qset]');
      const $validate = document.getElementById('consume-validate');

      function resolveSelectedProductId() {
        const val = ($input.value || '').trim();
        if (!val) return null;
        for (const opt of $dl.querySelectorAll('option')) {
          if ((opt.value || '').trim() === val) {
            const id = opt.getAttribute('data-id');
            return id ? parseInt(id, 10) : null;
          }
        }
        return null;
      }

      async function fetchProductInfo(pid) {
        try {
          const r = await fetch(`${BASE}api/product-info?product_id=${encodeURIComponent(pid)}`, { headers: { 'Accept': 'application/json' } });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return await r.json();
        } catch {
          return { error: 'fetch' };
        }
      }

      function fillInfos(payload) {
        if (!payload || payload.error) {
          $fifo.textContent = '‚Äî';
          $loc.textContent = '‚Äî';
          $tot.textContent = '‚Äî';
          $unit.textContent = '';
          $brand.textContent = '‚Äî';
          $validate.disabled = true;
          return;
        }
        const lotId = payload?.fifo?.lot_id || null;
        const dlc = payload?.fifo?.best_before || null;
        $fifo.textContent = lotId ? `#${lotId}${dlc ? ' ‚Äî ' + dlc : ''}` : 'Aucun lot dispo';
        $loc.textContent = payload?.fifo?.location || '‚Äî';
        const t = typeof payload.total_qty === 'number' ? payload.total_qty : parseFloat(payload.total_qty || '0') || 0;
        $tot.textContent = t.toString();
        $unit.textContent = payload?.unit || '';
        $brand.textContent = payload?.brand || '‚Äî';
        $validate.disabled = !(payload && t > 0);
      }

      async function onProductChanged() {
        const pid = resolveSelectedProductId();
        $hiddenId.value = pid || '';
        fillInfos(null); // reset
        if (!pid) return;
        const data = await fetchProductInfo(pid);
        fillInfos(data);
      }

      function onQuickBtn(e) {
        const val = parseInt(e.currentTarget.getAttribute('data-qset'), 10) || 0;
        $qty.value = val ? String(val) : '';
        $qty.dispatchEvent(new Event('input'));
      }

      $input.addEventListener('change', onProductChanged);
      $input.addEventListener('input', onProductChanged);
      $btns.forEach(b => b.addEventListener('click', onQuickBtn));
      // $validate ‚Üí branch√© en √©tape 3 (POST /consume)
    })();
  </script>


  <!-- √Ä consommer (Top 8) -->
  <div class="card">
    <div class="title">
      <h2>√Ä consommer (Top 8)</h2>
    </div>

    <!-- Desktop -->
    <div class="top8-table table-responsive">
      <table>
        <thead>
          <tr>
            <th>Produit</th>
            <th>Emp.</th>
            <th>Qt√©</th>
            <th>DLC</th>
            <th>√âtat</th>
            <th style="text-align:right">Action</th>
          </tr>
        </thead>
        <tbody>
          {% if lots %}
          {% for it in lots %}
          {% if loop.index0 < 8 %} <tr>
            <td>{{ it.product }}</td>
            <td class="muted">{{ it.location }}</td>
            <td>{{ '%.2f'|format(it.qty)|trim('0')|trim('.') }} {{ it.unit|pluralize_fr(it.qty) }}</td>
            <td>{{ it.best_before or '‚Äî' }}</td>
            <td>
              {% if it.status == 'red' %}<span class="pill danger">Urgent</span>
              {% elif it.status == 'yellow' %}<span class="pill warn">Bient√¥t</span>
              {% else %}<span class="pill ok">OK</span>{% endif %}
            </td>
            <td style="text-align:right">
              <form method="post" action="{{ BASE }}lot/consume" class="row" style="justify-content:flex-end;gap:8px">
                <input type="hidden" name="lot_id" value="{{ it.id }}">
                <input type="number" name="qty" value="1" min="0.1" step="0.1" style="max-width:90px">
                <button class="secondary" style="flex:0 0 120px">Consommer</button>
              </form>
            </td>
            </tr>
            {% endif %}
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="6" class="muted">Aucun lot enregistr√©.</td>
            </tr>
            {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Mobile -->
    <div class="top8-cards">
      {% if lots %}
      {% for it in lots %}
      {% if loop.index0 < 8 %} <div class="lot-card">
        <div class="lot-main">
          <div class="lot-title">{{ it.product }}</div>
          <div class="lot-meta">
            <span>üìç {{ it.location }}</span>
            <span>‚öñÔ∏è {{ '%.2f'|format(it.qty)|trim('0')|trim('.') }} {{ it.unit|pluralize_fr(it.qty) }}</span>
            <span>üóìÔ∏è {{ it.best_before or '‚Äî' }}</span>
            <span>
              {% if it.status == 'red' %}<span class="pill danger">Urgent</span>
              {% elif it.status == 'yellow' %}<span class="pill warn">Bient√¥t</span>
              {% else %}<span class="pill ok">OK</span>{% endif %}
            </span>
          </div>
        </div>
        <form method="post" action="{{ BASE }}lot/consume" class="lot-action">
          <input type="hidden" name="lot_id" value="{{ it.id }}">
          <input type="number" name="qty" value="1" min="0.1" step="0.1">
          <button class="secondary">Consommer</button>
        </form>
    </div>
    {% endif %}
    {% endfor %}
    {% else %}
    <div class="muted">Aucun lot enregistr√©.</div>
    {% endif %}
  </div>
</div>

<!-- Produits en faible stock (Top 8) -->
<div class="card">
  <div class="title">
    <h2>Produits en faible stock (Top 8)</h2>
  </div>

  <!-- Desktop -->
  <div class="top8-table table-responsive">
    <table>
      <thead>
        <tr>
          <th>Produit</th>
          <th>Stock total</th>
          <th>Seuil min</th>
          <th>Manque</th>
        </tr>
      </thead>
      <tbody>
        {% if low_products and low_products|length > 0 %}
        {% for p in low_products %}
        {% if loop.index0 < 8 %} {% set q=(p.qty_total if p.qty_total is defined else 0) | float %} {% set
          minq=(p.min_qty if p.min_qty is defined else 0) | float %} {% set manque=(minq - q) if minq> q else 0 %}
          <tr>
            <td>{{ p.name }}</td>
            <td>
              {% if q == 0 %}
              0 {{ p.unit|pluralize_fr(0) }}
              {% else %}
              {{ ('%.2f' % q) | trim('0') | trim('.') }} {{ p.unit|pluralize_fr(q) }}
              {% endif %}
            </td>
            <td>{{ (minq|int if minq == minq|int else minq) }}</td>
            <td>
              {% if manque > 0 %}
              {{ manque|int }} {{ p.unit|pluralize_fr(manque) }}
              {% else %}0{% endif %}
            </td>
          </tr>
          {% endif %}
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="4" class="muted">Aucun produit en faible stock.</td>
          </tr>
          {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Mobile -->
  <div class="top8-cards">
    {% if low_products and low_products|length > 0 %}
    {% for p in low_products %}
    {% if loop.index0 < 8 %} {% set q=(p.qty_total if p.qty_total is defined else 0) | float %} {% set minq=(p.min_qty
      if p.min_qty is defined else 0) | float %} {% set manque=(minq - q) if minq> q else 0 %}
      <div class="lot-card">
        <div class="lot-main">
          <div class="lot-title">{{ p.name }}</div>
          <div class="lot-meta">
            <span>‚öñÔ∏è {% if q == 0 %}0 {{ p.unit|pluralize_fr(0) }}{% else %}{{ ('%.2f' % q) | trim('0') | trim('.') }}
              {{ p.unit|pluralize_fr(q) }}{% endif %}</span>
            <span>üéØ Seuil : {{ (minq|int if minq == minq|int else minq) }}</span>
            <span>Manque : {% if manque > 0 %}{{ manque|int }} {{ p.unit|pluralize_fr(manque) }}{% else %}0{% endif
              %}</span>
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
      {% else %}
      <div class="muted">Aucun produit en faible stock.</div>
      {% endif %}
  </div>
</div>

</div>
{% endblock %}